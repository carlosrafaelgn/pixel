'use strict';var __awaiter=this&&this.__awaiter||function(a,b,c,e){function d(f){return f instanceof c?f:new c(function(g){g(f)})}return new (c||(c=Promise))(function(f,g){function h(m){try{k(e.next(m))}catch(p){g(p)}}function l(m){try{k(e["throw"](m))}catch(p){g(p)}}function k(m){m.done?f(m.value):d(m.value).then(h,l)}k((e=e.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function c(k){return function(m){return e([k,m])}}function e(k){if(f)throw new TypeError("Generator is already executing.");
for(;d;)try{if(f=1,g&&(h=k[0]&2?g["return"]:k[0]?g["throw"]||((h=g["return"])&&h.call(g),0):g.next)&&!(h=h.call(g,k[1])).done)return h;if(g=0,h)k=[k[0]&2,h.value];switch(k[0]){case 0:case 1:h=k;break;case 4:return d.label++,{value:k[1],done:!1};case 5:d.label++;g=k[1];k=[0];continue;case 7:k=d.ops.pop();d.trys.pop();continue;default:if(!(h=d.trys,h=0<h.length&&h[h.length-1])&&(6===k[0]||2===k[0])){d=0;continue}if(3===k[0]&&(!h||k[1]>h[0]&&k[1]<h[3]))d.label=k[1];else if(6===k[0]&&d.label<h[1])d.label=
h[1],h=k;else if(h&&d.label<h[2])d.label=h[2],d.ops.push(k);else{h[2]&&d.ops.pop();d.trys.pop();continue}}k=b.call(a,d)}catch(m){k=[6,m],g=0}finally{f=h=0}if(k[0]&5)throw k[1];return{value:k[0]?k[1]:void 0,done:!0}}var d={label:0,sent:function(){if(h[0]&1)throw h[1];return h[1]},trys:[],ops:[]},f,g,h,l;return l={next:c(0),"throw":c(1),"return":c(2)},"function"===typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l},__extends=this&&this.__extends||function(){var a=function(b,c){a=Object.setPrototypeOf||
{__proto__:[]}instanceof Array&&function(e,d){e.__proto__=d}||function(e,d){for(var f in d)Object.prototype.hasOwnProperty.call(d,f)&&(e[f]=d[f])};return a(b,c)};return function(b,c){function e(){this.constructor=b}a(b,c);b.prototype=null===c?Object.create(c):(e.prototype=c.prototype,new e)}}(),androidWrapper="androidWrapper"in window?window.androidWrapper:null,Strings=function(){function a(){}a.init=function(){var b=androidWrapper?androidWrapper.getBrowserLanguage():navigator.userLanguage||navigator.language;
b&&0===b.toLowerCase().indexOf("pt")&&(document.documentElement.setAttribute("lang","pt-br"),a.DecimalSeparator=",",a.OppositeDecimalSeparator=".",a.YouWillLoseYourLevel="Voc\u00ea vai perder sua fase! Continuar?",a.TooManyObjects="H\u00e1 muitos objetos na fase ",a.TooManyBalls="H\u00e1 muitas bolas na fase ",a.TooManyPolygons="H\u00e1 muitos pol\u00edgonos na fase! Por favor, tente deixar a contagem de pol\u00edgonos abaixo de ",a.TooManyPoints="H\u00e1 muitos pontos na fase! Por favor, tente deixar a contagem de pontos abaixo de ",
a.InvalidImage="Imagem inv\u00e1lida! Por favor, escolha uma imagem PNG ou JPG ",a.EmptyImage="A imagem estava vazia ",a.ErrorLoadingImage="Desculpe! Algo deu errado ao carregar a imagem ",a.ErrorReadingImage="Desculpe! Algo deu errado ao ler a imagem ",a.ClearEntireLevel="Limpar a fase toda?",a.SaveLevel="Salvar Fase",a.NameCannotContain="Desculpe! O nome n\u00e3o pode conter os caracteres",a.SomethingWentWrong="Desculpe! Algo deu errado ",a.Success="Sucesso!",a.LevelSaved="Fase salva! ",a.Pause=
"Pausa",a.Fullscreen="Tela Cheia",a.ControlMode="Modo de Controle",a.Restart="Reiniciar",a.InvalidLevel="Fase inv\u00e1lida! Por favor, escolha um arquivo JSON ",a.EmptyLevel="A fase estava vazia ",a.ErrorLoadingLevel="Desculpe! Algo deu errado ao carregar a fase ",a.LevelImported="Fase importada! ",a.ErrorReadingLevel="Desculpe! Algo deu errado ao ler a fase ",a.Edit="Editar",a.Delete="Excluir",a.DeleteLevel="Excluir a fase ",a.Cancel="Cancelar",a.Clear="Limpar",a.Close="Fechar",a.Exit="Sair",a.Play=
"Jogar",a.Install="Instalar!",a.LevelSpace="Fase ",a.Level="Fase",a.LevelName="Nome da Fase",a.About="Sobre",a.About1="<p>Meu filho ainda gosta de jogos de labirinto hoje em dia (Setembro de 2020). Ent\u00e3o... Como eu precisava colocar WebAssembly",a.About2=" e WebGL2",a.About3=" em pr\u00e1tica",a.About4=", apesar de WebAssembly n\u00e3o ser suportado por seu navegador",a.About5=", decidi continuar o jogo que eu criei para ele em 2019! Pepinos devem ser coletados em alguns n\u00edveis porque ele adora um certo pepino de um desenho famoso! A prop\u00f3sito, ele criou a Fase 1 sozinho ",
a.About6='<p>Voc\u00ea tamb\u00e9m pode <a href="https://play.google.com/store/apps/details?id=br.com.carlosrafaelgn.pixel" target="_blank">instalar uma vers\u00e3o para Android</a> (apenas para manter a tela ligada mesmo sem que ela seja tocada).</p>',a.About7='<p>Informa\u00e7\u00f5es sobre o c\u00f3digo-fonte do jogo, bibliotecas e licen\u00e7a podem ser encontradas no <a href="https://github.com/carlosrafaelgn/pixel" target="_blank">GitHub do projeto</a>.</p>',a.LevelDeleted="Fase exclu\u00edda! ",
a.LevelDownloaded="Download da fase conclu\u00eddo! ",a.TryToDownloadAgain="Por favor, tente realizar o download da fase novamente, depois de conceder permiss\u00e3o.",a.DownloadFailedFileExists="Desculpe! N\u00e3o foi poss\u00edvel realizar o download da fase porque j\u00e1 existe um arquivo com o mesmo nome na pasta Download ",a.LevelImageDownloaded="Download da imagem conclu\u00eddo! ",a.TryToDownloadLevelImageAgain="Por favor, tente realizar o download da imagem novamente, depois de conceder permiss\u00e3o.",
a.LevelImageDownloadFailedFileExists="Desculpe! N\u00e3o foi poss\u00edvel realizar o download da imagem porque j\u00e1 existe um arquivo com o mesmo nome na pasta Download ",a.NewRecord="Novo Recorde!",a.Time="Tempo",a.Name="Nome",a.NoName="[Sem Nome]",a.LandscapeWarning="O jogo funciona melhor no modo paisagem :)")};a.DecimalSeparator=".";a.OppositeDecimalSeparator=",";a.YouWillLoseYourLevel="You will lose your level! Continue?";a.TooManyObjects="There are too many objects in the level ";a.TooManyBalls=
"There are too many balls in the level ";a.TooManyPolygons="There are too many polygons in the level! Please, try to keep the polygon count below ";a.TooManyPoints="There are too many points in the level! Please, try to keep the points count below ";a.InvalidImage="Invalid image! Please, select a PNG or a JPG image ";a.EmptyImage="The image was empty ";a.ErrorLoadingImage="Sorry! Something went wrong while loading the image ";a.ErrorReadingImage="Sorry! Something went wrong while reading the image ";
a.ClearEntireLevel="Clear the entire level?";a.SaveLevel="Save Level";a.NameCannotContain="Sorry! The name cannot contain the characters";a.SomethingWentWrong="Sorry! Something went wrong ";a.Success="Success!";a.LevelSaved="Level saved! ";a.Pause="Pause";a.Fullscreen="Fullscreen";a.ControlMode="Control Mode";a.Restart="Restart";a.InvalidLevel="Invalid level! Please, select a JSON file ";a.EmptyLevel="The level was empty ";a.ErrorLoadingLevel="Sorry! Something went wrong while loading the level ";
a.LevelImported="Level imported! ";a.ErrorReadingLevel="Sorry! Something went wrong while reading the level ";a.Menu="Menu";a.Edit="Edit";a.Delete="Delete";a.DeleteLevel="Delete the level ";a.OK="OK";a.Cancel="Cancel";a.Clear="Clear";a.Close="Close";a.Exit="Exit";a.Play="Play";a.Install="Install!";a.Oops="Oops\u2026";a.Download="Download";a.LevelSpace="Level ";a.Level="Level";a.LevelName="Level Name";a.About="About";a.About1="<p>My son is still into maze games nowadays (September 2020). So... As I needed to put WebAssembly";
a.About2=" and WebGL2";a.About3=" into practice";a.About4=", even though WebAssembly is not currently supported by your browser";a.About5=", I decided to continue the game I created for him in 2019! Cucumbers must be collected in some levels because he enjoys a certain cucumber from a famous cartoon! By the way, he created Level 1 on his own ";a.About6='<p>You can also <a href="https://play.google.com/store/apps/details?id=br.com.carlosrafaelgn.pixel" target="_blank">install an Android wrapper</a> (just to keep the screen on even without touching it).</p>';
a.About7='<p>All the information about the game\'s source code, libraries and license can be found on the <a href="https://github.com/carlosrafaelgn/pixel" target="_blank">project\'s GitHub</a>.</p>';a.LevelDeleted="Level deleted! ";a.LevelDownloaded="Level downloaded! ";a.TryToDownloadAgain="Please, try to download the level again, after granting the requested permission.";a.DownloadFailedFileExists="Sorry! The level could not be downloaded because there is another file with the same name in the Download folder ";
a.LevelImageDownloaded="Image downloaded! ";a.TryToDownloadLevelImageAgain="Please, try to download the image again, after granting the requested permission.";a.LevelImageDownloadFailedFileExists="Sorry! The image could not be downloaded because there is another file with the same name in the Download folder ";a.NewRecord="New Record!";a.Time="Time";a.Name="Name";a.NoName="[No Name]";a.LandscapeWarning="The game works better in landscape mode :)";return a}(),version="20210105",isPWA=0<=window.location.href.indexOf("pwa"),
isIOSOrSafari=function(){if(0>=navigator.userAgent.indexOf("Chrome")&&0<=navigator.userAgent.indexOf("Safari")||0<=navigator.userAgent.indexOf("Mac")&&"ontouchend"in document)return!0;switch(navigator.platform){case "iPad Simulator":case "iPhone Simulator":case "iPod Simulator":case "iPad":case "iPhone":case "iPod":return!0}return!1}(),baseWidth=420,minHeight=baseWidth>>1,maxHeight=baseWidth<<1,pixelRatio=window.devicePixelRatio||1,thumbnailWidth=baseWidth>>2,thumbnailHeight=56,iconSize=12,iconRadius=
iconSize>>1,borderWidth=1,buttonHeight=iconSize<<1,buttonMargin=iconSize>>1,buttonLargeMargin=buttonHeight,buttonPadding=buttonHeight-iconSize>>1,blinkLastCounter=7,blinkSingleDurationMS=75,blinkTotalDurationMS=(blinkLastCounter+1)*blinkSingleDurationMS,scrollThumbWidth=32,scrollThumbHeight=48,toolbarAvailableHeight=buttonHeight,toolbarTotalHeight=toolbarAvailableHeight+borderWidth,rainbowColors=[4294901760,4294919168,4294936576,4294953984,4294967040,4291624704,4287168256,4282711808,4278255360,4278255428,
4278255496,4278255564,4278255615,4278242559,4278225151,4278207743,4278190335,4282646783,4287103231,4291559679,4294902015,4294901964,4294901896,4294901828],colors=[4294919168,4287102976,4278255360,4278224896,4278251263,4278220680,4278225151,4278203272,4278190335,4278190216,4294902015,4287103112,4294967295,4280427042,4294967295],colorsCss="#04f #008 #0f0 #080 #fe0 #870 #f80 #830 #f00 #800 #f0f #808 #fff #222 #fff".split(" "),BlobDownloader=function(){function a(){}a.freeURL=function(){a.blobURL&&(URL.revokeObjectURL(a.blobURL),
a.blobURL=null)};a.download=function(b,c,e){void 0===e&&(e=null);if(!a.supported||!b||!c)return!1;a.freeURL();if("string"===typeof b){if(!e)return!1;b=new Blob([b],{type:e})}if(a.saveAs)try{return a.saveAs.call(window.navigator,b,c),!0}catch(f){}e=document.createElement("a");a.blobURL=URL.createObjectURL(b);e.href=a.blobURL;e.download=c;if(document.createEvent&&("MouseEvent"in window||"MouseEvents"in window))try{var d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,window,0,0,0,
0,0,!1,!1,!1,!1,0,null);e.dispatchEvent(d);return!0}catch(f){}e.click();return!0};a.saveAs=window.saveAs||window.webkitSaveAs||window.mozSaveAs||window.msSaveAs||window.navigator.saveBlob||window.navigator.webkitSaveBlob||window.navigator.mozSaveBlob||window.navigator.msSaveBlob;a.supported=!!androidWrapper||"Blob"in window&&"URL"in window&&"createObjectURL"in window.URL&&"revokeObjectURL"in window.URL;a.blobURL=null;return a}(),Point=function(){function a(){}a.revive=function(b){var c=new a;c.x=
parseInt(b.x);c.y=parseInt(b.y);if(isNaN(c.x)||isNaN(c.y))throw Error("Invalid point coordinates");return c};return a}(),Polygon=function(){function a(){}a.revive=function(b){var c=new a;c.points=[];if(b.points&&b.points.length)for(var e=b.points.length-1;0<=e;e--)c.points[e]=Point.revive(b.points[e]);if(2>c.points.length)throw Error("Polygon has fewer than two points");return c};return a}();
function removeSemiAlpha(a,b){var c=parseInt(a.width.toString());a=parseInt(a.height.toString());c=b.getImageData(0,0,c,a);a=c.data;for(var e=a.length-4;0<=e;e-=4)255!==a[e+3]&&(a[e]=0,a[e+1]=0,a[e+2]=0,a[e+3]=0);b.putImageData(c,0,0)}
function loadImage(a,b){void 0===b&&(b=!0);return __awaiter(this,void 0,void 0,function(){return __generator(this,function(c){if(!a)return[2,null];b&&(View.loading=!0);return[2,new Promise(function(e,d){var f=new Image;f.onload=function(){b&&(View.loading=!1);e(f)};f.onerror=function(g,h,l,k,m){b&&(View.loading=!1);d(m||g)};f.src=a})]})})}
function setContextQuality(a,b){try{"imageSmoothingEnabled"in this.context&&(this.context.imageSmoothingEnabled=b),"imageSmoothingQuality"in this.context&&(this.context.imageSmoothingQuality=b?"high":"low")}catch(c){}}
function processImage(a,b,c){var e=cLib.HEAP8.buffer,d=parseInt(a.width.toString()),f=parseInt(a.height.toString()),g=b.getImageData(0,0,d,f),h=g.data,l=[],k=(baseWidth+2)*(maxHeight+2)>>1,m=cLib._allocateImageInfo(d,f);a=0;try{var p=new Uint8Array(e,cLib._getImageInfoData(m),h.length),n=new Int32Array(e,cLib._getImageInfoPoints(m),k<<1);window.createPolygon=function(q){var u=new Polygon;u.points=Array(q);for(q=q-1<<1;0<=q;q-=2){var v=new Point;v.x=n[q];v.y=n[q+1];u.points[q>>1]=v}l.push(u)};p.set(h,
0);a=cLib._processImage(m);h.set(p,0);window.createPolygon=null}finally{cLib._freeImageInfo(m)}b.putImageData(g,0,0);if(c){c=b.fillStyle;e=b.strokeStyle;p=b.lineWidth;g=b.globalCompositeOperation;b.fillStyle="rgba(0,0,0,0.5)";b.strokeStyle="rgba(0,255,0,0.8)";b.lineWidth=1;b.globalCompositeOperation="source-over";b.fillRect(0,0,d,f);f=d=0;for(f=l.length-1;0<=f;f--){b.beginPath();h=l[f].points;d+=h.length;b.moveTo(h[0].x+.5,h[0].y+.5);for(k=1;k<h.length;k++)b.lineTo(h[k].x+.5,h[k].y+.5);b.lineTo(h[0].x+
.5,h[0].y+.5);b.stroke()}b.fillStyle="rgba(255,0,0,0.5)";for(f=l.length-1;0<=f;f--)for(h=l[f].points,k=h.length-1;0<=k;k--)b.fillRect(h[k].x-1,h[k].y-1,3,3);alert("point count "+d+" / polygon count "+l.length+" / maxY "+a);b.fillStyle=c;b.strokeStyle=e;b.lineWidth=p;b.globalCompositeOperation=g}return[l,a]}
var Resource=function(){function a(){}a.prototype.load=function(){this.loaded||this.loadInternal()};a.prototype.release=function(){this.loaded&&this.releaseInternal()};a.prototype.destroy=function(){this.release();this.destroyInternal()};return a}(),ResourceStorage=function(){function a(){this._count=0;this.resources={}}Object.defineProperty(a.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0});a.prototype.contains=function(b){return b in this.resources};a.prototype.add=
function(b,c){if(!b||!c)throw Error("Invalid resource");if(b in this.resources)throw Error("Name already exists");this.resources[b]=c;this._count++};a.prototype.getAndRemove=function(b){var c=this.resources[b];return c?(delete this.resources[b],this._count--,c):null};a.prototype.get=function(b){return this.resources[b]};Object.defineProperty(a.prototype,"loaded",{get:function(){if(this.resources){for(var b in this.resources)if(!this.resources[b].loaded)return!1;return!!this._count}return!1},enumerable:!1,
configurable:!0});a.prototype.load=function(){if(this.resources)for(var b in this.resources)this.resources[b].load()};a.prototype.release=function(){if(this.resources)for(var b in this.resources)this.resources[b].release()};a.prototype.destroy=function(){if(this.resources){for(var b in this.resources)this.resources[b].destroy();this.resources=null}};return a}(),ModelCoordinates=function(){function a(b){this.ptr=b}a.prototype.setCoordinates=function(b,c,e,d){var f=this.ptr>>2;cLib.HEAPF32[f]=b?-b:
0;cLib.HEAPF32[f+1]=c?-c:0;cLib.HEAPF32[f+2]=e-b;cLib.HEAPF32[f+3]=d-c};return a}(),TextureCoordinates=function(){function a(b){this.ptr=b}a.prototype.setCoordinates=function(b,c,e,d){var f=this.ptr>>2;e=b+e;d=c+d;cLib.HEAPF32[f]=b<<9|c<<1;cLib.HEAPF32[f+1]=b<<9|d<<1;cLib.HEAPF32[f+2]=e<<9|c<<1;cLib.HEAPF32[f+3]=e<<9|d<<1};return a}(),Texture=function(a){function b(c,e,d,f){void 0===d&&(d=0);void 0===f&&(f=0);var g=a.call(this)||this;g.gl=c;g._width=0;g._height=0;g._image=null;g._texture=null;g.bindImage(e,
d,f);return g}__extends(b,a);Object.defineProperty(b.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"image",{get:function(){return this._image},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"texture",{get:function(){return this._texture},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"loaded",{get:function(){return!!this._texture},enumerable:!1,configurable:!0});b.prototype.loadInternal=function(){this._image&&this.bindImage(this._image,this._width,this._height)};b.prototype.releaseInternal=function(){this.gl.context.deleteTexture(this._texture);this._texture=null};b.prototype.destroyInternal=function(){this.gl=this._image=null};b.prototype.bindImage=function(c,e,d){this.release();e=c?c.width:e;d=c?c.height:d;this._width=e;this._height=d;this._image=c;var f=this.gl.context;if(f){if(0>=
e||0>=d)throw Error("Invalid image size: "+e+" x "+d);var g=Math.min(4096,f.getParameter(f.MAX_TEXTURE_SIZE));if(e>g||d>g)throw Error("Image size too large: "+e+" x "+d+" / max: "+g);this.gl.clearErrors();g=f.createTexture();if(!g)throw Error("Null texture: "+f.getError());this._texture=g;f.bindTexture(f.TEXTURE_2D,g);c?f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,c):f.texImage2D(f.TEXTURE_2D,0,f.RGBA,e,d,0,f.RGBA,f.UNSIGNED_BYTE,null);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,
f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);this.gl.throwIfError();f.bindTexture(f.TEXTURE_2D,null)}};return b}(Resource),WebGL=function(){function a(){this.framebufferTextureViewHeight=this.framebufferTextureViewWidth=this.viewHeight=this.viewWidth=0;this.uniformViewConstants=this.currentTexture=this.indexBuffer=this.vertexBuffer=this.fragmentShader=
this.vertexShader=this.program=null;this.clearA=this.clearB=this.clearG=this.clearR=1;this.verticesPtr=this.rectangleCount=0;this.context=this.vertices=null;this.contextVersion=0;this.framebufferTexture=this.framebuffer=null}a.prototype.clearErrors=function(){for(var b=this.context,c=3;b.getError()!==b.NO_ERROR&&0<c--;)b.getError()};a.prototype.throwIfError=function(b){void 0===b&&(b=1);var c=this.context.getError();if(!b||c!==this.context.NO_ERROR)throw Error("WebGL error: "+c);};a.prototype.prepareNativeDraw=
function(b){this.flush();this.currentTexture=b};a.prototype.drawNative=function(b){this.rectangleCount=b;this.flush()};a.prototype.checkRecreate=function(b){return!this.context||this.context.isContextLost()||b.width!==this.viewWidth||b.height!==this.viewHeight};a.nextPowerOfTwo=function(b){if(!(b&b-1))return b;b|=b>>>1;b|=b>>>2;b|=b>>>4;b|=b>>>8;return(b|b>>>16)+1};a.prototype.recreate=function(b,c,e){var d=b.width,f=b.height;this.destroy(!0);if(!isIOSOrSafari&&"undefined"!==typeof WebGL2RenderingContext)try{this.context=
b.getContext("webgl2",{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0}),this.contextVersion=2}catch(h){}if(!this.context)try{this.context=b.getContext("webgl",{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0}),this.contextVersion=1}catch(h){}this.context||(this.context=b.getContext("experimental-webgl",{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0}),this.contextVersion=1);if(!this.context)throw Error("WebGL apparently not supported");b=this.context;
this.clearErrors();this.viewWidth=d;this.viewHeight=f;d=this.program=b.createProgram();this.throwIfError(d);f=this.vertexShader=b.createShader(b.VERTEX_SHADER);this.throwIfError(f);b.shaderSource(f,2===this.contextVersion?a.VertexShaderSource2:a.VertexShaderSource);b.compileShader(f);if(!b.getShaderParameter(f,b.COMPILE_STATUS))throw Error("WebGL vertex shader compilation error: "+b.getShaderInfoLog(f));this.throwIfError();var g=this.fragmentShader=b.createShader(b.FRAGMENT_SHADER);this.throwIfError(g);
b.shaderSource(g,2===this.contextVersion?a.FragmentShaderSource2:a.FragmentShaderSource);b.compileShader(g);if(!b.getShaderParameter(g,b.COMPILE_STATUS))throw Error("WebGL fragment shader compilation error: "+b.getShaderInfoLog(g));this.throwIfError();b.attachShader(d,f);b.attachShader(d,g);b.linkProgram(d);b.useProgram(d);this.throwIfError();this.uniformViewConstants=b.getUniformLocation(d,"uViewConstants");b.activeTexture(b.TEXTURE0);b.uniform1i(b.getUniformLocation(d,"uTexture"),0);this.throwIfError();
b.disable(b.DEPTH_TEST);b.disable(b.CULL_FACE);b.disable(b.DITHER);b.disable(b.SCISSOR_TEST);b.disable(b.POLYGON_OFFSET_FILL);b.disable(b.SAMPLE_ALPHA_TO_COVERAGE);b.disable(b.SAMPLE_COVERAGE);b.disable(b.STENCIL_TEST);b.enable(b.BLEND);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);this.setDefaultComposition();this.throwIfError();this.vertexBuffer=b.createBuffer();this.indexBuffer=b.createBuffer();this.allocateRectangleBuffers();f=a.nextPowerOfTwo(c);g=a.nextPowerOfTwo(e);c=Math.ceil(c*LevelSpriteSheet.TextureWidth/
f);e=Math.ceil(e*LevelSpriteSheet.TextureHeight/g);this.framebufferTextureViewWidth=c*f/LevelSpriteSheet.TextureWidth|0;this.framebufferTextureViewHeight=e*g/LevelSpriteSheet.TextureHeight|0;this.framebufferTexture=new Texture(this,null,f,g);LevelSpriteSheet.FramebufferTextureCoordinates.setCoordinates(0,0,c,e);this.throwIfError();this.framebuffer=b.createFramebuffer();this.throwIfError();b.bindFramebuffer(b.FRAMEBUFFER,this.framebuffer);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,
this.framebufferTexture.texture,0);this.useFramebuffer(!1);e=b.getAttribLocation(d,"aPosition");c=b.getAttribLocation(d,"aAlphaTextureCoordinates");b.enableVertexAttribArray(e);b.enableVertexAttribArray(c);b.vertexAttribPointer(e,a.FloatsPerPosition,b.FLOAT,!1,a.BytesPerVertex,a.BufferIndexPosition);b.vertexAttribPointer(c,a.FloatsPerAlphaTextureCoordinates,b.FLOAT,!1,a.BytesPerVertex,a.BufferIndexAlphaTextureCoordinates);b.clearColor(this.clearR,this.clearG,this.clearB,this.clearA)};a.prototype.destroy=
function(b){var c=this.context,e=this.verticesPtr,d=this.vertices,f=this.clearR,g=this.clearG,h=this.clearB,l=this.clearA;c&&(c.bindFramebuffer(c.FRAMEBUFFER,null),this.framebufferTexture&&this.framebufferTexture.destroy(),this.framebuffer&&c.deleteFramebuffer(this.framebuffer),this.program&&c.deleteProgram(this.program),this.vertexShader&&c.deleteShader(this.vertexShader),this.fragmentShader&&c.deleteShader(this.fragmentShader),this.vertexBuffer&&c.deleteBuffer(this.vertexBuffer),this.indexBuffer&&
c.deleteBuffer(this.indexBuffer));zeroObject(this);b?(this.verticesPtr=e,this.vertices=d,this.clearR=f,this.clearG=g,this.clearB=h,this.clearA=l):e&&cLib._freeBuffer(e)};a.prototype.flush=function(){var b=this.rectangleCount;if(b){var c=this.context;c.bufferSubData(c.ARRAY_BUFFER,0,this.vertices.subarray(0,a.FloatsPerRectangle*b));c.bindTexture(c.TEXTURE_2D,this.currentTexture.texture);c.drawElements(c.TRIANGLES,6*b,c.UNSIGNED_SHORT,0);this.rectangleCount=0}};a.prototype.clearColor=function(b,c,e,
d){var f=this.context;this.clearR=b;this.clearG=c;this.clearB=e;this.clearA=d;f.clearColor(b,c,e,d)};a.prototype.checkForLostContextUseFrameBufferAndClear=function(b){var c=this.context;if(!c)return!1;if(c.isContextLost())return this.destroy(!0),!1;b&&this.useFramebuffer(!0);c.clear(c.COLOR_BUFFER_BIT);return!0};a.prototype.setSumComposition=function(){var b=this.context;b.blendFunc(b.ONE,b.ONE)};a.prototype.setDefaultComposition=function(){var b=this.context;b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA)};
a.prototype.allocateRectangleBuffers=function(){this.verticesPtr||(this.verticesPtr=cLib._allocateBuffer(a.BytesPerRectangle*a.RectangleCapacity),this.vertices=new Float32Array(cLib.HEAP8.buffer,this.verticesPtr,a.FloatsPerRectangle*a.RectangleCapacity));for(var b=6*a.RectangleCapacity,c=new Uint16Array(b),e=0,d=0;e<b;e+=6,d+=4)c[e]=d,c[e+1]=d+1,c[e+2]=d+2,c[e+3]=d+2,c[e+4]=d+1,c[e+5]=d+3;b=this.context;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer);b.bufferData(b.ELEMENT_ARRAY_BUFFER,c,b.STATIC_DRAW);
b.bindBuffer(b.ARRAY_BUFFER,this.vertexBuffer);b.bufferData(b.ARRAY_BUFFER,this.vertices,b.DYNAMIC_DRAW)};a.prototype.useFramebuffer=function(b){var c=this.context;if(b){c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);b=this.framebufferTextureViewWidth;var e=this.framebufferTextureViewHeight}else c.bindFramebuffer(c.FRAMEBUFFER,null),b=this.viewWidth,e=this.viewHeight;c.uniform2f(this.uniformViewConstants,2/b,-2/e);c.viewport(0,0,b,e)};a.prototype.draw=function(b,c,e,d,f,g){if(this.currentTexture!==
b||this.rectangleCount>=a.RectangleCapacity)this.flush(),this.currentTexture=b;cLib._draw(this.verticesPtr+a.BytesPerRectangle*this.rectangleCount,c.ptr,e,d.ptr,f,g);this.rectangleCount++};a.prototype.drawScale=function(b,c,e,d,f,g,h){if(this.currentTexture!==b||this.rectangleCount>=a.RectangleCapacity)this.flush(),this.currentTexture=b;cLib._drawScale(this.verticesPtr+a.BytesPerRectangle*this.rectangleCount,c.ptr,e,d.ptr,f,g,h);this.rectangleCount++};a.prototype.drawRotate=function(b,c,e,d,f,g,h){if(this.currentTexture!==
b||this.rectangleCount>=a.RectangleCapacity)this.flush(),this.currentTexture=b;cLib._drawRotate(this.verticesPtr+a.BytesPerRectangle*this.rectangleCount,c.ptr,e,d.ptr,f,g,h);this.rectangleCount++};a.prototype.drawScaleRotate=function(b,c,e,d,f,g,h,l){if(this.currentTexture!==b||this.rectangleCount>=a.RectangleCapacity)this.flush(),this.currentTexture=b;cLib._drawScaleRotate(this.verticesPtr+a.BytesPerRectangle*this.rectangleCount,c.ptr,e,d.ptr,f,g,h,l);this.rectangleCount++};a.RectangleCapacity=512;
a.FloatsPerPosition=2;a.FloatsPerAlphaTextureCoordinates=1;a.FloatsPerVertex=a.FloatsPerPosition+a.FloatsPerAlphaTextureCoordinates;a.BytesPerVertex=4*a.FloatsPerVertex;a.FloatsPerRectangle=4*a.FloatsPerVertex;a.BytesPerRectangle=4*a.FloatsPerRectangle;a.BufferIndexPosition=0;a.BufferIndexAlphaTextureCoordinates=4*a.FloatsPerPosition;a.VertexShaderSource2="#version 300 es\nprecision highp float;\nin vec2 aPosition;\nin float aAlphaTextureCoordinates;\nflat out lowp float vAlpha;\nout lowp vec2 vTextureCoordinates;\nuniform vec2 uViewConstants;\nconst vec2 uViewOffsets = vec2(-1.0, 1.0);\nvoid main() {\n\tgl_Position = vec4(aPosition * uViewConstants + uViewOffsets, 0.0, 1.0);\n\tvAlpha = mod(aAlphaTextureCoordinates, 2.0);\n\tvTextureCoordinates = floor(vec2(\n\t\taAlphaTextureCoordinates * 0.001953125,\n\t\tmod(aAlphaTextureCoordinates * 0.5, 256.0)\n\t)) * 0.0078125;\n}";
a.VertexShaderSource="#version 100\nprecision highp float;\nattribute vec2 aPosition;\nattribute float aAlphaTextureCoordinates;\nvarying lowp float vAlpha;\nvarying lowp vec2 vTextureCoordinates;\nuniform vec2 uViewConstants;\nconst vec2 uViewOffsets = vec2(-1.0, 1.0);\nvoid main() {\n\tgl_Position = vec4(aPosition * uViewConstants + uViewOffsets, 0.0, 1.0);\n\tvAlpha = mod(aAlphaTextureCoordinates, 2.0);\n\tvTextureCoordinates = floor(vec2(\n\t\taAlphaTextureCoordinates * 0.001953125,\n\t\tmod(aAlphaTextureCoordinates * 0.5, 256.0)\n\t)) * 0.0078125;\n}";
a.FragmentShaderSource2="#version 300 es\nprecision lowp float;\nflat in float vAlpha;\nin vec2 vTextureCoordinates;\nout vec4 color;\nuniform sampler2D uTexture;\nvoid main() {\n\tcolor = texture(uTexture, vTextureCoordinates) * vAlpha;\n}";a.FragmentShaderSource="#version 100\nprecision lowp float;\nvarying float vAlpha;\nvarying vec2 vTextureCoordinates;\nuniform sampler2D uTexture;\nvoid main() {\n\tgl_FragColor = texture2D(uTexture, vTextureCoordinates) * vAlpha;\n}";return a}(),UISpriteSheet=
function(){function a(){}a.resize=function(b){var c=parseInt(b.getAttribute(a.SheetId)),e=c&255,d=c>>>8&255,f=c>>>16&255,g=c>>>24&255;b.style.backgroundSize=a.BackgroundSizeCss;1===e?(b.style.width=iconSizeCss,b.style.height=iconSizeCss,b.style.backgroundPositionX=css(-((f<<4)+2)),b.style.backgroundPositionY=css(-((g<<4)+2))):(b.style.width=css(c===a.ScrollThumb?24:e<<4),b.style.height=css(d<<4),b.style.backgroundPositionX=css(c===a.ScrollThumb?-72:-(f<<4)),b.style.backgroundPositionY=css(-(g<<4)))};
a.change=function(b,c){b.setAttribute(a.SheetId,c.toString());a.resize(b)};a.create=function(b,c){var e=document.createElement("span");e.style.backgroundImage="url(assets/images/uiSheet.png)";a.change(e,b);c&&c.appendChild(e);return e};a.html=function(b){return"<span "+a.SheetId+'="'+b+'"></span>'};a.finishHTMLCreation=function(b){b.style.backgroundImage="url(assets/images/uiSheet.png)";a.change(b,parseInt(b.getAttribute(a.SheetId)))};a.windowResized=function(){a.BackgroundSizeCss=css(a.TextureWidth)+
" "+css(a.TextureHeight)};a.TextureWidth=96;a.TextureHeight=112;a.BackgroundSizeCss=null;a.SheetId="data-sheet-id";a.Ball=257;a.Goal=65793;a.Bomb=131329;a.Cucumber=196865;a.Edit=262401;a.Question=327937;a.DeviceH=16777473;a.DeviceV=16843009;a.Hand=16908545;a.Fullscreen=16974081;a.Restart=17039617;a.Open=17105153;a.Accept=33554689;a.AcceptGreen=33620225;a.Clear=33685761;a.ClearRed=33751297;a.Back=33816833;a.Border=33882369;a.LineWidth0=50331905;a.LineWidth1=50397441;a.LineWidth2=50462977;a.LineWidth3=
50528513;a.ScrollThumb=50594562;a.Eraser=67109121;a.Rainbow=67174657;a.Pause=67240193;a.Play=67305729;a.PlayGreen=83886337;a.Exit=83951873;a.Menu=84017409;a.Download=84082945;a.Success=100663553;a.Error=100729089;a.Trophy=100794625;a.Clock=100860161;a.DeviceHI=100925697;a.DeviceVI=100991233;return a}(),LevelObject=function(){function a(b,c,e){switch(b){case a.TypeBall:case a.TypeGoal:case a.TypeBomb:case a.TypeCucumber:break;default:throw Error("Invalid level object type: "+b);}this.type=parseInt(b);
this.radius=a.RadiusByType[this.type];this.move(parseInt(c)||0,parseInt(e)||0)}a.prototype.move=function(b,c){this.x=b<=iconRadius?iconRadius:b>baseWidth-iconRadius?baseWidth-iconRadius:b;this.y=c<=iconRadius?iconRadius:c>maxHeight-iconRadius?maxHeight-iconRadius:c};a.revive=function(b){return new a(b.type,b.x,b.y)};a.TypeBall=0;a.TypeGoal=1;a.TypeBomb=2;a.TypeCucumber=3;a.TypeCount=4;a.VisibilityNone=0;a.VisibilityVisible=1;a.VisibilityAlive=2;a.VisibilityAll=a.VisibilityVisible|a.VisibilityAlive;
a.FragmentsPerBall=64;a.FragmentsMaxTime=1.5;a.FragmentsMaxTimeSaved=3.5;a.VictoryFragmentCount=500;a.LastType=a.TypeCucumber;a.RadiusByType=[6,5,5,6];a.ImagesByType=[UISpriteSheet.Ball,UISpriteSheet.Goal,UISpriteSheet.Bomb,UISpriteSheet.Cucumber];return a}(),Level=function(){function a(){this.name="";this.modifiedAt=this.createdAt=0;this.width=baseWidth;this.height=maxHeight;this.processedImage=this.image=this.thumbnailImage="";this.polygons=[];this.objects=[];this.levelPtr=0}a.prototype.toJSON=
function(){return this.toLevelFullInfo()};a.prototype.toLevelFullInfo=function(){return{name:this.name,createdAt:this.createdAt,modifiedAt:this.modifiedAt,width:this.width,height:this.height,thumbnailImage:this.thumbnailImage,image:this.image,processedImage:this.processedImage,polygons:this.polygons,objects:this.objects}};a.prototype.toLevelInfo=function(){return{name:this.name,createdAt:this.createdAt,modifiedAt:this.modifiedAt,width:this.width,height:this.height,thumbnailImage:this.thumbnailImage}};
a.revive=function(b){var c=new a;if(b&&("string"===typeof b&&(b=JSON.parse(b)),b))for(var e in c)"function"!==typeof c[e]&&(c[e]=b[e]);c.levelPtr=0;c.name=(c.name||"").trim();if(!c.createdAt||0>c.createdAt)c.createdAt=0;if(!c.modifiedAt||0>c.modifiedAt)c.modifiedAt=0;c.width=baseWidth;c.height=!c.height||c.height<=iconSize||c.height>maxHeight?maxHeight:parseInt(c.height.toString());c.image||(c.image="");c.processedImage?c.image||(c.image=c.processedImage):c.processedImage="";c.thumbnailImage||(c.thumbnailImage=
"");if(c.polygons){if(c.polygons.length>a.MaxPolygonCount)return null;e=0;for(b=c.polygons.length-1;0<=b;b--)if(c.polygons[b]=Polygon.revive(c.polygons[b]),e+=c.polygons[b].points.length,e>a.MaxPointCount)return null}else c.polygons=[];if(c.objects){if(c.objects.length>a.MaxObjectCount)return null;e=0;for(b=c.objects.length-1;0<=b;b--)if(c.objects[b]=LevelObject.revive(c.objects[b]),c.objects[b].type===LevelObject.TypeBall&&(e++,e>a.MaxBallCount))return null}else c.objects=[];return c};a.prototype.prepare=
function(){return __awaiter(this,void 0,void 0,function(){var b,c,e,d,f,g,h,l,k,m;return __generator(this,function(p){switch(p.label){case 0:return!this.image||this.processedImage&&this.thumbnailImage?[3,2]:[4,loadImage(this.image)];case 1:b=p.sent();c=document.createElement("canvas");c.width=thumbnailWidth;c.height=thumbnailHeight;e=c.getContext("2d",{alpha:!0});e.clearRect(0,0,c.width,c.height);e.drawImage(b,0,0,b.width>>2,b.height>>2);removeSemiAlpha(c,e);this.thumbnailImage=c.toDataURL("image/png");
c.width=baseWidth;c.height=maxHeight<=b.height?maxHeight:b.height;e.clearRect(0,0,c.width,c.height);e.drawImage(b,0,0);this.width=baseWidth;m=processImage(c,e,!1);this.polygons=m[0];this.height=m[1];this.height<iconSize?this.height=iconSize:(this.height++,this.height>maxHeight&&(this.height=maxHeight));if(this.polygons.length>a.MaxPolygonCount)throw Error(a.MaxPolygonCountMessage);d=0;for(f=this.polygons.length-1;0<=f;f--)d+=this.polygons[f].points.length;if(d>a.MaxPointCount)throw Error(a.MaxPointCountMessage);
g=this.height;for(f=this.objects.length-1;0<=f;f--)h=this.objects[f].y+iconRadius,this.height<h&&(this.height=h);this.height>maxHeight&&(this.height=maxHeight);l=c;k=e;g!==c.height&&(l=document.createElement("canvas"),l.width=baseWidth,l.height=g,k=l.getContext("2d",{alpha:!0}),k.clearRect(0,0,l.width,l.height),k.drawImage(b,0,0),this.image=l.toDataURL("image/png"),k.clearRect(0,0,l.width,l.height),k.drawImage(c,0,0));this.processedImage=l.toDataURL("image/png");p.label=2;case 2:return[2]}})})};a.prototype.viewResized=
function(){this.levelPtr&&cLib._viewResized(this.levelPtr,baseWidth,baseHeight)};a.prototype.createLevelPtr=function(b){this.destroyLevelPtr();for(var c=this.polygons,e=this.objects,d=4,f=c.length-1;0<=f;f--){var g=c[f].points.length;d+=2===g?1:g}g=this.objects.length;var h=cLib.stackSave();f=cLib.HEAP8.buffer;var l=d<<3,k=g<<2,m=g<<3,p=cLib.stackAlloc(l),n=cLib.stackAlloc(l),q=cLib.stackAlloc(l);l=cLib.stackAlloc(l);k=cLib.stackAlloc(k);var u=cLib.stackAlloc(m),v=cLib.stackAlloc(m);m=cLib.stackAlloc(m);
var w=new Float32Array(f,p,d),x=new Float32Array(f,n,d),y=new Float32Array(f,q,d),z=new Float32Array(f,l,d),C=new Int32Array(f,k,g),D=new Float32Array(f,u,g),E=new Float32Array(f,v,g),F=new Float32Array(f,m,g);w[0]=-1;x[0]=-1;y[0]=this.width;z[0]=-1;w[1]=this.width;x[1]=-1;y[1]=this.width;z[1]=this.height;w[2]=this.width;x[2]=this.height;y[2]=-1;z[2]=this.height;w[3]=-1;x[3]=this.height;y[3]=-1;z[3]=-1;f=0;for(var r=4;f<c.length;f++){for(var t=c[f].points,B=t.length-1,A=0;A<B;A++)w[r]=t[A].x,x[r]=
t[A].y,y[r]=t[A+1].x,z[r]=t[A+1].y,r++;1<B&&(w[r]=t[B].x,x[r]=t[B].y,y[r]=t[0].x,z[r]=t[0].y,r++)}for(f=0;f<g;f++)c=e[f],C[f]=c.type,D[f]=c.x,E[f]=c.y,F[f]=c.radius;this.levelPtr=cLib._init(this.height,baseWidth,baseHeight,d,p,n,q,l,g,k,u,v,m,b);cLib.stackRestore(h)};a.prototype.destroyLevelPtr=function(){this.levelPtr&&(cLib._destroy(this.levelPtr),this.levelPtr=0)};a.prototype.clearImage=function(){this.width=baseWidth;this.height=maxHeight;this.thumbnailImage=this.processedImage=this.image=""};
a.prototype.clearObjects=function(){this.polygons=[];this.objects=[]};a.prototype.restart=function(b){this.createLevelPtr(b)};a.prototype.step=function(b){this.levelPtr&&cLib._step(this.levelPtr,ControlMode.accelerationX,ControlMode.accelerationY,ControlMode.mode,b)};a.MaxPolygonCountMessage="Level.MaxPolygonCount";a.MaxPointCountMessage="Level.MaxPointCount";a.MaxPolygonCount=5E3;a.MaxPointCount=2E4;a.MaxObjectCount=256;a.MaxBallCount=40;return a}(),LevelCache=function(){function a(){}a.isSupported=
function(){try{return"caches"in window&&"open"in caches}catch(b){}return!1};a.loadBuiltInLevels=function(){return new Promise(function(b,c){a.BuiltInLevelIds?b():a.BuiltInLevelsLoadFinished=b})};a.builtInLevelThumbnailPath=function(b){if(0>b||b>=a.BuiltInLevelThumbnails.length)throw Error("Invalid id");return a.BuiltInLevelThumbnails[b]};a.loadBuiltInLevel=function(b){if(0>b||b>=a.BuiltInLevels.length)throw Error("Invalid id");try{return Level.revive(a.BuiltInLevels[b])}catch(c){return null}};a.isNameValid=
function(b){b=(b||"").trim();return!!b&&!b.endsWith(a.LevelInfoExtension)&&!/^\.+$/.test(b)&&!/[\\\/\?\*:<>%]/.test(b)&&!/^\d+$/.test(b)};a.getLevelNames=function(b){void 0===b&&(b=!0);return __awaiter(this,void 0,void 0,function(){var c,e,d,f,g,h,l,k;return __generator(this,function(m){switch(m.label){case 0:b&&(View.loading=!0),m.label=1;case 1:return m.trys.push([1,4,5,6]),[4,caches.open(a.CacheName)];case 2:return c=m.sent(),[4,c.keys()];case 3:e=m.sent();if(!e||!e.length)return[2,[]];d=Array(e.length>>
1);f=a.LevelInfoExtension;g=e.length-1;for(h=0;0<=g;g--)l=e[g].url,l.endsWith(f)||(k=l.lastIndexOf("/"),d[h++]=decodeURIComponent(0>k?l:l.substr(k+1)));d.sort();return[2,d];case 4:return m.sent(),[2,[]];case 5:return b&&(View.loading=!1),[7];case 6:return[2]}})})};a.loadLevelInfo=function(b,c){void 0===c&&(c=!0);return __awaiter(this,void 0,void 0,function(){var e,d,f;return __generator(this,function(g){switch(g.label){case 0:if(!a.isNameValid(b))throw Error("Invalid name");c&&(View.loading=!0);g.label=
1;case 1:return g.trys.push([1,5,6,7]),[4,caches.open(a.CacheName)];case 2:return e=g.sent(),[4,e.match(encodeURIComponent(b+a.LevelInfoExtension))];case 3:return(d=g.sent())?[4,d.text()]:[2,null];case 4:f=g.sent();if(!f)return[2,null];try{return[2,JSON.parse(f)]}catch(h){return[2,null]}case 5:return g.sent(),[2,null];case 6:return c&&(View.loading=!1),[7];case 7:return[2]}})})};a.saveLevel=function(b,c){void 0===c&&(c=!0);return __awaiter(this,void 0,void 0,function(){var e,d;return __generator(this,
function(f){switch(f.label){case 0:if(!b||!a.isNameValid(b.name))throw Error("Invalid level");c&&(View.loading=!0);e=b.thumbnailImage;f.label=1;case 1:return f.trys.push([1,,5,6]),[4,caches.open(a.CacheName)];case 2:return d=f.sent(),[4,d.put(encodeURIComponent(b.name+a.LevelInfoExtension),new Response(new Blob([JSON.stringify(b.toLevelInfo())],{type:"application/json"})))];case 3:return f.sent(),b.thumbnailImage=null,[4,d.put(encodeURIComponent(b.name),new Response(new Blob([JSON.stringify(b)],{type:"application/json"})))];
case 4:return f.sent(),[3,6];case 5:return b.thumbnailImage=e,c&&(View.loading=!1),[7];case 6:return[2]}})})};a.loadLevel=function(b,c){void 0===c&&(c=!0);return __awaiter(this,void 0,void 0,function(){var e,d,f;return __generator(this,function(g){switch(g.label){case 0:if(!a.isNameValid(b))throw Error("Invalid name");c&&(View.loading=!0);g.label=1;case 1:return g.trys.push([1,,5,6]),[4,caches.open(a.CacheName)];case 2:return e=g.sent(),[4,e.match(encodeURIComponent(b))];case 3:return(d=g.sent())?
[4,d.text()]:[2,null];case 4:f=g.sent();if(!f)return[2,null];try{return[2,Level.revive(f)]}catch(h){return[2,null]}case 5:return c&&(View.loading=!1),[7];case 6:return[2]}})})};a.deleteLevel=function(b,c){void 0===c&&(c=!0);return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(d){switch(d.label){case 0:if(!a.isNameValid(b))throw Error("Invalid name");c&&(View.loading=!0);d.label=1;case 1:return d.trys.push([1,,5,6]),[4,caches.open(a.CacheName)];case 2:return e=d.sent(),
[4,e.delete(encodeURIComponent(b))];case 3:return d.sent(),[4,e.delete(encodeURIComponent(b+a.LevelInfoExtension))];case 4:return d.sent(),a.deleteLevelRecord(b),[3,6];case 5:return c&&(View.loading=!1),[7];case 6:return[2]}})})};a.downloadLevel=function(b,c,e){void 0===c&&(c=-1);void 0===e&&(e=!0);return __awaiter(this,void 0,void 0,function(){var d,f,g,h,l;return __generator(this,function(k){switch(k.label){case 0:if(!a.isNameValid(b))throw Error("Invalid name");if(!BlobDownloader.supported)return[2,
a.DownloadLevelError];e&&(View.loading=!0);k.label=1;case 1:k.trys.push([1,7,8,9]);f=d=void 0;if(!(0<=c&&c<a.BuiltInLevels.length))return[3,2];d=a.BuiltInLevels[c];f=d.indexOf('"name":"')+8;d=d.substr(0,f)+b+d.substr(d.indexOf('"',f));return[3,6];case 2:return[4,caches.open(a.CacheName)];case 3:return g=k.sent(),[4,g.match(encodeURIComponent(b))];case 4:return(h=k.sent())?[4,h.text()]:[2,a.DownloadLevelError];case 5:d=k.sent();if(!d)return[2,a.DownloadLevelError];k.label=6;case 6:return b+=".json",
f=d.indexOf('"processedImage":'),0<=f&&(f+=17,'"'===d.charAt(f)&&(l=d.indexOf('"',f+1),l>f&&(d=d.substr(0,f)+"null"+d.substr(l+1)))),f=d.indexOf('"thumbnailImage":'),0<=f&&(f+=17,'"'===d.charAt(f)&&(l=d.indexOf('"',f+1),l>f&&(d=d.substr(0,f)+"null"+d.substr(l+1)))),f=d.indexOf('"polygons":'),0<=f&&(f+=11,"["===d.charAt(f)&&(l=d.indexOf("],",f+1),l>f?d=d.substr(0,f)+"null"+d.substr(l+1):(l=d.indexOf("}]}]}",f+1),l>f&&(d=d.substr(0,f)+"null"+d.substr(l+4))))),[2,androidWrapper?androidWrapper.downloadLevel(b,
d,null):BlobDownloader.download(d,b,"application/json")?a.DownloadLevelSuccess:a.DownloadLevelError];case 7:return k.sent(),[2,a.DownloadLevelError];case 8:return e&&(View.loading=!1),[7];case 9:return[2]}})})};a.downloadLevelImage=function(b,c,e){void 0===e&&(e=!0);return __awaiter(this,void 0,void 0,function(){var d,f;return __generator(this,function(g){a.isNameValid(b)||(b=Strings.Level);if(!BlobDownloader.supported)return[2,a.DownloadLevelError];e&&(View.loading=!0);try{return b+=".png",androidWrapper?
(d=c.toDataURL("image/png"),f=d.indexOf("data:image/png;base64,"),0<=f&&(d=d.substr(f+22)),[2,androidWrapper.downloadLevel(b,null,d)]):[2,new Promise(function(h,l){var k;c.toBlob?c.toBlob(function(m){h(m&&BlobDownloader.download(m,b,"image/png")?a.DownloadLevelSuccess:a.DownloadLevelError)},"image/png"):c.msToBlob&&(k=c.msToBlob())?h(BlobDownloader.download(k,b,"image/png")?a.DownloadLevelSuccess:a.DownloadLevelError):h(a.DownloadLevelError)})]}catch(h){return[2,a.DownloadLevelError]}finally{e&&(View.loading=
!1)}return[2]})})};a.renameLevel=function(b,c,e){void 0===e&&(e=!0);return __awaiter(this,void 0,void 0,function(){var d,f;return __generator(this,function(g){switch(g.label){case 0:if(!a.isNameValid(b)||!a.isNameValid(c))throw Error("Invalid name");e&&(View.loading=!0);g.label=1;case 1:return g.trys.push([1,,6,7]),[4,a.loadLevel(b,!1)];case 2:return d=g.sent(),[4,a.loadLevelInfo(b,!1)];case 3:f=g.sent();if(!d||!f)return[2,!1];d.name=c;d.thumbnailImage=f.thumbnailImage;return[4,a.saveLevel(d,!1)];
case 4:return g.sent(),[4,a.deleteLevel(b,!1)];case 5:return g.sent(),[2,!0];case 6:return e&&(View.loading=!1),[7];case 7:return[2]}})})};a.sendLevelToEditor=function(b,c,e){void 0===c&&(c=null);void 0===e&&(e=!0);return __awaiter(this,void 0,void 0,function(){var d,f,g;return __generator(this,function(h){switch(h.label){case 0:if(!b&&!c||b&&c||b&&!a.isNameValid(b))throw Error("Invalid level");e&&(View.loading=!0);h.label=1;case 1:return h.trys.push([1,,7,8]),d=null,b?[4,caches.open(a.CacheName)]:
[3,5];case 2:return f=h.sent(),[4,f.match(encodeURIComponent(b))];case 3:return(g=h.sent())?[4,g.text()]:[2,!1];case 4:return d=h.sent(),[3,6];case 5:d=JSON.stringify(c),h.label=6;case 6:if(!d)return[2,!1];localStorage.setItem(a.EditorLevelName,d);return[2,!0];case 7:return e&&(View.loading=!1),[7];case 8:return[2]}})})};a.loadEditorLevel=function(){return Level.revive(localStorage.getItem(a.EditorLevelName))};a.saveEditorLevel=function(b){b?localStorage.setItem(a.EditorLevelName,JSON.stringify(b)):
localStorage.removeItem(a.EditorLevelName)};a.loadLevelFromOptions=function(b){return __awaiter(this,void 0,void 0,function(){var c,e,d;return __generator(this,function(f){switch(f.label){case 0:if(b)return[3,1];c=a.loadEditorLevel();return[3,6];case 1:return(e=b.level)?[3,5]:b.levelName?[4,a.loadLevel(b.levelName,!1)]:[3,3];case 2:return d=f.sent(),[3,4];case 3:d=a.loadBuiltInLevel(b.levelId),f.label=4;case 4:e=d,f.label=5;case 5:c=e,f.label=6;case 6:return[2,c]}})})};a.getLevelRecord=function(b){if(!a.LevelRecords){try{var c=
localStorage.getItem(a.LevelRecordsName);c&&(a.LevelRecords=JSON.parse(c))}catch(d){}if(a.LevelRecords)for(var e in a.LevelRecords){if(c=a.LevelRecords[e])if(0<=c.fmt.indexOf(Strings.OppositeDecimalSeparator))c.fmt=c.fmt.replace(Strings.OppositeDecimalSeparator,Strings.DecimalSeparator);else break}else a.LevelRecords={};a.LastRecordName=localStorage.getItem(a.LastRecordNameName)}return a.LevelRecords[b]||null};a.setLevelRecord=function(b,c,e){var d=a.getLevelRecord(b);e=e?e.trim():"";d?(d.time=c,
d.name=e||"-",d.fmt=a.formatLevelRecordTime(c)):a.LevelRecords[b]={time:c,name:e||"-",fmt:a.formatLevelRecordTime(c)};localStorage.setItem(a.LevelRecordsName,JSON.stringify(a.LevelRecords));a.LastRecordName!==e&&localStorage.setItem(a.LastRecordNameName,a.LastRecordName=e)};a.deleteLevelRecord=function(b){a.getLevelRecord(b)&&(delete a.LevelRecords[b],localStorage.setItem(a.LevelRecordsName,JSON.stringify(a.LevelRecords)))};a.clearLastRecordName=function(){a.LastRecordName&&localStorage.setItem(a.LastRecordNameName,
a.LastRecordName="")};a.formatLevelRecordTime=function(b){if(!b||0>b)return"-";b=b/10|0;99999<b&&(b=99999);return(b/100|0)+Strings.DecimalSeparator+format2(b%100)+" s"};a.DownloadLevelSuccess=1;a.DownloadLevelError=0;a.DownloadLevelNoPermission=-1;a.DownloadLevelFileAlreadyExists=-2;a.BuiltInLevelIds=null;a.BuiltInLevels=null;a.BuiltInLevelThumbnails=null;a.BuiltInLevelsLoadFinished=null;a.LevelInfoExtension=".levelinfo";a.CacheName="pixel-level-cache";a.EditorLevelName="pixel-editor-level";a.LastRecordNameName=
"pixel-editor-last-name";a.LevelRecordsName="pixel-editor-level-records";a.LevelRecords=null;a.LastRecordName=null;return a}(),LevelSpriteSheet=function(){function a(){}a.allocateCoordinates=function(){var b=cLib._initLevelSpriteSheet();a.LevelSpriteSheetPtr=b;a.LevelModelCoordinates=new ModelCoordinates(b);b+=16;a.FullTextureCoordinates=new TextureCoordinates(b);b+=16;a.FramebufferTextureCoordinates=new TextureCoordinates(b);b+=16;for(var c=0;c<a.BackgroundModelCoordinates.length;c++)a.BackgroundModelCoordinates[c]=
new ModelCoordinates(b),b+=16;for(c=0;c<a.BackgroundTextureCoordinates.length;c++)a.BackgroundTextureCoordinates[c]=new TextureCoordinates(b),b+=16;a.LevelObjectModelCoordinates=new ModelCoordinates(b);b+=16;for(c=0;c<a.LevelObjectTextureCoordinatesByType.length;c++)a.LevelObjectTextureCoordinatesByType[c]=new TextureCoordinates(b),b+=16;a.FullViewModelCoordinates=new ModelCoordinates(b);b+=16;a.ExplosionBgTextureCoordinates=new TextureCoordinates(b);b+=16;a.FadeBgModelCoordinates=new ModelCoordinates(b);
b+=16;a.FadeBgTextureCoordinates=new TextureCoordinates(b);b+=16;a.FadeBgSadTextureCoordinates=new TextureCoordinates(b);b+=16;for(c=0;c<a.FragmentModelCoordinates.length;c++)a.FragmentModelCoordinates[c]=new ModelCoordinates(b),b+=16;for(c=0;c<a.FragmentTextureCoordinates.length;c++)a.FragmentTextureCoordinates[c]=new TextureCoordinates(b),b+=16;a.CursorCenterModelCoordinates=new ModelCoordinates(b);b+=16;a.CursorCenterTextureCoordinates=new TextureCoordinates(b);b+=16;a.CursorTargetModelCoordinates=
new ModelCoordinates(b);b+=16;a.CursorTargetTextureCoordinates=new TextureCoordinates(b);b+=16;a.FaceModelCoordinates=new ModelCoordinates(b);b+=16;a.SadFaceTextureCoordinates=new TextureCoordinates(b);a.HappyFaceTextureCoordinates=new TextureCoordinates(b+16)};a.setupFixedCoordinates=function(){a.FullTextureCoordinates.setCoordinates(0,0,a.TextureWidth,a.TextureHeight);var b=a.BackgroundScale,c=a.BackgroundScaleRightShift,e=baseWidth<<1>>c,d=Math.ceil(Math.sqrt(2)*(baseWidth>>c));a.BackgroundModelCoordinates[0].setCoordinates(e>>
c,-.4*b*baseWidth,e,d);a.BackgroundModelCoordinates[1].setCoordinates(e>>c,-.38*b*baseWidth,e,d);a.BackgroundModelCoordinates[2].setCoordinates(e>>c,-.36*b*baseWidth,e,d);a.BackgroundModelCoordinates[3].setCoordinates(e>>c,-.34*b*baseWidth,e,d);a.BackgroundModelCoordinates[4].setCoordinates(e>>c,-.32*b*baseWidth,e,d);a.BackgroundModelCoordinates[5].setCoordinates(e>>c,-.3*b*baseWidth,e,d);a.BackgroundModelCoordinates[6].setCoordinates(e>>c,-.28*b*baseWidth,e,d);a.BackgroundModelCoordinates[7].setCoordinates(e>>
c,-.26*b*baseWidth,e,d);a.BackgroundModelCoordinates[8].setCoordinates(e>>c,-.24*b*baseWidth,e,d);a.BackgroundModelCoordinates[9].setCoordinates(e>>c,-.2*b*baseWidth,e,d);a.BackgroundModelCoordinates[10].setCoordinates(e>>c,-.16*b*baseWidth,e,d);a.BackgroundModelCoordinates[11].setCoordinates(e>>c,-.12*b*baseWidth,e,d);a.BackgroundModelCoordinates[12].setCoordinates(e>>c,-.08*b*baseWidth,e,d);a.BackgroundModelCoordinates[13].setCoordinates(e>>c,-.04*b*baseWidth,e,d);a.BackgroundModelCoordinates[14].setCoordinates(e>>
c,-0*b*baseWidth,e,d);a.BackgroundTextureCoordinates[0].setCoordinates(3,53,2,72);a.BackgroundTextureCoordinates[1].setCoordinates(9,53,2,72);a.BackgroundTextureCoordinates[2].setCoordinates(15,53,2,72);a.BackgroundTextureCoordinates[3].setCoordinates(21,53,2,72);a.BackgroundTextureCoordinates[4].setCoordinates(27,53,2,72);a.BackgroundTextureCoordinates[5].setCoordinates(33,53,2,72);a.BackgroundTextureCoordinates[6].setCoordinates(39,53,2,72);a.BackgroundTextureCoordinates[7].setCoordinates(45,53,
2,72);a.LevelObjectTextureCoordinatesByType[LevelObject.TypeBall].setCoordinates(2,2,iconSize,iconSize);a.LevelObjectTextureCoordinatesByType[LevelObject.TypeGoal].setCoordinates(18,2,iconSize,iconSize);a.LevelObjectTextureCoordinatesByType[LevelObject.TypeBomb].setCoordinates(34,2,iconSize,iconSize);a.LevelObjectTextureCoordinatesByType[LevelObject.TypeCucumber].setCoordinates(50,2,iconSize,iconSize);a.ExplosionBgTextureCoordinates.setCoordinates(36,20,8,8);a.FadeBgTextureCoordinates.setCoordinates(52,
20,8,8);a.FadeBgSadTextureCoordinates.setCoordinates(52,36,8,8);a.FragmentTextureCoordinates[0].setCoordinates(2,17,3,3);a.FragmentTextureCoordinates[1].setCoordinates(7,17,3,3);a.FragmentTextureCoordinates[2].setCoordinates(12,17,3,4);a.FragmentTextureCoordinates[3].setCoordinates(2,22,3,3);a.FragmentTextureCoordinates[4].setCoordinates(7,22,3,4);a.FragmentTextureCoordinates[5].setCoordinates(12,23,3,4);a.FragmentTextureCoordinates[6].setCoordinates(2,27,3,4);a.FragmentTextureCoordinates[7].setCoordinates(7,
28,3,3);a.FragmentTextureCoordinates[8].setCoordinates(18,17,3,3);a.FragmentTextureCoordinates[9].setCoordinates(23,17,3,3);a.FragmentTextureCoordinates[10].setCoordinates(28,17,3,4);a.FragmentTextureCoordinates[11].setCoordinates(18,22,3,3);a.FragmentTextureCoordinates[12].setCoordinates(23,22,3,4);a.FragmentTextureCoordinates[13].setCoordinates(28,23,3,4);a.FragmentTextureCoordinates[14].setCoordinates(18,27,3,4);a.FragmentTextureCoordinates[15].setCoordinates(23,28,3,3);a.CursorCenterTextureCoordinates.setCoordinates(66,
2,a.CursorCenterSize,a.CursorCenterSize);a.CursorTargetTextureCoordinates.setCoordinates(98,2,a.CursorTargetSize,a.CursorTargetSize);a.SadFaceTextureCoordinates.setCoordinates(96,32,31,31);a.HappyFaceTextureCoordinates.setCoordinates(96,80,31,31)};a.recreateIfNecessary=function(){var b=scaleFactor,c=baseWidth*b,e=baseHeight*b;a.scaleFactor===scaleFactor&&a.LevelModelCoordinates?a.FullViewModelCoordinates.setCoordinates(0,0,c,e):(a.scaleFactor=scaleFactor,a.LevelModelCoordinates||(a.allocateCoordinates(),
a.setupFixedCoordinates()),a.LevelObjectModelCoordinates.setCoordinates(iconRadius*b,iconRadius*b,iconSize*b,iconSize*b),a.FullViewModelCoordinates.setCoordinates(0,0,c,e),a.FadeBgModelCoordinates.setCoordinates(0,0,8*b,8*b),a.FragmentModelCoordinates[0].setCoordinates(1*b,1*b,3*b,3*b),a.FragmentModelCoordinates[1].setCoordinates(1*b,1*b,3*b,3*b),a.FragmentModelCoordinates[2].setCoordinates(1*b,2*b,3*b,4*b),a.FragmentModelCoordinates[3].setCoordinates(1*b,1*b,3*b,3*b),a.FragmentModelCoordinates[4].setCoordinates(1*
b,2*b,3*b,4*b),a.FragmentModelCoordinates[5].setCoordinates(1*b,2*b,3*b,4*b),a.FragmentModelCoordinates[6].setCoordinates(1*b,2*b,3*b,4*b),a.FragmentModelCoordinates[7].setCoordinates(1*b,1*b,3*b,3*b),a.CursorCenterModelCoordinates.setCoordinates(.5*a.CursorCenterSize*b|0,.5*a.CursorCenterSize*b|0,a.CursorCenterSize*b,a.CursorCenterSize*b),a.CursorTargetModelCoordinates.setCoordinates(.5*a.CursorTargetSize*b|0,.5*a.CursorTargetSize*b|0,a.CursorTargetSize*b,a.CursorTargetSize*b),a.FaceModelCoordinates.setCoordinates(15*
b,15*b,31*b,31*b))};a.preload=function(){return __awaiter(this,void 0,void 0,function(){var b;return __generator(this,function(c){switch(c.label){case 0:if(a.image)return[3,2];b=a;return[4,loadImage("assets/images/sheet.png")];case 1:b.image=c.sent(),c.label=2;case 2:return[2]}})})};a.createTexture=function(b){return new Texture(b,a.image)};a.TextureWidth=128;a.TextureHeight=128;a.CursorCenterSize=25;a.CursorTargetSize=25;a.LevelSpriteSheetPtr=0;a.BackgroundCount=15;a.BackgroundScale=.5;a.BackgroundScaleRightShift=
1;a.LevelModelCoordinates=null;a.FullTextureCoordinates=null;a.FramebufferTextureCoordinates=null;a.BackgroundModelCoordinates=Array(a.BackgroundCount);a.BackgroundTextureCoordinates=Array(8);a.LevelObjectModelCoordinates=null;a.LevelObjectTextureCoordinatesByType=Array(LevelObject.TypeCount);a.FullViewModelCoordinates=null;a.ExplosionBgTextureCoordinates=null;a.FadeBgModelCoordinates=null;a.FadeBgTextureCoordinates=null;a.FadeBgSadTextureCoordinates=null;a.FragmentModelCoordinates=Array(8);a.FragmentTextureCoordinates=
Array(16);a.CursorCenterModelCoordinates=null;a.CursorCenterTextureCoordinates=null;a.CursorTargetModelCoordinates=null;a.CursorTargetTextureCoordinates=null;a.FaceModelCoordinates=null;a.SadFaceTextureCoordinates=null;a.HappyFaceTextureCoordinates=null;a.image=null;a.scaleFactor=0;return a}(),ControlMode=function(){function a(){}Object.defineProperty(a,"mode",{get:function(){return a._mode},enumerable:!1,configurable:!0});Object.defineProperty(a,"accelerationSupported",{get:function(){return a._accelerationSupported},
enumerable:!1,configurable:!0});Object.defineProperty(a,"modeImage",{get:function(){return a.ImagesByMode[a._mode]},enumerable:!1,configurable:!0});a.toggleMode=function(){var b=a._mode+1;if(b>a.AccelerometerVI||!a._accelerationSupported)b=a.Pointer;a._mode=b;localStorage.setItem(a.ControlModeName,b.toString());a.prepare()};a.init=function(){a._accelerationSupported=androidWrapper&&androidWrapper.isSupported()||"DeviceMotionEvent"in window;if(a._accelerationSupported){var b=parseInt(localStorage.getItem(a.ControlModeName));
a._mode=isNaN(b)||b<a.Pointer||b>a.AccelerometerVI?a.Pointer:b}else a._mode=a.Pointer;a.prepare()};a.prepare=function(){window.removeEventListener("devicemotion",a.deviceMotion);a.invertXY=a._mode===a.AccelerometerV||a._mode===a.AccelerometerVI;a.invertSign=a._mode===a.AccelerometerHI||a._mode===a.AccelerometerVI;a._mode!==a.Pointer&&window.addEventListener("devicemotion",a.deviceMotion)};a.processAndroidAcceleration=function(){if(a.skipAndroid)a.skipAndroid=!1;else{a.skipAndroid=!0;if(a.invertXY){var b=
androidWrapper.getY();var c=androidWrapper.getX()}else b=-androidWrapper.getX(),c=androidWrapper.getY();a.invertSign&&(b=-b,c=-c);-.3<b&&.3>b&&(b=0);-.3<c&&.3>c&&(c=0);a.accelerationX=.8*a.accelerationX+.2*b;a.accelerationY=.8*a.accelerationY+.2*c}};a.deviceMotion=function(b){var c=b.accelerationIncludingGravity;a.invertXY?(b=c.y,c=c.x):(b=-c.x,c=c.y);a.invertSign&&(b=-b,c=-c);-.3<b&&.3>b&&(b=0);-.3<c&&.3>c&&(c=0);a.accelerationX=.8*a.accelerationX+.2*b;a.accelerationY=.8*a.accelerationY+.2*c};a.ControlModeName=
"pixel-control-mode";a.ImagesByMode=[UISpriteSheet.Hand,UISpriteSheet.DeviceH,UISpriteSheet.DeviceV,UISpriteSheet.DeviceHI,UISpriteSheet.DeviceVI];a.Pointer=0;a.AccelerometerH=1;a.AccelerometerV=2;a.AccelerometerHI=3;a.AccelerometerVI=4;a._mode=a.Pointer;a._accelerationSupported=!1;a.skipAndroid=!1;a.invertXY=!1;a.invertSign=!1;a.accelerationX=0;a.accelerationY=0;return a}(),FullscreenControl=function(){function a(){}a.requestFullscreen=function(b){b||(b=document.body);var c=!0,e=null;try{b.requestFullscreen?
e=b.requestFullscreen():b.webkitRequestFullscreen?e=b.webkitRequestFullscreen():b.mozRequestFullScreen?e=b.mozRequestFullScreen():b.msRequestFullscreen?e=b.msRequestFullscreen():c=!1}catch(d){c=!1}c||b===document.body?ignorePromise(e):a.requestFullscreen(null)};a.exitFullscreen=function(){var b=null;try{document.exitFullscreen?b=document.exitFullscreen():document.webkitExitFullscreen?b=document.webkitExitFullscreen():document.mozExitFullScreen?b=document.mozExitFullScreen():document.msExitFullscreen&&
(b=document.msExitFullscreen())}catch(c){}ignorePromise(b)};Object.defineProperty(a,"fullscreenElement",{get:function(){var b=null;try{"fullscreenElement"in document&&(b=document.fullscreenElement),!b&&"webkitFullscreenElement"in document&&(b=document.webkitFullscreenElement),!b&&"mozFullscreenElement"in document&&(b=document.mozFullscreenElement),!b&&"msFullscreenElement"in document&&(b=document.msFullscreenElement)}catch(c){}return b},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,
"onfullscreenchange",{get:function(){try{if("onfullscreenchange"in document)return document.onfullscreenchange;if("onwebkitfullscreenchange"in document)return document.onwebkitfullscreenchange;if("onmozfullscreenchange"in document)return document.onmozfullscreenchange;if("onmsfullscreenchange"in document)return document.onmsfullscreenchange}catch(b){}return null},enumerable:!1,configurable:!0});Object.defineProperty(a,"onfullscreenchange",{set:function(b){try{"onfullscreenchange"in document&&(document.onfullscreenchange=
b),"onwebkitfullscreenchange"in document&&(document.onwebkitfullscreenchange=b),"onmozfullscreenchange"in document&&(document.onmozfullscreenchange=b),"onmsfullscreenchange"in document&&(document.onmsfullscreenchange=b)}catch(c){}},enumerable:!1,configurable:!0});a.toggleFullscreen=function(){a.fullscreenMode=!a.fullscreenMode};Object.defineProperty(a,"fullscreenMode",{get:function(){return!!a.fullscreenElement},set:function(b){b?a.requestFullscreen():a.exitFullscreen()},enumerable:!1,configurable:!0});
return a}(),PointerHandler=function(){function a(b,c,e,d){void 0===c&&(c=null);void 0===e&&(e=null);void 0===d&&(d=null);this.documentTarget=document.documentElement||document.body;this.element=b;this.downCallback=c;this.moveCallback=e;this.upCallback=d;this.elementHasExtraTouchStartHandler=!1;"onpointerdown"in b?(this.documentDownEvent="pointerdown",this.documentMoveEvent="pointermove",this.documentUpEvent="pointerup",this.documentCancelEvent="pointercancel",this.boundDocumentDown=this.pointerDown.bind(this),
this.boundDocumentUp=this.pointerUp.bind(this),this.boundDocumentMove=this.pointerMove.bind(this),"ontouchstart"in b&&(this.elementHasExtraTouchStartHandler=!0,b.addEventListener("touchstart",cancelEvent))):"ontouchstart"in b?(this.documentDownEvent="touchstart",this.documentMoveEvent="touchmove",this.documentUpEvent="touchend",this.documentCancelEvent="touchcancel",this.boundDocumentDown=this.touchStart.bind(this),this.boundDocumentUp=this.touchEnd.bind(this),this.boundDocumentMove=this.touchMove.bind(this)):
(this.documentDownEvent="mousedown",this.documentMoveEvent="mousemove",this.documentUpEvent="mouseup",this.documentCancelEvent=null,this.boundDocumentDown=this.mouseDown.bind(this),this.boundDocumentUp=this.mouseUp.bind(this),this.boundDocumentMove=this.mouseMove.bind(this));b.addEventListener(this.documentDownEvent,this.boundDocumentDown);this.documentTarget.addEventListener(this.documentMoveEvent,this.boundDocumentMove,{capture:!0,passive:!1});this.documentTarget.addEventListener(this.documentUpEvent,
this.boundDocumentUp,!0);this.documentCancelEvent&&this.documentTarget.addEventListener(this.documentCancelEvent,this.boundDocumentUp,!0);this.captured=!1;this.pointerId=-1}a.prototype.destroy=function(){this.element&&(this.boundDocumentDown&&this.element.removeEventListener(this.documentDownEvent,this.boundDocumentDown),this.elementHasExtraTouchStartHandler&&this.element.removeEventListener("touchstart",cancelEvent));this.documentTarget&&(this.boundDocumentUp&&(this.documentTarget.removeEventListener(this.documentUpEvent,
this.boundDocumentUp,!0),this.documentCancelEvent&&this.documentTarget.removeEventListener(this.documentCancelEvent,this.boundDocumentUp,!0)),this.boundDocumentMove&&this.documentTarget.removeEventListener(this.documentMoveEvent,this.boundDocumentMove,!0));this.mouseUp(null);zeroObject(this)};a.prototype.pointerDown=function(b){if(0<=this.pointerId&&"mouse"!==b.pointerType)return cancelEvent(b);var c=this.mouseDown(b);this.captured&&(this.pointerId=b.pointerId);return c};a.prototype.pointerMove=function(b){if(this.captured&&
b.pointerId===this.pointerId)return this.mouseMove(b)};a.prototype.pointerUp=function(b){if(this.captured&&b.pointerId===this.pointerId)return this.pointerId=-1,this.mouseUp(b)};a.prototype.touchStart=function(b){if(!(1<b.touches.length))return 0<=this.pointerId&&this.touchEnd(b),this.pointerId=1,b.clientX=b.touches[0].clientX,b.clientY=b.touches[0].clientY,b=this.mouseDown(b),void 0===b&&(this.pointerId=-1),b};a.prototype.touchMove=function(b){if(this.captured&&!(1<b.touches.length))return b.clientX=
b.touches[0].clientX,b.clientY=b.touches[0].clientY,this.mouseMove(b)};a.prototype.touchEnd=function(b){if(this.captured&&!(0>this.pointerId))return this.pointerId=-1,this.mouseUp(b)};a.prototype.mouseDown=function(b){this.mouseUp(b);if(!(b.button||View.fading||b.target&&b.target!==this.element)){if(this.downCallback&&!this.downCallback(b))return cancelEvent(b);this.captured=!0;return cancelEvent(b)}};a.prototype.mouseMove=function(b){if(this.captured)return this.moveCallback&&this.moveCallback(b),
cancelEvent(b)};a.prototype.mouseUp=function(b){if(this.captured)return this.captured=!1,this.upCallback&&this.upCallback(b),cancelEvent(b)};return a}(),ScrollContainer=function(){function a(b,c,e,d){void 0===c&&(c=!1);void 0===e&&(e=null);void 0===d&&(d=null);d?(this.parent=d.parentNode,this.container=d):(this.parent=b,this.container=document.createElement("div"),b.appendChild(this.container));this.container.className=c?"container":"container scrollable-container";c||(this.parent.style.overflow=
"hidden");this.scrollContainer=document.createElement("div");this.scrollContainer.className=e?"scroll-container "+e:"scroll-container";this.container.appendChild(this.scrollContainer);this.scrollThumb=UISpriteSheet.create(UISpriteSheet.ScrollThumb,this.parent);this.scrollThumb.className="scroll-thumb";this.containerPointerHandler=this.pointerHandler=null;this.boundDocumentWheel=this.documentWheel.bind(this);this.scrollThumbInitialTopCss=this.scrollThumbTopCss=this.scrollThumbTopPercent=this.scrollContainerTopCss=
this.contentHeight=this.availableHeight=this.containerTopCss=this.pointerLastY=0;this.scrollThumbOnly=c;this.ignoreScroll=!1;c||(this.container.onscroll=this.containerScroll.bind(this))}Object.defineProperty(a.prototype,"topCss",{get:function(){return this.scrollContainerTopCss},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"element",{get:function(){return this.container},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"containerElement",{get:function(){return this.scrollContainer},
enumerable:!1,configurable:!0});a.prototype.resize=function(b,c){this.containerTopCss=cssNumber(b);this.availableHeight=c;1>this.availableHeight&&(this.availableHeight=1);this.container.style.top=css(b);this.container.style.height=css(c);UISpriteSheet.resize(this.scrollThumb);b=this.scrollContainer.getBoundingClientRect();this.contentHeight=model(b.bottom-b.top);1>this.contentHeight&&(this.contentHeight=1);b=this.contentHeight<=this.availableHeight?"none":"";this.scrollThumb.style.display!==b&&(this.scrollThumb.style.display=
b);this.scrollTo(this.scrollThumbTopPercent)};a.prototype.attach=function(){this.pointerHandler=new PointerHandler(this.scrollThumb,this.mouseDown.bind(this),this.mouseMove.bind(this));document.addEventListener("wheel",this.boundDocumentWheel,{capture:!0,passive:!1})};a.prototype.detach=function(){this.pointerHandler&&(this.pointerHandler.destroy(),this.pointerHandler=null);document.removeEventListener("wheel",this.boundDocumentWheel,!0)};a.prototype.adjustScrollUI=function(b,c){void 0===c&&(c=-1);
this.contentHeight<=this.availableHeight||0>=b?c=b=0:(1<b&&(b=1),0>c&&(c=cssNumber(b*(this.availableHeight-scrollThumbHeight))));this.scrollThumbTopPercent=b;this.scrollThumbTopCss=c;this.scrollThumb.style.top=this.containerTopCss+c+"px";this.scrollContainerTopCss=this.contentHeight<=this.availableHeight?0:cssNumber(-this.scrollThumbTopPercent*(this.contentHeight-this.availableHeight))};a.prototype.scrollTo=function(b,c){void 0===c&&(c=-1);this.adjustScrollUI(b,c);this.scrollThumbOnly?this.scrollContainer.style.marginTop=
this.scrollContainerTopCss+"px":(this.ignoreScroll=!0,this.container.scrollTop=-this.scrollContainerTopCss)};a.prototype.mouseDown=function(b){var c=this.container.getBoundingClientRect();this.pointerLastY=b.clientY-c.top;this.scrollThumbInitialTopCss=this.scrollThumbTopCss;return!0};a.prototype.mouseMove=function(b){var c=this.container.getBoundingClientRect();b=this.scrollThumbInitialTopCss+(b.clientY-c.top-this.pointerLastY);b=0>b?0:model(b)+scrollThumbHeight>this.availableHeight?cssNumber(this.availableHeight-
scrollThumbHeight):(b*pixelRatio|0)/pixelRatio;b!==this.scrollThumbTopCss&&this.scrollTo(model(b)/(this.availableHeight-scrollThumbHeight),b)};a.prototype.documentWheel=function(b){return Modal.visible?!1:(0>b.deltaY?this.scrollTo(this.scrollThumbTopPercent-.1):0<b.deltaY&&this.scrollTo(this.scrollThumbTopPercent+.1),cancelEvent(b))};a.prototype.containerScroll=function(b){this.ignoreScroll?this.ignoreScroll=!1:(b=this.contentHeight-this.availableHeight,this.adjustScrollUI(0>=b||!this.availableHeight?
0:model(this.container.scrollTop)/b))};return a}(),Modal=function(){function a(b){var c=this;this.options=b;this.containerElement=document.createElement("div");this.containerElement.className="base-element modal-container";this.modalElement=document.createElement("form");this.modalElement.className="modal";this.modalElement.onsubmit=this.submit.bind(this);this.modalHeaderElement=document.createElement("div");this.modalHeaderElement.className="modal-decoration";this.modalHeaderElement.innerHTML=b.title||
Strings.Oops;this.modalBodyElement=document.createElement("div");this.modalBodyElement.className="modal-body";"string"===typeof b.html?this.modalBodyElement.innerHTML=b.html:this.modalBodyElement.appendChild(b.html);var e=this.modalBodyElement.getElementsByTagName("button");if(e&&e.length)for(var d=function(l){var k=e[l];prepareButtonBlink(k,!0,function(){if(c.fading)return!1;if(c.options.onbuttonclick)c.options.onbuttonclick(k.id,k);return!0})},f=e.length-1;0<=f;f--)d(f);if((d=this.modalBodyElement.getElementsByTagName("span"))&&
d.length)for(f=d.length-1;0<=f;f--){var g=d[f];g.getAttribute(UISpriteSheet.SheetId)&&UISpriteSheet.finishHTMLCreation(g)}this.modalFooterElement=document.createElement("div");this.modalFooterElement.className="modal-decoration";this.defaultSubmitButton=this.defaultCancelButton=null;d=function(l){var k=b.buttons[l],m=document.createElement("button");k.defaultCancel&&(h.defaultCancelButton=m);k.defaultSubmit&&(h.defaultSubmitButton=m);m.style.height=buttonHeightCss;m.style.borderWidth=borderWidthCss;
k.className&&(m.className=k.className);l&&(m.style.float="right");m.setAttribute("type","button");UISpriteSheet.create(k.iconId,m);m.appendChild(document.createTextNode(k.text));prepareButtonBlink(m,!0,function(){if(c.fading)return!1;if(k.onclick)k.onclick(k.id,m);if(c.options.onbuttonclick)c.options.onbuttonclick(k.id,m);return!0});h.modalFooterElement.appendChild(m)};var h=this;for(f=0;f<b.buttons.length;f++)d(f);this.modalElement.appendChild(this.modalHeaderElement);this.modalElement.appendChild(this.modalBodyElement);
this.modalElement.appendChild(this.modalFooterElement);this.containerElement.appendChild(this.modalElement);View.main.appendChild(this.containerElement);this.boundDocumentKeyDown=this.documentKeyDown.bind(this);document.addEventListener("keydown",this.boundDocumentKeyDown,!0);this.fading=!0;setTimeout(function(){if(b.onshowing)b.onshowing();c.resizeInternal();c.containerElement.classList.add("visible");setTimeout(function(){c.fading=!1;View.pushHistoryStateIfNecessary();if(c.options.onshown)c.options.onshown()},
520)},50)}Object.defineProperty(a,"visible",{get:function(){return!!a.modal},enumerable:!1,configurable:!0});Object.defineProperty(a,"currentModalElement",{get:function(){return a.modal?a.modal.modalElement:null},enumerable:!1,configurable:!0});Object.defineProperty(a,"currentModalHeaderElement",{get:function(){return a.modal?a.modal.modalHeaderElement:null},enumerable:!1,configurable:!0});Object.defineProperty(a,"currentModalBodyElement",{get:function(){return a.modal?a.modal.modalBodyElement:null},
enumerable:!1,configurable:!0});Object.defineProperty(a,"currentModalFooterElement",{get:function(){return a.modal?a.modal.modalFooterElement:null},enumerable:!1,configurable:!0});a.show=function(b){if(a.modal)return!1;b.okcancel?b.buttons=[{id:"cancel",defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Cancel,onclick:b.oncancel||a.hide},{id:"ok",defaultSubmit:b.okcancelsubmit,iconId:UISpriteSheet.AcceptGreen,text:Strings.OK,className:"accept",onclick:b.onok||a.hide}]:b.buttons&&b.buttons.length||
(b.buttons=[{id:"cancel",defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Close,onclick:a.hide}]);a.modal=new a(b);return!0};a.hide=function(){a.modal&&a.modal.hideInternal()};a.defaultCancelAction=function(){a.modal&&a.modal.defaultCancelActionInternal()};a.windowResized=function(){a.modal&&a.modal.resizeInternal()};a.prototype.hideInternal=function(){var b=this;a.modal!==this||this.fading||this.options.onhiding&&!1===this.options.onhiding()||(document.removeEventListener("keydown",this.boundDocumentKeyDown,
!0),this.fading=!0,this.containerElement.classList.remove("visible"),setTimeout(function(){a.modal=null;View.popHistoryStateIfNecessary();if(b.options.onhidden)b.options.onhidden();View.main.removeChild(b.containerElement);for(var c=b.options.buttons.length-1;0<=c;c--)zeroObject(b.options.buttons[c]);zeroObject(b.options);zeroObject(b)},520))};a.prototype.documentKeyDown=function(b){"Escape"!==b.key&&27!==b.keyCode||this.defaultCancelActionInternal()};a.prototype.defaultCancelActionInternal=function(){this.defaultCancelButton&&
this.defaultCancelButton.click()};a.prototype.submit=function(b){cancelEvent(b);this.defaultSubmitButton&&this.defaultSubmitButton.click();return!1};a.prototype.resizeInternal=function(){if(a.modal===this){this.modalElement.style.fontSize=fontSizeCss;this.modalElement.style.maxWidth=css(this.options.large?baseWidth:baseWidth>>1);this.modalElement.style.margin=this.options.large?"0":iconSizeCss+" auto";this.modalHeaderElement.style.padding=buttonPaddingCss;this.modalBodyElement.style.padding=iconSizeCss+
" "+buttonPaddingCss;this.modalBodyElement.style.lineHeight=iconSizeCss;this.modalFooterElement.style.padding=buttonPaddingCss;var b=this.modalElement.querySelectorAll("[data-style]");if(b&&b.length)for(var c=b.length-1;0<=c;c--)for(var e=b[c],d=e.getAttribute("data-style").split(";"),f=0;f<d.length;f++){var g=d[f],h=g.indexOf(":");0<=h&&(e.style[g.substr(0,h)]=css(parseInt(g.substr(h+1))))}if((b=this.modalElement.getElementsByTagName("input"))&&b.length)for(e=css(2),c=b.length-1;0<=c;c--)d=b[c],
d.style.borderWidth=borderWidthCss,d.style.padding=e,d.style.marginTop=e;if((b=this.modalElement.getElementsByTagName("button"))&&b.length)for(c=b.length-1;0<=c;c--)e=b[c],e.style.height=buttonHeightCss,e.style.borderWidth=borderWidthCss,e.style.fontSize=fontSizeCss,e.style.lineHeight=iconSizeCss,e.style.paddingLeft=buttonPaddingCss,e.style.paddingRight=buttonPaddingCss;if((b=this.modalElement.getElementsByTagName("span"))&&b.length)for(c=b.length-1;0<=c;c--)e=b[c],e.getAttribute(UISpriteSheet.SheetId)&&
(UISpriteSheet.resize(e),"BUTTON"===e.parentNode.tagName&&(e.style.marginRight=buttonMarginCss));if(this.options.onresized)this.options.onresized()}};a.modal=null;return a}(),View=function(){function a(){var b=this;this.destroy=function(c){return __awaiter(b,void 0,void 0,function(){var e;return __generator(this,function(d){switch(d.label){case 0:if(!this.initialElements)return[3,3];if(!this.attached)return[3,2];for(e=a.main.childNodes.length-1;3<=e;e--)a.main.removeChild(a.main.childNodes[e]);this.attached=
!1;return[4,this.detach()];case 1:d.sent(),d.label=2;case 2:this.destroyInternal(c),c||zeroObject(this),d.label=3;case 3:return[2]}})})};this.buttons=[];this.buttonsWithMargin=[];this.buttonsWithLargeMargin=[];this.buttonImages=[];this.initialElements=[];this.attached=!1}a.drawBackground=function(b,c,e,d){var f=a.gl;if(!f.checkForLostContextUseFrameBufferAndClear(d))return a.recreateResourcesTimeout||(a.recreateResourcesTimeout=setTimeout(a.recreateResourcesFromTimeout,1E3)),!1;f.prepareNativeDraw(a.sheetTexture);
d?(cLib._renderBackground(f.verticesPtr,c,LevelSpriteSheet.LevelSpriteSheetPtr,baseHeight,b,e),f.useFramebuffer(!1),f.draw(f.framebufferTexture,LevelSpriteSheet.FullViewModelCoordinates,1,LevelSpriteSheet.FramebufferTextureCoordinates,0,0),f.flush()):cLib._renderCompactBackground(f.verticesPtr,c,LevelSpriteSheet.LevelSpriteSheetPtr,b);return!0};a.recreateResourcesFromTimeout=function(){a.recreateResourcesTimeout&&(a.recreateResourcesTimeout=0,a.recreateResources())};a.recreateResources=function(){a.recreateResourcesTimeout&&
(clearTimeout(a.recreateResourcesTimeout),a.recreateResourcesTimeout=0);var b=a.currentView,c=b&&b.usesGL;c&&b.releaseResources();a.sheetTexture.release();a.backgroundFrameRequest&&(cancelAnimationFrame(a.backgroundFrameRequest),a.backgroundFrameRequest=0);try{a.gl.recreate(a.glCanvas,baseWidth>>LevelSpriteSheet.BackgroundScaleRightShift,baseHeight>>LevelSpriteSheet.BackgroundScaleRightShift),a.sheetTexture.load()}catch(e){throw a.recreateResourcesTimeout=setTimeout(a.recreateResourcesFromTimeout,
500),e;}c?b.loadResources():a.backgroundFrameRequest=requestAnimationFrame(a.renderBackground)};a.renderBackground=function(b){var c=!a.currentView||!a.currentView.pausedBackground;a.backgroundFrameRequest=c?requestAnimationFrame(a.renderBackground):0;!a.drawBackground(b,0,c,!0)&&a.backgroundFrameRequest&&(cancelAnimationFrame(a.backgroundFrameRequest),a.backgroundFrameRequest=0)};Object.defineProperty(a,"loading",{get:function(){return a._loading},set:function(b){a._loading!==b&&((a._loading=b)?
(a.divLoading||(a.divLoading=document.createElement("div"),a.divLoading.style.display="none",a.resizeLoading(),document.body.appendChild(a.divLoading)),a.divLoadingTimeout&&clearTimeout(a.divLoadingTimeout),a.divLoadingTimeout=setTimeout(function(){a.divLoadingTimeout=0;a.divLoading.style.display="";a.divLoading.className="loading"},100)):a.divLoading&&(a.divLoadingTimeout&&(clearTimeout(a.divLoadingTimeout),a.divLoadingTimeout=0),document.body.removeChild(a.divLoading),a.divLoading=null))},enumerable:!1,
configurable:!0});Object.defineProperty(a,"fading",{get:function(){return a._fading},enumerable:!1,configurable:!0});a.initGL=function(){a.gl=new WebGL;a.sheetTexture=LevelSpriteSheet.createTexture(a.gl);window.drawNative=function(b){a.gl.drawNative(b)}};a.createInitialView=function(){return a.currentView||a._loading||a._fading||a.viewStack.length?null:(new TitleView).fadeIn()};a.resizeLoading=function(){a.divLoading&&(a.divLoading.style.backgroundSize=css(43)+" "+css(11),a.divLoading.style.width=
css(43+iconSize),a.divLoading.style.height=css(11+iconSize))};a.windowResized=function(b){if(8>baseLeftCss){if(!a.fadeLeft.style.backgroundColor){var c=androidWrapper||isPWA?"#99f":"#000";a.fadeLeft.style.backgroundColor=c;a.fadeRight.style.backgroundColor=c;a.fadeLeft.style.backgroundImage="none";a.fadeRight.style.backgroundImage="none"}}else a.fadeLeft.style.backgroundColor&&(a.fadeLeft.style.backgroundColor="",a.fadeRight.style.backgroundColor="",a.fadeLeft.style.backgroundImage="",a.fadeRight.style.backgroundImage=
"");b&&(a.resizeLoading(),baseTopCss?a.fadeLeft.style.display||(a.fadeLeft.style.display="none",a.fadeRight.style.display="none"):a.fadeLeft.style.display&&(a.fadeLeft.style.display="",a.fadeRight.style.display=""),a.glCanvas.width=baseWidth*scaleFactor,a.glCanvas.height=baseHeight*scaleFactor,a.glCanvas.style.width=baseWidthCss+"px",a.glCanvas.style.height=baseHeightCss+"px",a.gl.checkRecreate(a.glCanvas)&&a.recreateResources(),a.currentView&&a.currentView.resize())};a.windowHistoryStatePopped=function(b){a.windowHistoryStatePushed=
!1;a.pushHistoryStateIfNecessary();Modal.visible&&Modal.defaultCancelAction()};a.pushHistoryStateIfNecessary=function(){a.windowHistoryStatePushed||a.currentView&&a.currentView instanceof TitleView&&!a._fading&&!Modal.visible||(a.windowHistoryStatePushed=!0,window.history.state&&window.history.state.pixelMaze||window.history.pushState({pixelMaze:!0},"Pixel Maze"))};a.popHistoryStateIfNecessary=function(){a.windowHistoryStatePushed&&window.history.back()};Object.defineProperty(a.prototype,"usesGL",
{get:function(){return!1},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"pausedBackground",{get:function(){return!1},enumerable:!1,configurable:!0});a.prototype.releaseResources=function(){};a.prototype.loadResources=function(){};a.prototype.resize=function(){for(var b=this.buttons.length-1;0<=b;b--){var c=this.buttons[b];c.style.width=buttonHeightCss;c.style.height=buttonHeightCss;c.style.fontSize=fontSizeCss;c.style.lineHeight=iconSizeCss}for(b=this.buttonImages.length-1;0<=
b;b--)UISpriteSheet.resize(this.buttonImages[b]);for(b=this.buttonsWithMargin.length-1;0<=b;b--)this.buttonsWithMargin[b].style.marginLeft=buttonMarginCss;for(b=this.buttonsWithLargeMargin.length-1;0<=b;b--)this.buttonsWithLargeMargin[b].style.marginLeft=buttonLargeMarginCss};a.prototype.fadeInFinished=function(){};a.prototype.createButton=function(b,c,e){for(var d=[],f=3;f<arguments.length;f++)d[f-3]=arguments[f];f=document.createElement("button");var g=UISpriteSheet.create(c,f);f.setAttribute("type",
"button");prepareButtonBlink(f,!1,e);b&&b.appendChild(f);this.buttons.push(f);this.buttonImages.push(g);if(d)for(g=0;g<d.length;g+=2)f.setAttribute(d[g],d[g+1]);return f};a.prototype.finishFadeIn=function(b){var c=this;setTimeout(function(){c.resize();a.backgroundFrameRequest&&(cancelAnimationFrame(a.backgroundFrameRequest),a.backgroundFrameRequest=0);a.gl.clearColor(1,1,1,1);c.usesGL?c.loadResources():a.backgroundFrameRequest=requestAnimationFrame(a.renderBackground);a.cover.classList.remove("visible");
setTimeout(function(){a._fading=!1;a.popHistoryStateIfNecessary();document.body.removeChild(a.cover);c.fadeInFinished();b()},520)},50)};a.prototype.fadeIn=function(){return __awaiter(this,void 0,void 0,function(){var b=this;return __generator(this,function(c){if(a._fading||a.currentView===this)return[2,null];a._fading=!0;a.currentView=this;return[2,new Promise(function(e,d){if((d=b.initialElements)&&!b.attached){for(var f=0;f<d.length;f++){var g=d[f];g&&a.main.appendChild(g)}b.attached=!0;if(d=b.attach()){d.then(function(){b.finishFadeIn(e)},
function(h){console.error(h)});return}}b.finishFadeIn(e)})]})})};a.prototype.fadeOut=function(b){return __awaiter(this,void 0,void 0,function(){var c=this;return __generator(this,function(e){if(a._fading||a.currentView!==this)return[2,null];a._fading=!0;a.backgroundFrameRequest&&(cancelAnimationFrame(a.backgroundFrameRequest),a.backgroundFrameRequest=0);return[2,new Promise(function(d,f){document.body.appendChild(a.cover);setTimeout(function(){a.cover.classList.add("visible");setTimeout(function(){return __awaiter(c,
void 0,void 0,function(){return __generator(this,function(g){switch(g.label){case 0:return[4,this.destroy(b)];case 1:return g.sent(),b&&a.viewStack.push(this),a.currentView=null,a._fading=!1,a.pushHistoryStateIfNecessary(),d(),[2]}})})},520)},50)})]})})};a.prototype.fadeTo=function(b,c){void 0===c&&(c=!1);return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return a._fading||a.currentView!==this?[2,null]:[4,this.fadeOut(c)];case 1:return e.sent(),
[2,("string"===typeof b?new viewClasses[b]:b).fadeIn()]}})})};a.prototype.fadeToPrevious=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(b){switch(b.label){case 0:return a._fading||a.currentView!==this||!a.viewStack.length?[2,null]:[4,this.fadeOut(!1)];case 1:return b.sent(),[2,a.viewStack.pop().fadeIn()]}})})};a.main=document.getElementById("main");a.fadeLeft=document.getElementById("fadeLeft");a.fadeRight=document.getElementById("fadeRight");a.glCanvas=
document.getElementById("glCanvas");a.cover=document.getElementById("cover");a._loading=!1;a._fading=!1;a.currentView=null;a.viewStack=[];a.divLoading=null;a.divLoadingTimeout=0;a.windowHistoryStatePushed=!1;a.gl=null;a.sheetTexture=null;a.backgroundFrameRequest=0;a.recreateResourcesTimeout=0;return a}(),EditorView=function(a){function b(c,e){var d=a.call(this)||this;d.baseElement=document.createElement("div");d.baseElement.className="base-element fixed-bg";d.baseElement.innerHTML='\n\t\t<div class="hidden-container"><input id="fileInput" type="file" accept="image/*" tabindex="-1" /></div>\n\t\t<div id="toolbarTop" class="toolbar toolbar-top"></div>\n\t\t<div id="container"></div>\n\t\t<div id="toolbarBottom" class="toolbar toolbar-bottom"></div>\n\t\t';
d.initialElements.push(d.baseElement);d.fileInput=d.baseElement.querySelector("#fileInput");d.toolbarTop=d.baseElement.querySelector("#toolbarTop");d.toolbarBottom=d.baseElement.querySelector("#toolbarBottom");d.scrollContainer=new ScrollContainer(null,!0,"scroll-container-editor",d.baseElement.querySelector("#container"));d.setGridBackground();d.canvas=document.createElement("canvas");d.canvas.className="transform-top-left";d.canvas.width=baseWidth;d.canvas.height=maxHeight;d.scrollContainer.containerElement.appendChild(d.canvas);
d.pointerCursor=document.createElement("div");d.pointerCursor.className="pointer-cursor";var f=d.toolbarTop,g=d.toolbarBottom;d.createButton(f,UISpriteSheet.Back,d.back.bind(d)).style.float="left";d.firstPencilButtonIndex=d.buttons.length;for(var h=d.changeToolPencil.bind(d),l=0;l<colors.length-1;l++)d.createButton(f,UISpriteSheet.Border,h,"data-i",l.toString()).firstChild.style.backgroundColor=colorsCss[l];d.createButton(f,UISpriteSheet.Rainbow,h,"data-i",(colors.length-1).toString());d.createButton(f,
UISpriteSheet.Eraser,d.changeToolEraser.bind(d));d.firstLineWidthButtonIndex=d.buttons.length;f=d.changeBrushWidth.bind(d);d.createButton(g,UISpriteSheet.LineWidth0,f,"data-i","0");d.createButton(g,UISpriteSheet.LineWidth1,f,"data-i","1");d.createButton(g,UISpriteSheet.LineWidth2,f,"data-i","2");d.createButton(g,UISpriteSheet.LineWidth3,f,"data-i","3");d.firstObjectToolButtonIndex=d.buttons.length;for(l=LevelObject.TypeBall;l<=LevelObject.LastType;l++)d.createButton(g,LevelObject.ImagesByType[l],
d.changeTool.bind(d),"data-tool",(b.ToolBall+l-LevelObject.TypeBall).toString());d.buttonsWithLargeMargin.push(d.buttons[d.firstObjectToolButtonIndex]);d.createButton(g,UISpriteSheet.Eraser,d.changeTool.bind(d),"data-tool",b.ToolDeleteObject.toString());d.buttonsWithLargeMargin.push(d.createButton(g,UISpriteSheet.Open,d.open.bind(d)));d.createButton(g,UISpriteSheet.Download,d.download.bind(d));d.createButton(g,UISpriteSheet.Clear,d.clear.bind(d));LevelCache.isSupported()&&(d.createButton(g,UISpriteSheet.Accept,
d.accept.bind(d)).style.float="right");d.createButton(g,UISpriteSheet.Play,d.play.bind(d)).style.float="right";d.fileInput.onchange=d.openFile.bind(d);d.selectionView=!!e;d.boundDocumentKeyUp=androidWrapper||isPWA?null:d.documentKeyUp.bind(d);d.tool=b.ToolPencil;d.dirty=!1;d.context=null;d.contextGlobalCompositeOperation="source-over";d.lastPencilColor=0;d.lastPencilRainbowIndex=0;d.lastBrushWidth=0;d.lastObjectType=LevelObject.TypeBall;d.brushCanvas=null;d.brushContext=null;d.loadOptions=c||null;
d.level=null;d.levelBallCount=0;d.pointerHandler=null;d.pointerLastX=0;d.pointerLastY=0;d.pointerCursorAttached=!1;d.objectImages=[];d.objectImageDrag=null;d.objectImageDragOffsetXCss=0;d.objectImageDragOffsetYCss=0;d.keyUpTime=0;d.keyUpCounter=0;d.highlightTool();return d}__extends(b,a);b.prototype.setGridBackground=function(){this.scrollContainer.containerElement.style.backgroundImage="url('assets/images/grid"+(5>=scaleFactor?scaleFactor:1)+".png')"};Object.defineProperty(b.prototype,"pausedBackground",
{get:function(){return!0},enumerable:!1,configurable:!0});b.prototype.resize=function(){var c=css(63),e=css(baseWidth),d=css(maxHeight),f=css(b.BrushWidths[this.lastBrushWidth]);this.toolbarTop.style.height=toolbarAvailableHeightCss;this.toolbarTop.style.borderBottomWidth=borderWidthCss;this.toolbarBottom.style.height=toolbarAvailableHeightCss;this.toolbarBottom.style.borderTopWidth=borderWidthCss;isIOSOrSafari?(this.canvas.style.width=e,this.canvas.style.height=d):(this.canvas.style.width=baseWidth/
pixelRatio+"px",this.canvas.style.height=maxHeight/pixelRatio+"px",applyCSSTransform(this.canvas,"scale("+scaleFactor+", "+scaleFactor+")"),this.scrollContainer.containerElement.style.height=d);this.setGridBackground();this.scrollContainer.containerElement.style.backgroundSize=c+" "+c;this.scrollContainer.resize(toolbarTotalHeight,baseHeight-(toolbarTotalHeight<<1));this.pointerCursor.style.borderWidth=borderWidthCss;this.pointerCursor.style.width=f;this.pointerCursor.style.height=f;c=this.level.objects;
for(e=c.length-1;0<=e;e--)d=c[e],f=this.objectImages[e],f.style.left=css(d.x-iconRadius),f.style.top=css(d.y-iconRadius),UISpriteSheet.resize(f);a.prototype.resize.call(this)};b.prototype.attach=function(){return __awaiter(this,void 0,void 0,function(){var c,e,d,f,g,h,l;return __generator(this,function(k){switch(k.label){case 0:View.glCanvas.style.display="none";if(this.level)return[3,2];c=this;return[4,LevelCache.loadLevelFromOptions(this.loadOptions)];case 1:c.level=k.sent();this.loadOptions&&(this.loadOptions.levelNameOverride&&
(this.level.name=this.loadOptions.levelNameOverride),this.loadOptions=null);e=this.level.objects;d=e.length;for(f=0;f<d;f++)this.addObject(e[f],!0);k.label=2;case 2:return this.pointerHandler=new PointerHandler(this.canvas,this.mouseDown.bind(this),this.mouseMove.bind(this),this.mouseUp.bind(this)),this.scrollContainer.attach(),[4,loadImage(b.brushesImageDataBase64)];case 3:g=k.sent();this.brushCanvas=document.createElement("canvas");this.brushCanvas.width=g.width;this.brushCanvas.height=g.height;
this.brushContext=this.brushCanvas.getContext("2d",{alpha:!0});this.brushContext.drawImage(g,0,0);this.updateBrushColor(colors[this.lastPencilColor]);this.context=this.canvas.getContext("2d",{alpha:!0});this.context.globalCompositeOperation="source-over";this.context.clearRect(0,0,baseWidth,maxHeight);setContextQuality(this.context,!1);if(!this.level.image)return[3,5];l=(h=this.context).drawImage;return[4,loadImage(this.level.image)];case 4:l.apply(h,[k.sent(),0,0]),k.label=5;case 5:return this.context.globalCompositeOperation=
this.contextGlobalCompositeOperation,this.boundDocumentKeyUp&&document.addEventListener("keyup",this.boundDocumentKeyUp,!0),[2]}})})};b.prototype.detach=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(c){View.glCanvas.style.display="";this.pointerHandler&&(this.pointerHandler.destroy(),this.pointerHandler=null);this.scrollContainer.detach();this.brushContext=this.brushCanvas=this.context=null;this.boundDocumentKeyUp&&document.removeEventListener("keyup",
this.boundDocumentKeyUp,!0);return[2]})})};b.prototype.destroyInternal=function(c){this.save()};b.prototype.save=function(){if(this.dirty||!this.level.image)this.level.modifiedAt=(new Date).getTime(),this.level.createdAt||(this.level.createdAt=this.level.modifiedAt),this.level.thumbnailImage="",this.level.image=this.canvas.toDataURL("image/png"),this.level.processedImage="",this.level.polygons=[],LevelCache.saveEditorLevel(this.level),this.dirty=!1};b.prototype.updatePointerCursor=function(c,e){var d=
cssNumber(.5*b.BrushWidths[this.lastBrushWidth]+1);this.pointerCursor.style.left=c-d+"px";this.pointerCursor.style.top=e-d+this.scrollContainer.topCss+"px"};b.prototype.mouseDown=function(c){if(View.loading)return!1;var e=this.scrollContainer.containerElement.getBoundingClientRect(),d=c.clientX-e.left;c=c.clientY-e.top;this.dirty=!0;switch(this.tool){case b.ToolPencil:case b.ToolEraser:this.pointerCursorAttached||(this.pointerCursorAttached=!0,this.updatePointerCursor(d,c),this.scrollContainer.element.appendChild(this.pointerCursor));
this.draw((this.pointerLastX=model(d)-1)+1,this.pointerLastY=model(c));break;default:this.handleObjectToolDown(d,c)}return!0};b.prototype.mouseMove=function(c){var e=this.scrollContainer.containerElement.getBoundingClientRect(),d=c.clientX-e.left;c=c.clientY-e.top;switch(this.tool){case b.ToolPencil:case b.ToolEraser:e=model(d);var f=model(c);if(this.pointerLastX!==e||this.pointerLastY!==f)this.updatePointerCursor(d,c),this.draw(e,f),this.pointerLastX=e,this.pointerLastY=f;break;default:this.handleObjectToolMove(d,
c)}};b.prototype.mouseUp=function(c){this.objectImageDrag=null;this.pointerCursorAttached&&(this.pointerCursorAttached=!1,this.scrollContainer.element.removeChild(this.pointerCursor));switch(this.tool){case b.ToolPencil:case b.ToolEraser:return}c=this.level.objects;var e=this.objectImages;e.sort(function(h,l){h=h.object;l=l.object;return h.type-l.type||l.y-h.y});for(var d=e.length-1,f=1;0<=d;d--,f++){var g=e[d];g.style.zIndex=f.toString();c[d]=g.object}};b.prototype.draw=function(c,e){c-=this.pointerLastX;
e-=this.pointerLastY;var d=Math.abs(c),f=Math.abs(e);if(d||f){var g=b.BrushWidths[this.lastBrushWidth],h=g>>1,l=b.BrushOffsets[this.lastBrushWidth];d=Math.max(d,f);f=this.pointerLastX;var k=this.pointerLastY;c/=d;for(e/=d;0<d;)d--,f+=c,k+=e,d&1||(this.lastPencilColor===colors.length-1&&(this.lastPencilRainbowIndex++,this.lastPencilRainbowIndex>=rainbowColors.length&&(this.lastPencilRainbowIndex=0),this.updateBrushColor(rainbowColors[this.lastPencilRainbowIndex])),this.context.drawImage(this.brushCanvas,
l,0,g,g,(f|0)-h,(k|0)-h,g,g))}};b.prototype.handleObjectToolDown=function(c,e){var d=model(c),f=model(e);if(this.tool>=b.ToolBall&&this.tool<=b.ToolCucumber){this.objectImageDrag=this.findObjectWithinRadius(-1,d,f);if(!this.objectImageDrag&&(this.objectImageDrag=this.addObject(new LevelObject(this.lastObjectType,d,f),!1),!this.objectImageDrag))return;d=this.scrollContainer.containerElement.getBoundingClientRect();f=this.objectImageDrag.getBoundingClientRect();this.objectImageDragOffsetXCss=f.left-
d.left-c;this.objectImageDragOffsetYCss=f.top-d.top-e}else(c=this.findObjectWithinRadius(-1,d,f))&&this.removeObject(c)};b.prototype.handleObjectToolMove=function(c,e){if(this.tool>=b.ToolBall&&this.tool<=b.ToolCucumber&&this.objectImageDrag){var d=this.objectImageDrag.object;d&&(d.move(model(c+this.objectImageDragOffsetXCss)+iconRadius,model(e+this.objectImageDragOffsetYCss)+iconRadius),this.objectImageDrag.style.left=css(d.x-iconRadius),this.objectImageDrag.style.top=css(d.y-iconRadius))}};b.prototype.highlightTool=
function(){for(var c=this.firstPencilButtonIndex,e=c+(this.tool===b.ToolEraser?colors.length:this.lastPencilColor);c<e;c++)this.buttons[c].style.backgroundColor="";if(this.tool===b.ToolPencil||this.tool===b.ToolEraser)this.buttons[c++].style.backgroundColor="#fff";for(e=this.firstPencilButtonIndex+colors.length;c<=e;c++)this.buttons[c].style.backgroundColor="";c=this.firstLineWidthButtonIndex;for(e=c+this.lastBrushWidth;c<e;c++)this.buttons[c].style.backgroundColor="";if(this.tool===b.ToolPencil||
this.tool===b.ToolEraser)this.buttons[c++].style.backgroundColor="#fff";for(e=this.firstLineWidthButtonIndex+b.BrushWidths.length;c<e;c++)this.buttons[c].style.backgroundColor="";c=this.firstObjectToolButtonIndex;for(e=c+this.tool-b.FirstObjectTool;c<e;c++)this.buttons[c].style.backgroundColor="";this.tool>=b.FirstObjectTool&&(this.buttons[c++].style.backgroundColor="#fff");for(e=this.firstObjectToolButtonIndex+b.ObjectToolCount;c<e;c++)this.buttons[c].style.backgroundColor="";this.canvas.style.opacity=
this.tool===b.ToolDeleteObject?"0.25":""};b.prototype.updateBrushColor=function(c){for(var e=this.brushContext.getImageData(0,0,this.brushCanvas.width,this.brushCanvas.height),d=new Int32Array(e.data.buffer),f=d.length-1;0<=f;f--)d[f]&4278190080&&(d[f]=c);this.brushContext.putImageData(e,0,0)};b.prototype.clearImage=function(){this.dirty=!0;this.context.clearRect(0,0,baseWidth,maxHeight);this.level.clearImage();this.scrollContainer.scrollTo(0)};b.prototype.findObjectWithinRadius=function(c,e,d){for(var f=
this.level.objects,g=f.length,h=iconSize*iconSize,l=0;l<g;l++){var k=f[l];if(!(0<=c&&k.type!==c)){var m=e-k.x;k=d-k.y;m*=m;k*=k;if(h>=m+k)return this.objectImages[l]}}return null};b.prototype.addObject=function(c,e){if(!e){if(this.level.objects.length>=Level.MaxObjectCount)return Modal.show({html:Strings.TooManyObjects+UISpriteSheet.html(UISpriteSheet.Error)}),null;if(this.levelBallCount>=Level.MaxBallCount&&c.type==LevelObject.TypeBall)return Modal.show({html:Strings.TooManyBalls+UISpriteSheet.html(UISpriteSheet.Error)}),
null}var d=UISpriteSheet.create(LevelObject.ImagesByType[c.type]);d.style.position="absolute";d.style.zIndex=(e?this.level.objects.length-this.objectImages.length:1+this.objectImages.length).toString();d.style.left=css(c.x-iconRadius);d.style.top=css(c.y-iconRadius);d.style.pointerEvents="none";d.object=c;this.scrollContainer.containerElement.appendChild(d);this.objectImages.push(d);e||this.level.objects.push(c);c.type==LevelObject.TypeBall&&this.levelBallCount++;return d};b.prototype.removeObject=
function(c){if(c&&c.object)for(var e=this.objectImages,d=e.length-1;0<=d;d--)if(e[d]===c){this.scrollContainer.containerElement.removeChild(c);e.splice(d,1);this.level.objects[d].type===LevelObject.TypeBall&&this.levelBallCount--;this.level.objects.splice(d,1);break}};b.prototype.clearObjects=function(){this.dirty=!0;for(var c=this.scrollContainer.containerElement,e=this.objectImages,d=e.length-1;0<=d;d--)c.removeChild(e[d]);this.objectImages=[];this.level.clearObjects();this.levelBallCount=0;this.scrollContainer.scrollTo(0)};
b.prototype.back=function(c){return this.fadeTo(this.selectionView?"SelectionView":"TitleView")?!0:!1};b.prototype.changeToolPencil=function(c){this.tool=b.ToolPencil;this.lastPencilColor=parseInt(("IMG"===c.target.tagName?c.target.parentNode:c.target).getAttribute("data-i"));this.context.globalCompositeOperation=this.contextGlobalCompositeOperation="source-over";this.updateBrushColor(colors[this.lastPencilColor]);this.highlightTool();return!0};b.prototype.changeToolEraser=function(c){this.tool=b.ToolEraser;
this.context.globalCompositeOperation=this.contextGlobalCompositeOperation="destination-out";this.updateBrushColor(4294967295);this.highlightTool();return!0};b.prototype.changeBrushWidth=function(c){this.tool!==b.ToolPencil&&this.tool!==b.ToolEraser&&(this.tool="destination-out"==this.contextGlobalCompositeOperation?b.ToolEraser:b.ToolPencil);this.lastBrushWidth=parseInt(("IMG"===c.target.tagName?c.target.parentNode:c.target).getAttribute("data-i"));switch(this.tool){case b.ToolPencil:case b.ToolEraser:break;
default:this.tool=b.ToolPencil,this.context.globalCompositeOperation=this.contextGlobalCompositeOperation="source-over"}c=css(b.BrushWidths[this.lastBrushWidth]);this.pointerCursor.style.width=c;this.pointerCursor.style.height=c;this.highlightTool();return!0};b.prototype.changeTool=function(c){this.tool=parseInt(("IMG"===c.target.tagName?c.target.parentNode:c.target).getAttribute("data-tool"));this.tool>=b.ToolBall&&this.tool<=b.ToolCucumber&&(this.lastObjectType=LevelObject.TypeBall+this.tool-b.ToolBall);
this.highlightTool();return!0};b.prototype.openFile=function(c){var e=this;if(!Modal.visible&&this.fileInput.files&&this.fileInput.files[0])if(c=this.fileInput.files[0].name.toLowerCase(),c.endsWith(".png")||c.endsWith(".jpg")||c.endsWith(".jpeg")){View.loading=!0;var d=new FileReader;d.onload=function(){e.fileInput.value="";d.result?loadImage(d.result).then(function(f){e.clearImage();e.context.globalCompositeOperation="source-over";setContextQuality(e.context,!0);var g=f.width,h=f.height;if(g<=baseWidth&&
h<=maxHeight)e.context.drawImage(f,baseWidth-g>>1,0);else{var l=g,k=h;l>baseWidth&&(k*=baseWidth/l,l=baseWidth);k>maxHeight&&(l*=maxHeight/k,k=maxHeight);l|=0;e.context.drawImage(f,0,0,g,h,baseWidth-l>>1,0,l,k|0)}setContextQuality(e.context,!1);e.context.globalCompositeOperation=e.contextGlobalCompositeOperation},function(){Modal.show({html:Strings.ErrorLoadingImage+UISpriteSheet.html(UISpriteSheet.Error)})}):(View.loading=!1,Modal.show({html:Strings.EmptyImage+UISpriteSheet.html(UISpriteSheet.Error)}))};
d.onerror=function(){e.fileInput.value="";View.loading=!1;Modal.show({html:Strings.ErrorReadingImage+UISpriteSheet.html(UISpriteSheet.Error)})};d.readAsDataURL(this.fileInput.files[0])}else Modal.show({html:Strings.InvalidImage+UISpriteSheet.html(UISpriteSheet.Error)})};b.prototype.open=function(c){this.fileInput.click();return!0};b.prototype.download=function(c){LevelCache.downloadLevelImage(this.level.name,this.canvas).then(function(e){switch(e){case LevelCache.DownloadLevelSuccess:Modal.show({title:Strings.Success,
html:Strings.LevelImageDownloaded+UISpriteSheet.html(UISpriteSheet.Success)});break;case LevelCache.DownloadLevelError:Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)});break;case LevelCache.DownloadLevelNoPermission:Modal.show({html:Strings.TryToDownloadLevelImageAgain});break;case LevelCache.DownloadLevelFileAlreadyExists:Modal.show({html:Strings.LevelImageDownloadFailedFileExists+UISpriteSheet.html(UISpriteSheet.Error)})}},function(){Modal.show({html:Strings.SomethingWentWrong+
UISpriteSheet.html(UISpriteSheet.Error)})});return!0};b.prototype.clear=function(c){var e=this;Modal.show({html:Strings.ClearEntireLevel,buttons:[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Cancel,onclick:Modal.hide},{iconId:UISpriteSheet.ClearRed,text:Strings.Clear,className:"danger",onclick:function(){e.level.name="";e.level.createdAt=0;e.level.modifiedAt=0;e.clearImage();e.clearObjects();Modal.hide()}}]});return!0};b.prototype.accept=function(c){var e=this,d=!1,f=!1,g=!1;this.save();
Modal.show({title:Strings.SaveLevel,html:'<label for="name">'+Strings.LevelName+'</label><input id="name" spellcheck="false" autocomplete="off" />',okcancel:!0,okcancelsubmit:!0,onshowing:function(){document.getElementById("name").value=e.level.name},onshown:function(){document.getElementById("name").focus()},onok:function(){return __awaiter(e,void 0,void 0,function(){var h,l;return __generator(this,function(k){switch(k.label){case 0:h=document.getElementById("name").value.trim(),h?LevelCache.isNameValid(h)||
(f=!0,Modal.hide()):(l=new Date,h=l.getFullYear()+"-"+format2(l.getMonth()+1)+"-"+format2(l.getDate())+" "+format2(l.getHours())+format2(l.getMinutes())+format2(l.getSeconds())),h!==this.level.name&&(this.level.name=h,this.dirty=!0,this.save()),View.loading=!0,k.label=1;case 1:return k.trys.push([1,4,5,6]),[4,this.level.prepare()];case 2:return k.sent(),[4,LevelCache.saveLevel(this.level,!1)];case 3:return k.sent(),d=!0,[3,6];case 4:return k.sent(),g=!0,[3,6];case 5:return View.loading=!1,Modal.hide(),
[7];case 6:return[2]}})})},onhidden:function(){f?Modal.show({html:Strings.NameCannotContain+" \\ / ? * : < > % "+UISpriteSheet.html(UISpriteSheet.Error)}):g?Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)}):d&&Modal.show({title:Strings.Success,html:Strings.LevelSaved+UISpriteSheet.html(UISpriteSheet.Success)})}});return!0};b.prototype.play=function(c){var e=this;this.save();View.loading=!0;this.level.prepare().then(function(){View.loading=!1;e.fadeTo(new GameView({level:e.level},
!0),!0)},function(d){View.loading=!1;if(d&&d.message){if(d.message===Level.MaxPolygonCountMessage){Modal.show({html:Strings.TooManyPolygons+Level.MaxPolygonCount+" "+UISpriteSheet.html(UISpriteSheet.Error)});return}if(d.message===Level.MaxPointCountMessage){Modal.show({html:Strings.TooManyPoints+Level.MaxPointCount+" "+UISpriteSheet.html(UISpriteSheet.Error)});return}}Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)})});return!0};b.prototype.documentKeyUp=function(c){if(!View.loading&&
!Modal.visible)if("d"===c.key)this.keyUpTime=Date.now(),this.keyUpCounter=1;else switch(this.keyUpCounter){case 1:this.keyUpCounter="b"===c.key&&2E3>Date.now()-this.keyUpTime?2:0;break;case 2:if(2E3>Date.now()-this.keyUpTime)switch(c.key){case "g":confirm(Strings.YouWillLoseYourLevel)&&this.devDebug();break;case "s":this.devSave()}this.keyUpCounter=0}};b.prototype.devDebug=function(){processImage(this.canvas,this.context,!0)};b.prototype.devSave=function(){return __awaiter(this,void 0,void 0,function(){var c,
e,d,f=this;return __generator(this,function(g){switch(g.label){case 0:return this.level.name="0",this.save(),[4,this.level.prepare()];case 1:return g.sent(),c=document.createElement("a"),c.href=this.level.image,c.download="image.png",c.click(),e=document.createElement("a"),e.href=this.level.processedImage,e.download="processedImage.png",e.click(),d=document.createElement("a"),d.href=this.level.thumbnailImage,d.download="thumbnailImage.png",d.click(),Modal.show({html:'I <input id="inputImage" type="file" accept="image/png" />\n\t\t\tP <input id="inputProcessedImage" type="file" accept="image/png" />\n\t\t\tT <input id="inputThumbnailImage" type="file" accept="image/png" />',
okcancel:!0,onok:function(){var h=new FileReader;h.onload=function(){var l=new FileReader;l.onload=function(){var k=new FileReader;k.onload=function(){f.level.createdAt=0;f.level.modifiedAt=0;f.level.image=h.result;f.level.processedImage=l.result;f.level.thumbnailImage=null;console.log("'"+JSON.stringify(f.level)+"',");console.log("'"+k.result+"',");Modal.hide()};k.readAsDataURL(document.getElementById("inputThumbnailImage").files[0])};l.readAsDataURL(document.getElementById("inputProcessedImage").files[0])};
h.readAsDataURL(document.getElementById("inputImage").files[0])}}),[2]}})})};b.brushesImageDataBase64="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFUAAAAnAQAAAABWZDk9AAAAAnRSTlMAAQGU/a4AAACkSURBVChTrdExCsIwGIbhNxRMB7FrB8FrOAjtUXoERwfBHK29SY6QMUPoL8lfW0Rx8pue+f2YkhUjEoxEXKwSD3F0Ea4m0s3QRBgInBLYCD0DTQDzsgeKe+wI3HDj5qnYAWekGKB9t2dkl10jwWyOleewOFnPPhtEJHBcHbmsTtxXi0mb5V+es+rfluz2i5cOZdrn09pTrZ3V2l+tv6j1r8X5xycuusr5PaBWcwAAAABJRU5ErkJggg==";b.ToolPencil=0;b.ToolEraser=1;b.ToolBall=2;b.ToolGoal=3;b.ToolBomb=
4;b.ToolCucumber=5;b.ToolDeleteObject=6;b.FirstObjectTool=b.ToolBall;b.ObjectToolCount=5;b.BrushOffsets=[0,10,26,46];b.BrushWidths=[9,15,19,39];return b}(View),GameView=function(a){function b(c,e){var d=a.call(this)||this,f=d.createButton(null,UISpriteSheet.Back,d.back.bind(d));f.style.position="absolute";f.style.left="0";f.style.top="0";d.backButton=f;e?d.initialElements.push(f):f.className="fade";(d.preview=e)?(d.restartButton=null,d.timeDisplayImage=null,d.editNameButton=null,d.timeDisplay=null):
(e=d.createButton(null,UISpriteSheet.Restart,d.restart.bind(d)),e.className="fade",e.style.position="absolute",e.style.top="0",d.restartButton=e,e=document.createElement("div"),e.className="fade",e.style.position="absolute",d.timeDisplayImage=UISpriteSheet.create(UISpriteSheet.Clock,e),e.appendChild(d.timeDisplayText=document.createTextNode(Strings.Time)),d.editNameButton=d.createButton(e,UISpriteSheet.Edit,d.editName.bind(d)),d.timeDisplay=e);e=d.createButton(null,UISpriteSheet.Pause,d.pause.bind(d));
e.style.position="absolute";e.style.right="0";e.style.top="0";d.initialElements.push(e);d.resourceStorage=new ResourceStorage;d.boundRender=d.render.bind(d);d.alive=!0;d.paused=!1;d.finished=!1;d.alreadyCreated=!1;d.loadOptions=c;d.level=null;d.viewY=null;d.frameRequest=0;d.finalUIAttached=!1;d.pointerHandler=null;d.pointerCursorAttached=null;d.totalElapsedMilliseconds=null;d.victory=null;d.pointerCursorCenterX=null;d.pointerCursorCenterY=null;d.pointerCursorX=null;d.pointerCursorY=null;d.globalAlpha=
null;d.levelTexture=null;return d}__extends(b,a);Object.defineProperty(b.prototype,"usesGL",{get:function(){return!0},enumerable:!1,configurable:!0});b.prototype.releaseResources=function(){this.alive&&this.resourceStorage.release()};b.prototype.loadResources=function(){this.alive&&(this.resourceStorage.load(),LevelSpriteSheet.LevelModelCoordinates.setCoordinates(0,0,this.levelTexture.width*scaleFactor,this.levelTexture.height*scaleFactor),this.alreadyCreated?(this.frameRequest&&(cancelAnimationFrame(this.frameRequest),
this.frameRequest=0),this.frameRequest=requestAnimationFrame(this.boundRender)):(this.alreadyCreated=!0,this.restart()))};b.prototype.resize=function(){this.restartButton&&(this.restartButton.style.left=css(buttonHeight+buttonMargin));this.timeDisplay&&(this.timeDisplay.style.top=buttonMarginCss,this.timeDisplay.style.left=css(3*buttonHeight+buttonMargin),this.timeDisplay.style.lineHeight=iconSizeCss,this.editNameButton.style.marginTop="-"+buttonMarginCss,UISpriteSheet.resize(this.timeDisplayImage),
this.timeDisplayImage.style.marginRight=buttonMarginCss);this.level.viewResized();a.prototype.resize.call(this)};b.prototype.attach=function(){return __awaiter(this,void 0,void 0,function(){var c,e,d,f,g,h;return __generator(this,function(l){switch(l.label){case 0:return c=this,[4,LevelCache.loadLevelFromOptions(this.loadOptions)];case 1:c.level=l.sent();this.loadOptions=null;this.pointerHandler=new PointerHandler(View.glCanvas,this.mouseDown.bind(this),this.mouseMove.bind(this),this.mouseUp.bind(this));
if(this.levelTexture)return[3,3];e=this;d=Texture.bind;f=[void 0,View.gl];return[4,loadImage(this.level.processedImage)];case 2:e.levelTexture=new (d.apply(Texture,f.concat([l.sent()]))),this.resourceStorage.add("levelTexture",this.levelTexture),l.label=3;case 3:if(!androidWrapper)return[3,4];androidWrapper.setKeepScreenOn(!0);return[3,8];case 4:l.trys.push([4,7,,8]);g=navigator.wakeLock;if(!g||!g.request||b.wakeLockSentinel)return[3,6];h=b;return[4,g.request("screen")];case 5:h.wakeLockSentinel=
l.sent(),l.label=6;case 6:return[3,8];case 7:return l.sent(),[3,8];case 8:return[2]}})})};b.prototype.detach=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(c){switch(c.label){case 0:this.pointerHandler&&(this.pointerHandler.destroy(),this.pointerHandler=null);if(!androidWrapper)return[3,1];androidWrapper.setKeepScreenOn(!1);return[3,6];case 1:if(!b.wakeLockSentinel)return[3,6];c.label=2;case 2:return c.trys.push([2,5,,6]),b.wakeLockSentinel.release?[4,b.wakeLockSentinel.release()]:
[3,4];case 3:c.sent(),b.wakeLockSentinel=null,c.label=4;case 4:return[3,6];case 5:return c.sent(),[3,6];case 6:return[2]}})})};b.prototype.destroyInternal=function(c){this.alreadyCreated=this.alive=!1;this.level.destroyLevelPtr();this.globalAlpha=this.pointerCursorY=this.pointerCursorX=this.pointerCursorCenterY=this.pointerCursorCenterX=this.victory=this.totalElapsedMilliseconds=this.pointerCursorAttached=this.viewY=null;c?this.resourceStorage.release():this.resourceStorage.destroy()};b.prototype.restart=
function(){if(!this.alive)return!1;this.finalUIAttached&&(this.finalUIAttached=!1,this.preview||(View.main.removeChild(this.backButton),View.main.removeChild(this.restartButton),View.main.removeChild(this.timeDisplay)));this.finished=this.paused=!1;this.level.restart(this.preview);View.gl.clearColor(1,1,1,1);var c=cLib.HEAP8.buffer,e=cLib._getFirstPropertyPtr(this.level.levelPtr);this.viewY=new Float32Array(c,cLib._getViewYPtr(this.level.levelPtr),1);this.pointerCursorAttached=new Int32Array(c,e,
1);e+=4;this.totalElapsedMilliseconds=new Int32Array(c,e,1);e+=4;this.victory=new Int32Array(c,e,1);e+=4;this.pointerCursorCenterX=new Float32Array(c,e,1);e+=4;this.pointerCursorCenterY=new Float32Array(c,e,1);e+=4;this.pointerCursorX=new Float32Array(c,e,1);e+=4;this.pointerCursorY=new Float32Array(c,e,1);this.globalAlpha=new Float32Array(c,e+4,1);this.frameRequest&&(cancelAnimationFrame(this.frameRequest),this.frameRequest=0);this.frameRequest=requestAnimationFrame(this.boundRender);return!0};b.prototype.back=
function(c){if(!this.alive)return!1;this.alive=!1;this.paused=!0;this.frameRequest&&(cancelAnimationFrame(this.frameRequest),this.frameRequest=0);this.fadeToPrevious();return!0};b.prototype.pause=function(c){var e=this;if(!this.alive||!this.paused&&(c=ControlMode.accelerationSupported?UISpriteSheet.html(ControlMode.modeImage):null,!Modal.show({title:Strings.Pause,html:(androidWrapper||isPWA?"":'<button type="button" id="fullscreen" data-style="margin-bottom: '+buttonMargin+'">'+UISpriteSheet.html(UISpriteSheet.Fullscreen)+
Strings.Fullscreen+"</button><br/>")+(c?'<button type="button" id="controlMode" data-style="margin-bottom: '+buttonMargin+'">'+c+Strings.ControlMode+"</button><br/>":"")+('<button type="button" id="restart">'+UISpriteSheet.html(UISpriteSheet.Restart)+Strings.Restart+"</button>"),buttons:[{iconId:UISpriteSheet.Back,text:Strings.Exit,onclick:function(){Modal.hide();e.back(null)}},{defaultCancel:!0,iconId:UISpriteSheet.PlayGreen,text:Strings.Play,className:"accept",onclick:function(){Modal.hide();e.pause(null)}}],
onbuttonclick:function(d){switch(d){case "fullscreen":FullscreenControl.toggleFullscreen();break;case "controlMode":ControlMode.toggleMode();UISpriteSheet.change(document.getElementById("controlMode").firstChild,ControlMode.modeImage);break;case "restart":e.restart(),Modal.hide()}}})))return!1;this.paused=!this.paused;this.frameRequest&&(cancelAnimationFrame(this.frameRequest),this.frameRequest=0);this.alive&&(this.frameRequest=requestAnimationFrame(this.boundRender));return!0};b.prototype.mouseDown=
function(c){if(View.loading||!this.alive||this.paused||ControlMode.mode!==ControlMode.Pointer||this.finished)return!1;var e=model(c.clientX-baseLeftCss);c=model(c.clientY-baseTopCss);this.pointerCursorAttached[0]=1;this.pointerCursorCenterX[0]=e;this.pointerCursorX[0]=e;this.pointerCursorCenterY[0]=c;this.pointerCursorY[0]=c;return!0};b.prototype.mouseMove=function(c){this.pointerCursorX[0]=modelFrac(c.clientX-baseLeftCss);this.pointerCursorY[0]=modelFrac(c.clientY-baseTopCss)};b.prototype.mouseUp=
function(c){this.pointerCursorAttached[0]=0};b.prototype.checkRecord=function(){if(!(this.alive&&this.level&&this.totalElapsedMilliseconds&&this.victory&&this.victory[0]))return null;var c=LevelCache.getLevelRecord(this.level.name);return c&&c.time<=this.totalElapsedMilliseconds[0]?null:LevelCache.LastRecordName||""};b.prototype.setTimeDisplayTextRecord=function(c){this.timeDisplayText.nodeValue=LevelCache.formatLevelRecordTime(this.totalElapsedMilliseconds[0])+" - "+(c||Strings.NoName)};b.prototype.editName=
function(c){var e=this;return this.alive&&this.level&&this.totalElapsedMilliseconds&&this.victory&&this.victory[0]?Modal.show({title:Strings.NewRecord,html:'<label for="name">'+Strings.Name+'</label><input id="name" spellcheck="false" autocomplete="off" maxlength="8" /><br/><label>'+Strings.Time+"</label><label>"+LevelCache.formatLevelRecordTime(this.totalElapsedMilliseconds[0])+"</label>",okcancel:!0,okcancelsubmit:!0,onshowing:function(){var d=Modal.currentModalHeaderElement;if(d){d.setAttribute("data-style",
"line-height:"+iconSize);var f=UISpriteSheet.create(UISpriteSheet.Trophy);f.setAttribute("data-style","margin-right:"+buttonMargin);d.insertBefore(f,d.firstChild);UISpriteSheet.create(UISpriteSheet.Trophy,d).setAttribute("data-style","margin-left:"+buttonMargin)}document.getElementById("name").value=LevelCache.LastRecordName||""},onshown:function(){document.getElementById("name").focus()},onok:function(){return __awaiter(e,void 0,void 0,function(){var d;return __generator(this,function(f){if(!this.alive||
!this.level||!this.totalElapsedMilliseconds)return[2];(d=document.getElementById("name").value.trim())?LevelCache.setLevelRecord(this.level.name,this.totalElapsedMilliseconds[0],d):(LevelCache.deleteLevelRecord(this.level.name),LevelCache.clearLastRecordName());this.setTimeDisplayTextRecord(d);Modal.hide();return[2]})})}}):!1};b.prototype.render=function(c){var e=this;if(this.alive){this.frameRequest=requestAnimationFrame(this.boundRender);var d=this.level;View.drawBackground(c,d.levelPtr,!0,!this.finished)?
(ControlMode.mode!==ControlMode.Pointer&&androidWrapper&&ControlMode.processAndroidAcceleration(),d.step(this.paused),c=View.gl,c.draw(this.levelTexture,LevelSpriteSheet.LevelModelCoordinates,this.globalAlpha[0],LevelSpriteSheet.FullTextureCoordinates,0,-(this.viewY[0]*scaleFactor|0)),c.prepareNativeDraw(View.sheetTexture),cLib._render(c.verticesPtr,d.levelPtr,LevelSpriteSheet.LevelSpriteSheetPtr,scaleFactor)&&(this.finished=!0,this.pointerCursorAttached[0]=0,this.victory[0]?c.clearColor(253/255,
190/255,148/255,1):c.clearColor(.8,.8,1,1),this.preview?this.pause(null):(this.totalElapsedMilliseconds&&(d=this.checkRecord(),null===d?(UISpriteSheet.change(this.timeDisplayImage,UISpriteSheet.Clock),this.timeDisplayText.nodeValue=LevelCache.formatLevelRecordTime(this.totalElapsedMilliseconds[0]),this.editNameButton.style.display="none"):(d&&LevelCache.setLevelRecord(this.level.name,this.totalElapsedMilliseconds[0],d),UISpriteSheet.change(this.timeDisplayImage,UISpriteSheet.Trophy),this.setTimeDisplayTextRecord(d),
this.editNameButton.style.display="")),this.finalUIAttached||(this.finalUIAttached=!0,this.preview||(this.backButton.className="fade",this.restartButton.className="fade",this.timeDisplay.className="fade",View.main.appendChild(this.backButton),View.main.appendChild(this.restartButton),View.main.appendChild(this.timeDisplay),setTimeout(function(){e.backButton.className="fade visible";e.restartButton.className="fade visible";e.timeDisplay.className="fade visible"},10)))))):this.frameRequest&&(cancelAnimationFrame(this.frameRequest),
this.frameRequest=0)}else this.frameRequest=0};b.FinishedThisFrame=1;b.FinishedVictory=2;b.FinishedLoss=4;b.wakeLockSentinel=null;return b}(View),SelectionView=function(a){function b(){var c=a.call(this)||this;c.baseElement=document.createElement("div");c.baseElement.className="base-element";c.baseElement.innerHTML='\n\t\t<div class="hidden-container"><input id="fileInput" type="file" accept="application/json" tabindex="-1" /></div>\n\t\t<div id="toolbarTop" class="toolbar toolbar-top"></div>\n\t\t';
c.initialElements.push(c.baseElement);c.fileInput=c.baseElement.querySelector("#fileInput");c.toolbarTop=c.baseElement.querySelector("#toolbarTop");c.scrollContainer=new ScrollContainer(c.baseElement);c.createButton(c.toolbarTop,UISpriteSheet.Back,c.back.bind(c)).style.float="left";c.fileInput.onchange=c.openFile.bind(c);LevelCache.isSupported()&&c.createButton(c.toolbarTop,UISpriteSheet.Open,c.open.bind(c));androidWrapper||isPWA||c.buttonsWithMargin.push(c.createButton(c.toolbarTop,UISpriteSheet.Fullscreen,
c.fullscreen.bind(c)));c.boundPlay=c.play.bind(c);c.boundShowMenu=c.showMenu.bind(c);c.thumbnails=null;c.thumbnailImages=null;c.thumbnailRecords=null;c.anchors=null;c.hr=null;c.lastPlayedThumbnail=null;return c}__extends(b,a);b.prototype.resize=function(){var c=this.thumbnails,e=this.thumbnailImages,d=this.thumbnailRecords,f=this.anchors,g=cssNumber(thumbnailWidth),h=cssNumber(thumbnailHeight);cssNumber(iconSize);var l=borderWidthCss+" 0 0 "+borderWidthCss,k=toolbarAvailableHeightCss+" 0 0 "+css(27),
m=css(borderWidth<<1),p=m+" 0";m+=" 0 0";this.hr&&(this.hr.style.marginTop=toolbarAvailableHeightCss,this.hr.style.borderTopWidth=borderWidthCss);this.toolbarTop.style.height=toolbarAvailableHeightCss;this.toolbarTop.style.borderBottomWidth=borderWidthCss;for(var n=c.length-1;0<=n;n--){c[n].style.width=thumbnailWidthCss;c[n].style.borderWidth=borderWidthCss;c[n].style.margin=k;c[n].style.padding=p;c[n].style.lineHeight=iconSizeCss;e[n].width=g;e[n].height=h;e[n].style.margin=m;d[n].style.borderTopWidth=
borderWidthCss;d[n].style.padding=m;f[n].style.borderWidth=l;f[n].style.padding=buttonPaddingCss;UISpriteSheet.resize(f[n].firstChild);var q=d[n].childNodes;q[0].style.marginRight=buttonMarginCss;q[3].style.marginRight=buttonMarginCss;UISpriteSheet.resize(q[0]);UISpriteSheet.resize(q[3])}this.scrollContainer.containerElement.style.paddingBottom=toolbarAvailableHeightCss;this.scrollContainer.resize(toolbarTotalHeight,baseHeight-toolbarTotalHeight);a.prototype.resize.call(this)};b.prototype.updateThumbnailRecord=
function(c,e){if(c&&e){for(c=LevelCache.getLevelRecord(c);e.firstChild;)e.removeChild(e.firstChild);UISpriteSheet.create(UISpriteSheet.Trophy,e);e.appendChild(document.createTextNode(c?c.name:"-"));e.appendChild(document.createElement("br"));UISpriteSheet.create(UISpriteSheet.Clock,e);e.appendChild(document.createTextNode(c?c.fmt:"-"))}};b.prototype.createThumbnail=function(c,e,d,f){void 0===d&&(d=null);void 0===f&&(f=-1);var g=document.createElement("div"),h=document.createElement("div"),l=document.createElement("div"),
k=document.createElement("img"),m=document.createElement("div"),p=document.createElement("a"),n=e?f.toString():c;g.className="thumbnail";e?(g.setAttribute("data-id",n),g.setAttribute("data-name",Strings.LevelSpace+(f+1))):g.setAttribute("data-name",n);prepareButtonBlink(g,!1,this.boundPlay);h.className="thumbnail-preview";l.className="thumbnail-text";l.textContent=c;h.appendChild(l);d?k.src=d:LevelCache.loadLevelInfo(c,!1).then(function(q){q&&(k.src=q.thumbnailImage)},function(q){console.log(q)});
h.appendChild(k);UISpriteSheet.create(UISpriteSheet.Menu,p);p.className="menu";prepareButtonBlink(p,!1,this.boundShowMenu);h.appendChild(p);g.appendChild(h);m.className="thumbnail-text thumbnail-record";this.updateThumbnailRecord(n,m);g.appendChild(m);this.thumbnails.push(g);this.thumbnailImages.push(k);this.thumbnailRecords.push(m);this.anchors.push(p);e||this.hr||(this.hr=document.createElement("hr"),this.scrollContainer.containerElement.appendChild(this.hr));this.scrollContainer.containerElement.appendChild(g)};
b.prototype.attach=function(){return __awaiter(this,void 0,void 0,function(){var c,e,d,f;return __generator(this,function(g){switch(g.label){case 0:if(this.thumbnails)return[3,4];this.thumbnails=[];this.thumbnailImages=[];this.thumbnailRecords=[];this.anchors=[];return LevelCache.BuiltInLevelIds?[3,2]:[4,LevelCache.loadBuiltInLevels()];case 1:g.sent(),g.label=2;case 2:c=LevelCache.BuiltInLevelIds;for(e=0;e<c.length;e++)this.createThumbnail(Strings.LevelSpace+(e+1),!0,LevelCache.builtInLevelThumbnailPath(e),
c[e]);return[4,LevelCache.getLevelNames()];case 3:d=g.sent();for(e=0;e<d.length;e++)this.createThumbnail(d[e],!1);return[3,5];case 4:this.lastPlayedThumbnail&&((f=this.lastPlayedThumbnail.getElementsByClassName("thumbnail-record"))&&f[0]&&this.updateThumbnailRecord(this.lastPlayedThumbnail.getAttribute("data-id")||this.lastPlayedThumbnail.getAttribute("data-name"),f[0]),this.lastPlayedThumbnail=null),g.label=5;case 5:return this.scrollContainer.attach(),[2]}})})};b.prototype.detach=function(){return __awaiter(this,
void 0,void 0,function(){return __generator(this,function(c){this.scrollContainer.detach();return[2]})})};b.prototype.destroyInternal=function(c){};b.prototype.back=function(c){return this.fadeTo("TitleView")?!0:!1};b.prototype.openFile=function(c){var e=this;if(!Modal.visible&&this.fileInput.files&&this.fileInput.files[0])if(this.fileInput.files[0].name.toLowerCase().endsWith(".json")){View.loading=!0;var d=new FileReader;d.onload=function(){function f(){View.loading=!1;Modal.show({html:Strings.ErrorLoadingLevel+
UISpriteSheet.html(UISpriteSheet.Error)})}e.fileInput.value="";if(d.result){var g=null;try{g=Level.revive(d.result)}catch(h){}g?(LevelCache.isNameValid(g.name)||(g.name=Strings.Level),g.prepare().then(function(){LevelCache.getLevelNames().then(function(h){var l=g.name;/.*\(\d+\)$/.test(l)&&(l=l.substr(0,l.lastIndexOf("(")).trim(),l||(l=Strings.Level));for(var k=0,m=g.name;;){for(var p=!0,n=h.length-1;0<=n;n--)if(h[n]===m){p=!1;break}if(p)break;k++;m=l+" ("+k+")"}g.name=m;LevelCache.saveLevel(g,!1).then(function(){View.loading=
!1;e.createThumbnail(m,!1);e.resize();Modal.show({title:Strings.Success,html:Strings.LevelImported+UISpriteSheet.html(UISpriteSheet.Success)})},f)},f)},f)):f()}else View.loading=!1,Modal.show({html:Strings.EmptyLevel+UISpriteSheet.html(UISpriteSheet.Error)})};d.onerror=function(){e.fileInput.value="";View.loading=!1;Modal.show({html:Strings.ErrorReadingLevel+UISpriteSheet.html(UISpriteSheet.Error)})};d.readAsText(this.fileInput.files[0])}else Modal.show({html:Strings.InvalidLevel+UISpriteSheet.html(UISpriteSheet.Error)})};
b.prototype.open=function(c){this.fileInput.click();return!0};b.prototype.fullscreen=function(c){FullscreenControl.toggleFullscreen();return!0};b.prototype.loadOptions=function(c){var e=c.getAttribute("data-id");c=c.getAttribute("data-name");return e?{levelId:parseInt(e),levelNameOverride:c}:{levelName:c}};b.prototype.getTargetThumbnail=function(c){for(;c&&c!==document.body;){if("thumbnail"===c.className)return c;c=c.parentNode}return null};b.prototype.play=function(c){c=c.target;return"A"===c.tagName||
"IMG"===c.tagName&&"A"===c.parentNode.tagName?!1:(c=this.getTargetThumbnail(c))?(this.lastPlayedThumbnail=c,this.fadeTo(new GameView(this.loadOptions(c),!1),!0),!0):!1};b.prototype.showMenu=function(c){var e=this,d=c.target,f=this.getTargetThumbnail(d);if(!f)return!1;c=!!f.getAttribute("data-id");var g=!1,h=!1;return Modal.show({title:Strings.Menu,html:'<button type="button" id="edit" '+(c?"":'data-style="margin-bottom: '+buttonMargin+'"')+">"+UISpriteSheet.html(UISpriteSheet.Edit)+Strings.Edit+"</button>\n\t\t\t\t"+
(c?"":'<br/><button type="button" id="delete" class="danger">'+UISpriteSheet.html(UISpriteSheet.ClearRed)+Strings.Delete+"</button>"),buttons:[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Close,onclick:function(){Modal.hide()}},{iconId:UISpriteSheet.Download,text:Strings.Download,onclick:function(){h=!0;Modal.hide()}}],onbuttonclick:function(l){switch(l){case "edit":Modal.hide();e.editLevel(f);break;case "delete":g=!0,Modal.hide()}},onhidden:function(){g?e.deleteLevel(d,f):h&&e.downloadLevel(f)}})};
b.prototype.editLevel=function(c){this.fadeTo(new EditorView(this.loadOptions(c),!0))};b.prototype.deleteLevel=function(c,e){var d=this,f=e.getAttribute("data-name");if(f){var g=!1,h=!1;Modal.show({html:Strings.DeleteLevel+f+"?",buttons:[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Cancel,onclick:Modal.hide},{iconId:UISpriteSheet.ClearRed,text:Strings.Delete,className:"danger",onclick:function(){return __awaiter(d,void 0,void 0,function(){var l,k;return __generator(this,function(m){switch(m.label){case 0:if(View.loading)return[2];
m.label=1;case 1:return m.trys.push([1,3,,4]),[4,LevelCache.deleteLevel(f)];case 2:m.sent();l=this.anchors;for(k=l.length-1;0<=k;k--)if(l[k]===c){this.scrollContainer.containerElement.removeChild(e);this.thumbnails.splice(k,1);this.thumbnailImages.splice(k,1);this.thumbnailRecords.splice(k,1);l.splice(k,1);l.length===LevelCache.BuiltInLevelIds.length&&(this.scrollContainer.containerElement.removeChild(this.hr),this.hr=null);this.scrollContainer.resize(toolbarTotalHeight,baseHeight-toolbarTotalHeight);
break}g=!0;return[3,4];case 3:return m.sent(),h=!0,[3,4];case 4:return Modal.hide(),[2]}})})}}],onhidden:function(){h?Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)}):g&&Modal.show({title:Strings.Success,html:Strings.LevelDeleted+UISpriteSheet.html(UISpriteSheet.Success)})}})}};b.prototype.downloadLevel=function(c){return __awaiter(this,void 0,void 0,function(){var e,d;return __generator(this,function(f){switch(f.label){case 0:return e=c.getAttribute("data-id"),
(d=c.getAttribute("data-name"))?[4,LevelCache.downloadLevel(d,e?parseInt(e):-1)]:[2];case 1:switch(f.sent()){case LevelCache.DownloadLevelSuccess:Modal.show({title:Strings.Success,html:Strings.LevelDownloaded+UISpriteSheet.html(UISpriteSheet.Success)});break;case LevelCache.DownloadLevelError:Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)});break;case LevelCache.DownloadLevelNoPermission:Modal.show({html:Strings.TryToDownloadAgain});break;case LevelCache.DownloadLevelFileAlreadyExists:Modal.show({html:Strings.DownloadFailedFileExists+
UISpriteSheet.html(UISpriteSheet.Error)})}return[2]}})})};return b}(View),TitleView=function(a){function b(){var c=a.call(this)||this;c.logo=document.createElement("div");c.logo.className="logo";c.initialElements.push(c.logo);c.buttonContainer=document.createElement("div");c.buttonContainer.style.position="absolute";c.initialElements.push(c.buttonContainer);c.createButton(c.buttonContainer,UISpriteSheet.Play,c.play.bind(c));c.buttonsWithLargeMargin.push(c.createButton(c.buttonContainer,UISpriteSheet.Edit,
c.edit.bind(c)));isPWA||(c.fullscreenButton=c.createButton(null,androidWrapper?UISpriteSheet.Exit:UISpriteSheet.Fullscreen,(androidWrapper?c.exit:c.fullscreen).bind(c)),c.fullscreenButton.style.position="absolute",c.initialElements.push(c.fullscreenButton));c.aboutButton=c.createButton(null,UISpriteSheet.Question,c.about.bind(c));c.aboutButton.style.position="absolute";c.initialElements.push(c.aboutButton);return c}__extends(b,a);b.prototype.resize=function(){var c=css(150),e=css(30);this.logo.style.left=
css(baseWidth-150>>1);this.logo.style.top=css(buttonLargeMargin<<1);this.logo.style.width=c;this.logo.style.height=e;this.logo.style.backgroundSize=c+" "+e;c=(buttonHeight<<1)+buttonLargeMargin;this.buttonContainer.style.bottom=css(buttonLargeMargin);this.buttonContainer.style.left=css(baseWidth-c>>1);this.buttonContainer.style.width=css(c);this.fullscreenButton&&(this.fullscreenButton.style.left=buttonMarginCss,this.fullscreenButton.style.bottom=buttonMarginCss);this.aboutButton.style.right=buttonMarginCss;
this.aboutButton.style.bottom=buttonMarginCss;a.prototype.resize.call(this)};b.prototype.attach=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(c){View.glCanvas.style.cursor="default";return[2]})})};b.prototype.detach=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(c){View.glCanvas.style.cursor="";return[2]})})};b.prototype.destroyInternal=function(c){};b.prototype.play=function(c){this.fadeTo("SelectionView");return!0};
b.prototype.edit=function(c){this.fadeTo("EditorView");return!0};b.prototype.fullscreen=function(c){FullscreenControl.toggleFullscreen();return!0};b.prototype.exit=function(c){androidWrapper.exit();return!0};b.prototype.about=function(c){c=[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Close,onclick:Modal.hide}];!androidWrapper&&installationPrompt&&installationPrompt.prompt&&c.push({iconId:UISpriteSheet.Download,text:Strings.Install,onclick:function(e,d){if(installationPrompt)try{e=installationPrompt,
installationPrompt=null,e.prompt()}catch(f){}setTimeout(function(){d.style.display="none"},blinkTotalDurationMS)}});Modal.show({title:Strings.About+(' <span style="float: right;">v'+version+window.pixelES+"</span>"),large:!0,html:Strings.About1+(2===View.gl.contextVersion?Strings.About2:"")+Strings.About3+(window.pixelUsingWebAssembly?"":Strings.About4)+Strings.About5+UISpriteSheet.html(UISpriteSheet.Success)+"</p>"+(androidWrapper||navigator.wakeLock&&navigator.wakeLock.request?"":Strings.About6)+
Strings.About7,buttons:c});return!0};return b}(View),viewClasses={EditorView:EditorView,GameView:GameView,SelectionView:SelectionView,TitleView:TitleView},cLib=null,scaleFactor=-1,baseHeight=minHeight,baseLeftCss=0,baseTopCss=0,baseWidthCss=baseWidth,baseHeightCss=minHeight,maxHeightCss=minHeight,thumbnailWidthCss=thumbnailWidth+"px",thumbnailHeightCss=thumbnailHeight+"px",buttonHeightCss=buttonHeight+"px",borderWidthCss=borderWidth+"px",toolbarAvailableHeightCss=toolbarAvailableHeight+"px",toolbarTotalHeightCss=
toolbarTotalHeight+"px",iconSizeCss=iconSize+"px",buttonMarginCss=buttonMargin+"px",buttonLargeMarginCss=buttonLargeMargin+"px",buttonPaddingCss=buttonPadding+"px",fontSizeCss="16px",installationPrompt=null,landscapeWarning=null;function ignorePromise(a){try{var b=function(){};a&&a.then&&a.then(b,b)}catch(c){}}function cancelEvent(a){a&&("isCancelled"in a&&(a.isCancelled=!0),"preventDefault"in a&&a.preventDefault(),"stopPropagation"in a&&a.stopPropagation());return!1}
function format2(a){return 10>a?"0"+a:a.toString()}function css(a){return(a|0)*scaleFactor/pixelRatio+"px"}function cssNumber(a){return(a|0)*scaleFactor/pixelRatio}function model(a){return a*pixelRatio/scaleFactor|0}function modelFrac(a){return a*pixelRatio/scaleFactor}function smoothStep(a){return a*a*(3-2*a)}function handleBlink(a){var b=a[0],c=a[1];0<b&&b<blinkLastCounter?(c.style.visibility=b&1?"":"hidden",a[0]=b+1):abortBlink(c)}
function abortBlink(a){if(a){var b=a.getAttribute("data-blink-interval");b&&(a.setAttribute("data-blink-interval",""),(b=parseInt(b))&&clearInterval(b),a.style.visibility="")}}function blink(a){a&&(abortBlink(a),a.style.visibility="hidden",a.setAttribute("data-blink-interval",setInterval(handleBlink,blinkSingleDurationMS,[1,a]).toString()))}function prepareButtonBlink(a,b,c){a.onclick=function(e){View.loading||View.fading||!b&&Modal.visible||!c(e)||blink(a)}}
function applyCSSTransform(a,b){a.style.oTransform=b;a.style.msTransform=b;a.style.mozTransform=b;a.style.webkitTransform=b;a.style.transform=b}function zeroObject(a){for(var b in a)switch(typeof a[b]){case "function":break;case "boolean":a[b]=!1;break;case "number":a[b]=0;break;default:var c=a[b];Array.isArray(c)&&c.fill(null);a[b]=null}}
function adjustWindowSize(){var a=window.innerWidth,b=window.innerHeight;document.documentElement&&"clientWidth"in document.documentElement&&(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight);if(isIOSOrSafari){var c=null;document.documentElement&&"getBoundingClientRect"in document.documentElement?c=document.documentElement.getBoundingClientRect():"getBoundingClientRect"in document.body&&(c=document.body.getBoundingClientRect());c&&(a=c.right-c.left,b=c.bottom-c.top)}var e=
a*pixelRatio,d=b*pixelRatio;c=scaleFactor;var f=baseHeight;scaleFactor=0;for(var g,h;;)if(scaleFactor++,g=baseWidth*scaleFactor,h=d>g?g:d,baseHeight=Math.ceil(h/scaleFactor),baseHeight<minHeight||baseWidth*scaleFactor>e){1<scaleFactor&&scaleFactor--;g=baseWidth*scaleFactor;h=d>g?g:d;baseHeight=Math.ceil(h/scaleFactor);baseHeight<minHeight&&(baseHeight=minHeight);h=baseHeight*scaleFactor;break}baseWidthCss=g/pixelRatio;baseHeightCss=h/pixelRatio;baseLeftCss=(.5*(e-g)|0)/pixelRatio;e=.5*(d-h)|0;0>e&&
(e=0);baseTopCss=e/pixelRatio;View.main.style.left=baseLeftCss+"px";View.main.style.top=baseTopCss+"px";applyCSSTransform(View.cover,"scale("+Math.ceil(.25*a)+","+Math.ceil(.25*b)+")");b>a||baseTopCss?landscapeWarning||(landscapeWarning=document.createElement("div"),landscapeWarning.style.pointerEvents="none",landscapeWarning.style.fontSize="2em",landscapeWarning.style.textAlign="center",landscapeWarning.style.position="absolute",landscapeWarning.style.left="0",landscapeWarning.style.top="0.5em",
landscapeWarning.style.width="100%",landscapeWarning.style.zIndex="9999",landscapeWarning.textContent=Strings.LandscapeWarning,document.body.appendChild(landscapeWarning)):landscapeWarning&&(document.body.removeChild(landscapeWarning),landscapeWarning=null);scaleFactor!==c||baseHeight!==f?(View.main.style.width=baseWidthCss+"px",View.main.style.height=baseHeightCss+"px",maxHeightCss=cssNumber(maxHeight),thumbnailWidthCss=css(thumbnailWidth),thumbnailHeightCss=css(thumbnailHeight),buttonHeightCss=
css(buttonHeight),borderWidthCss=css(borderWidth),toolbarAvailableHeightCss=css(toolbarAvailableHeight),toolbarTotalHeightCss=css(toolbarTotalHeight),iconSizeCss=css(iconSize),buttonMarginCss=css(buttonMargin),buttonLargeMarginCss=css(buttonLargeMargin),buttonPaddingCss=css(buttonPadding),fontSizeCss=css(8),document.body.style.fontSize=fontSizeCss,LevelSpriteSheet.recreateIfNecessary(),UISpriteSheet.windowResized(),View.windowResized(!0),Modal.windowResized()):View.windowResized(!1)}
function beforeInstallPrompt(a){"preventDefault"in a&&a.preventDefault();installationPrompt=a}var fullscreenChangedTimeout=0;function fullscreenChanged(a){fullscreenChangedTimeout&&(clearTimeout(fullscreenChangedTimeout),fullscreenChangedTimeout=0);try{FullscreenControl.fullscreenMode?fullscreenChangedTimeout=setTimeout(fullscreenChangedHandler,150):fullscreenChangedHandler()}catch(b){}}
function fullscreenChangedHandler(){fullscreenChangedTimeout=0;if(screen.mozLockOrientation&&screen.mozUnlockOrientation)try{if(FullscreenControl.fullscreenMode){if(screen.mozLockOrientation("landscape-primary"))return}else if(screen.mozUnlockOrientation())return}catch(a){}if(screen.msLockOrientation&&screen.msUnlockOrientation)try{if(FullscreenControl.fullscreenMode){if(screen.msLockOrientation("landscape-primary"))return}else if(screen.msUnlockOrientation())return}catch(a){}if(screen.orientation&&
screen.orientation.lock&&screen.orientation.unlock)try{ignorePromise(FullscreenControl.fullscreenMode?screen.orientation.lock("landscape-primary"):screen.orientation.unlock())}catch(a){}}
function setup(){return __awaiter(this,void 0,void 0,function(){var a,b,c;return __generator(this,function(e){switch(e.label){case 0:return Strings.init(),a=Promise.all([LevelSpriteSheet.preload(),window.CLib()]),View.loading=!0,"serviceWorker"in navigator&&!androidWrapper&&(window.addEventListener("beforeinstallprompt",beforeInstallPrompt),navigator.serviceWorker.register("sw.js")),ControlMode.init(),[4,a];case 1:return c=e.sent(),cLib=c[1],View.initGL(),window.onpopstate=View.windowHistoryStatePopped,
window.onresize=adjustWindowSize,adjustWindowSize(),androidWrapper||(FullscreenControl.onfullscreenchange=fullscreenChanged),View.loading=!1,View.createInitialView(),b=document.createElement("script"),b.async=!0,b.setAttribute("type","text/javascript"),b.setAttribute("charset","utf-8"),b.setAttribute("src","assets/js/levels.js"),document.body.appendChild(b),[2]}})})}window.pixelStepMAIN=!0;window.pixelCheckSetup&&window.pixelCheckSetup();
