'use strict';var __awaiter=this&&this.__awaiter||function(a,b,c,d){function e(f){return f instanceof c?f:new c(function(g){g(f)})}return new (c||(c=Promise))(function(f,g){function h(k){try{m(d.next(k))}catch(n){g(n)}}function l(k){try{m(d["throw"](k))}catch(n){g(n)}}function m(k){k.done?f(k.value):e(k.value).then(h,l)}m((d=d.apply(a,b||[])).next())})};const androidWrapper="androidWrapper"in window?window.androidWrapper:null;
class Strings{static init(){const a=androidWrapper?androidWrapper.getBrowserLanguage():navigator.userLanguage||navigator.language;a&&0===a.toLowerCase().indexOf("pt")&&(document.documentElement.setAttribute("lang","pt-br"),Strings.DecimalSeparator=",",Strings.OppositeDecimalSeparator=".",Strings.YouWillLoseYourLevel="Voc\u00ea vai perder sua fase! Continuar?",Strings.TooManyObjects="H\u00e1 muitos objetos na fase ",Strings.TooManyBalls="H\u00e1 muitas bolas na fase ",Strings.TooManyPolygons="H\u00e1 muitos pol\u00edgonos na fase! Por favor, tente deixar a contagem de pol\u00edgonos abaixo de ",
Strings.TooManyPoints="H\u00e1 muitos pontos na fase! Por favor, tente deixar a contagem de pontos abaixo de ",Strings.InvalidImage="Imagem inv\u00e1lida! Por favor, escolha uma imagem PNG ou JPG ",Strings.EmptyImage="A imagem estava vazia ",Strings.ErrorLoadingImage="Desculpe! Algo deu errado ao carregar a imagem ",Strings.ErrorReadingImage="Desculpe! Algo deu errado ao ler a imagem ",Strings.ClearEntireLevel="Limpar a fase toda?",Strings.SaveLevel="Salvar Fase",Strings.NameCannotContain="Desculpe! O nome n\u00e3o pode conter os caracteres",
Strings.SomethingWentWrong="Desculpe! Algo deu errado ",Strings.Success="Sucesso!",Strings.LevelSaved="Fase salva! ",Strings.Pause="Pausa",Strings.Fullscreen="Tela Cheia",Strings.ControlMode="Modo de Controle",Strings.Restart="Reiniciar",Strings.InvalidLevel="Fase inv\u00e1lida! Por favor, escolha um arquivo JSON ",Strings.EmptyLevel="A fase estava vazia ",Strings.ErrorLoadingLevel="Desculpe! Algo deu errado ao carregar a fase ",Strings.LevelImported="Fase importada! ",Strings.ErrorReadingLevel="Desculpe! Algo deu errado ao ler a fase ",
Strings.Edit="Editar",Strings.Delete="Excluir",Strings.DeleteLevel="Excluir a fase ",Strings.Cancel="Cancelar",Strings.Clear="Limpar",Strings.Close="Fechar",Strings.Exit="Sair",Strings.Play="Jogar",Strings.Install="Instalar!",Strings.LevelSpace="Fase ",Strings.Level="Fase",Strings.LevelName="Nome da Fase",Strings.About="Sobre",Strings.About1="<p>Meu filho ainda gosta de jogos de labirinto hoje em dia (Setembro de 2020). Ent\u00e3o... Como eu precisava colocar WebAssembly",Strings.About2=" e WebGL2",
Strings.About3=" em pr\u00e1tica",Strings.About4=", apesar de WebAssembly n\u00e3o ser suportado por seu navegador",Strings.About5=", decidi continuar o jogo que eu criei para ele em 2019! Pepinos devem ser coletados em alguns n\u00edveis porque ele adora um certo pepino de um desenho famoso! A prop\u00f3sito, ele criou a Fase 1 sozinho ",Strings.About6='<p>Voc\u00ea tamb\u00e9m pode <a href="https://play.google.com/store/apps/details?id=br.com.carlosrafaelgn.pixel" target="_blank">instalar uma vers\u00e3o para Android</a> (apenas para manter a tela ligada mesmo sem que ela seja tocada).</p>',
Strings.About7='<p>O c\u00f3digo-fonte do jogo pode ser encontrado no <a href="https://github.com/carlosrafaelgn/pixel" target="_blank">GitHub</a> e \u00e9 licenciado sob a <a href="https://github.com/carlosrafaelgn/pixel/blob/master/LICENSE" target="_blank">MIT License</a>. O jogo usa o motor de f\u00edsica <a href="https://github.com/slembcke/Chipmunk2D" target="_blank">Chipmunk2D</a>, licenciado sob a <a href="https://github.com/slembcke/Chipmunk2D/blob/master/LICENSE.txt" target="_blank">MIT License</a>, e tamb\u00e9m usa a fonte <a href="https://github.com/google/fonts/tree/master/ofl/pressstart2p" target="_blank">Press Start 2P</a>, licenciada sob a <a href="https://github.com/google/fonts/blob/master/ofl/pressstart2p/OFL.txt" target="_blank">SIL Open Font License</a>.</p>',
Strings.LevelDeleted="Fase exclu\u00edda! ",Strings.LevelDownloaded="Download da fase conclu\u00eddo! ",Strings.TryToDownloadAgain="Por favor, tente realizar o download da fase novamente, depois de conceder permiss\u00e3o.",Strings.DownloadFailedFileExists="Desculpe! N\u00e3o foi poss\u00edvel realizar o download da fase porque j\u00e1 existe um arquivo com o mesmo nome na pasta Download ",Strings.LevelImageDownloaded="Download da imagem conclu\u00eddo! ",Strings.TryToDownloadLevelImageAgain="Por favor, tente realizar o download da imagem novamente, depois de conceder permiss\u00e3o.",
Strings.LevelImageDownloadFailedFileExists="Desculpe! N\u00e3o foi poss\u00edvel realizar o download da imagem porque j\u00e1 existe um arquivo com o mesmo nome na pasta Download ",Strings.NewRecord="Novo Recorde!",Strings.Time="Tempo",Strings.Name="Nome",Strings.LandscapeWarning="O jogo funciona melhor no modo paisagem :)")}}Strings.DecimalSeparator=".";Strings.OppositeDecimalSeparator=",";Strings.YouWillLoseYourLevel="You will lose your level! Continue?";Strings.TooManyObjects="There are too many objects in the level ";
Strings.TooManyBalls="There are too many balls in the level ";Strings.TooManyPolygons="There are too many polygons in the level! Please, try to keep the polygon count below ";Strings.TooManyPoints="There are too many points in the level! Please, try to keep the points count below ";Strings.InvalidImage="Invalid image! Please, select a PNG or a JPG image ";Strings.EmptyImage="The image was empty ";Strings.ErrorLoadingImage="Sorry! Something went wrong while loading the image ";
Strings.ErrorReadingImage="Sorry! Something went wrong while reading the image ";Strings.ClearEntireLevel="Clear the entire level?";Strings.SaveLevel="Save Level";Strings.NameCannotContain="Sorry! The name cannot contain the characters";Strings.SomethingWentWrong="Sorry! Something went wrong ";Strings.Success="Success!";Strings.LevelSaved="Level saved! ";Strings.Pause="Pause";Strings.Fullscreen="Fullscreen";Strings.ControlMode="Control Mode";Strings.Restart="Restart";Strings.InvalidLevel="Invalid level! Please, select a JSON file ";
Strings.EmptyLevel="The level was empty ";Strings.ErrorLoadingLevel="Sorry! Something went wrong while loading the level ";Strings.LevelImported="Level imported! ";Strings.ErrorReadingLevel="Sorry! Something went wrong while reading the level ";Strings.Menu="Menu";Strings.Edit="Edit";Strings.Delete="Delete";Strings.DeleteLevel="Delete the level ";Strings.OK="OK";Strings.Cancel="Cancel";Strings.Clear="Clear";Strings.Close="Close";Strings.Exit="Exit";Strings.Play="Play";Strings.Install="Install!";
Strings.Oops="Oops\u2026";Strings.Download="Download";Strings.LevelSpace="Level ";Strings.Level="Level";Strings.LevelName="Level Name";Strings.About="About";Strings.About1="<p>My son is still into maze games nowadays (September 2020). So... As I needed to put WebAssembly";Strings.About2=" and WebGL2";Strings.About3=" into practice";Strings.About4=", even though WebAssembly is not currently supported by your browser";Strings.About5=", I decided to continue the game I created for him in 2019! Cucumbers must be collected in some levels because he enjoys a certain cucumber from a famous cartoon! By the way, he created Level 1 on his own ";
Strings.About6='<p>You can also <a href="https://play.google.com/store/apps/details?id=br.com.carlosrafaelgn.pixel" target="_blank">install an Android wrapper</a> (just to keep the screen on even without touching it).</p>';Strings.About7='<p>The source code for this game can be found at <a href="https://github.com/carlosrafaelgn/pixel" target="_blank">GitHub</a> and is licensed under the <a href="https://github.com/carlosrafaelgn/pixel/blob/master/LICENSE" target="_blank">MIT License</a>. The game uses the physics engine <a href="https://github.com/slembcke/Chipmunk2D" target="_blank">Chipmunk2D</a>, licensed under the <a href="https://github.com/slembcke/Chipmunk2D/blob/master/LICENSE.txt" target="_blank">MIT License</a>, and also uses the font <a href="https://github.com/google/fonts/tree/master/ofl/pressstart2p" target="_blank">Press Start 2P</a>, licensed under the <a href="https://github.com/google/fonts/blob/master/ofl/pressstart2p/OFL.txt" target="_blank">SIL Open Font License</a>.</p>';
Strings.LevelDeleted="Level deleted! ";Strings.LevelDownloaded="Level downloaded! ";Strings.TryToDownloadAgain="Please, try to download the level again, after granting the requested permission.";Strings.DownloadFailedFileExists="Sorry! The level could not be downloaded because there is another file with the same name in the Download folder ";Strings.LevelImageDownloaded="Image downloaded! ";Strings.TryToDownloadLevelImageAgain="Please, try to download the image again, after granting the requested permission.";
Strings.LevelImageDownloadFailedFileExists="Sorry! The image could not be downloaded because there is another file with the same name in the Download folder ";Strings.NewRecord="New Record!";Strings.Time="Time";Strings.Name="Name";Strings.LandscapeWarning="The game works better in landscape mode :)";
function detectIOSOrSafari(){if(0>=navigator.userAgent.indexOf("Chrome")&&0<=navigator.userAgent.indexOf("Safari")||0<=navigator.userAgent.indexOf("Mac")&&"ontouchend"in document)return!0;switch(navigator.platform){case "iPad Simulator":case "iPhone Simulator":case "iPod Simulator":case "iPad":case "iPhone":case "iPod":return!0}return!1}
const isPWA=0<=window.location.href.indexOf("pwa"),isIOSOrSafari=detectIOSOrSafari(),main=document.getElementById("main"),baseWidth=420,minHeight=baseWidth>>1,maxHeight=baseWidth<<1,pixelRatio=window.devicePixelRatio||1,thumbnailWidth=baseWidth>>2,thumbnailHeight=56,iconSize=12,iconRadius=iconSize>>1,borderWidth=1,buttonHeight=iconSize<<1,buttonMargin=iconSize>>1,buttonLargeMargin=buttonHeight,buttonPadding=buttonHeight-iconSize>>1,buttonBlinkLastCounter=7,buttonBlinkSingleDurationMS=75,buttonBlinkTotalDurationMS=
(buttonBlinkLastCounter+1)*buttonBlinkSingleDurationMS,scrollThumbWidth=32,scrollThumbHeight=48,toolbarAvailableHeight=buttonHeight,toolbarTotalHeight=toolbarAvailableHeight+borderWidth,rainbowColors=[4294901760,4294919168,4294936576,4294953984,4294967040,4291624704,4287168256,4282711808,4278255360,4278255428,4278255496,4278255564,4278255615,4278242559,4278225151,4278207743,4278190335,4282646783,4287103231,4291559679,4294902015,4294901964,4294901896,4294901828],colors=[4294919168,4287102976,4278255360,
4278224896,4278251263,4278220680,4278225151,4278203272,4278190335,4278190216,4294902015,4287103112,4294967295,4280427042,4294967295],colorsCss="#04f #008 #0f0 #080 #fe0 #870 #f80 #830 #f00 #800 #f0f #808 #fff #222 #fff".split(" ");
class BlobDownloader{static freeURL(){BlobDownloader.blobURL&&(URL.revokeObjectURL(BlobDownloader.blobURL),BlobDownloader.blobURL=null)}static download(a,b,c=null){if(!BlobDownloader.supported||!a||!b)return!1;BlobDownloader.freeURL();if("string"===typeof a){if(!c)return!1;a=new Blob([a],{type:c})}if(BlobDownloader.saveAs)try{return BlobDownloader.saveAs.call(window.navigator,a,b),!0}catch(d){}c=document.createElement("a");BlobDownloader.blobURL=URL.createObjectURL(a);c.href=BlobDownloader.blobURL;
c.download=b;if(document.createEvent&&("MouseEvent"in window||"MouseEvents"in window))try{const d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null);c.dispatchEvent(d);return!0}catch(d){}c.click();return!0}}BlobDownloader.saveAs=window.saveAs||window.webkitSaveAs||window.mozSaveAs||window.msSaveAs||window.navigator.saveBlob||window.navigator.webkitSaveBlob||window.navigator.mozSaveBlob||window.navigator.msSaveBlob;
BlobDownloader.supported=!!androidWrapper||"Blob"in window&&"URL"in window&&"createObjectURL"in window.URL&&"revokeObjectURL"in window.URL;BlobDownloader.blobURL=null;class Point{static revive(a){const b=new Point;b.x=parseInt(a.x);b.y=parseInt(a.y);if(isNaN(b.x)||isNaN(b.y))throw Error("Invalid point coordinates");return b}}
class Polygon{static revive(a){const b=new Polygon;b.points=[];if(a.points&&a.points.length)for(let c=a.points.length-1;0<=c;c--)b.points[c]=Point.revive(a.points[c]);if(2>b.points.length)throw Error("Polygon has fewer than two points");return b}}function removeSemiAlpha(a,b){var c=parseInt(a.width.toString());a=parseInt(a.height.toString());c=b.getImageData(0,0,c,a);a=c.data;for(let d=a.length-4;0<=d;d-=4)255!==a[d+3]&&(a[d]=0,a[d+1]=0,a[d+2]=0,a[d+3]=0);b.putImageData(c,0,0)}
function loadImage(a,b=!0){return __awaiter(this,void 0,void 0,function*(){if(!a)return null;b&&(View.loading=!0);return new Promise((c,d)=>{const e=new Image;e.onload=()=>{b&&(View.loading=!1);c(e)};e.onerror=(f,g,h,l,m)=>{b&&(View.loading=!1);d(m||f)};e.src=a})})}function setContextQuality(a,b){try{"imageSmoothingEnabled"in this.context&&(this.context.imageSmoothingEnabled=b),"imageSmoothingQuality"in this.context&&(this.context.imageSmoothingQuality=b?"high":"low")}catch(c){}}
function processImage(a,b,c){var d=cLib.HEAP8.buffer,e=parseInt(a.width.toString()),f=parseInt(a.height.toString()),g=b.getImageData(0,0,e,f),h=g.data;const l=[];var m=(baseWidth+2)*(maxHeight+2)>>1;const k=cLib._allocateImageInfo(e,f);a=0;try{var n=new Uint8Array(d,cLib._getImageInfoData(k),h.length);const y=new Int32Array(d,cLib._getImageInfoPoints(k),m<<1);window.createPolygon=q=>{const p=new Polygon;p.points=Array(q);for(q=q-1<<1;0<=q;q-=2){const r=new Point;r.x=y[q];r.y=y[q+1];p.points[q>>1]=
r}l.push(p)};n.set(h,0);a=cLib._processImage(k);h.set(n,0);window.createPolygon=null}finally{cLib._freeImageInfo(k)}b.putImageData(g,0,0);if(c){c=b.fillStyle;d=b.strokeStyle;n=b.lineWidth;g=b.globalCompositeOperation;b.fillStyle="rgba(0,0,0,0.5)";b.strokeStyle="rgba(0,255,0,0.8)";b.lineWidth=1;b.globalCompositeOperation="source-over";b.fillRect(0,0,e,f);f=e=0;for(f=l.length-1;0<=f;f--){b.beginPath();h=l[f].points;e+=h.length;b.moveTo(h[0].x+.5,h[0].y+.5);for(m=1;m<h.length;m++)b.lineTo(h[m].x+.5,
h[m].y+.5);b.lineTo(h[0].x+.5,h[0].y+.5);b.stroke()}b.fillStyle="rgba(255,0,0,0.5)";for(f=l.length-1;0<=f;f--)for(h=l[f].points,m=h.length-1;0<=m;m--)b.fillRect(h[m].x-1,h[m].y-1,3,3);alert(`point count ${e} / polygon count ${l.length} / maxY ${a}`);b.fillStyle=c;b.strokeStyle=d;b.lineWidth=n;b.globalCompositeOperation=g}return[l,a]}class Resource{load(){this.loaded||this.loadInternal()}release(){this.loaded&&this.releaseInternal()}destroy(){this.release();this.destroyInternal()}}
class ResourceStorage{constructor(){this._count=0;this.resources={}}get count(){return this._count}contains(a){return a in this.resources}add(a,b){if(!a||!b)throw Error("Invalid resource");if(a in this.resources)throw Error("Name already exists");this.resources[a]=b;this._count++}getAndRemove(a){const b=this.resources[a];return b?(delete this.resources[a],this._count--,b):null}get(a){return this.resources[a]}get loaded(){if(this.resources){for(let a in this.resources)if(!this.resources[a].loaded)return!1;
return!!this._count}return!1}load(){if(this.resources)for(let a in this.resources)this.resources[a].load()}release(){if(this.resources)for(let a in this.resources)this.resources[a].release()}destroy(){if(this.resources){for(let a in this.resources)this.resources[a].destroy();this.resources=null}}}class ModelCoordinates{constructor(a){this.ptr=a}setCoordinates(a,b,c,d){const e=this.ptr>>2;cLib.HEAPF32[e]=a?-a:0;cLib.HEAPF32[e+1]=b?-b:0;cLib.HEAPF32[e+2]=c-a;cLib.HEAPF32[e+3]=d-b}}
class TextureCoordinates{constructor(a){this.ptr=a}setCoordinates(a,b,c,d){const e=this.ptr>>2;c=a+c;d=b+d;cLib.HEAPF32[e]=a<<9|b<<1;cLib.HEAPF32[e+1]=a<<9|d<<1;cLib.HEAPF32[e+2]=c<<9|b<<1;cLib.HEAPF32[e+3]=c<<9|d<<1}}
class Texture extends Resource{constructor(a,b,c=0,d=0){super();this.gl=null;this._height=this._width=0;this._texture=this._image=null;this.gl=a;this.bindImage(b,c,d)}get width(){return this._width}get height(){return this._height}get image(){return this._image}get texture(){return this._texture}get loaded(){return!!this._texture}loadInternal(){this._image&&this.bindImage(this._image,this._width,this._height)}releaseInternal(){this.gl.context.deleteTexture(this._texture);this._texture=null}destroyInternal(){this.gl=
this._image=null}bindImage(a,b,c){this.release();b=a?a.width:b;c=a?a.height:c;this._width=b;this._height=c;this._image=a;const d=this.gl.context;if(d){if(0>=b||0>=c)throw Error(`Invalid image size: ${b} x ${c}`);var e=Math.min(4096,d.getParameter(d.MAX_TEXTURE_SIZE));if(b>e||c>e)throw Error(`Image size too large: ${b} x ${c} / max: ${e}`);this.gl.clearErrors();e=d.createTexture();if(!e)throw Error(`Null texture: ${d.getError()}`);this._texture=e;d.bindTexture(d.TEXTURE_2D,e);a?d.texImage2D(d.TEXTURE_2D,
0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,a):d.texImage2D(d.TEXTURE_2D,0,d.RGBA,b,c,0,d.RGBA,d.UNSIGNED_BYTE,null);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);this.gl.throwIfError();d.bindTexture(d.TEXTURE_2D,null)}}}
class WebGL{constructor(){this.framebufferTextureViewHeight=this.framebufferTextureViewWidth=this.viewHeight=this.viewWidth=0;this.uniformViewConstants=this.currentTexture=this.indexBuffer=this.vertexBuffer=this.fragmentShader=this.vertexShader=this.program=null;this.verticesPtr=this.rectangleCount=0;this.context=this.vertices=null;this.contextVersion=0;this.framebufferTexture=this.framebuffer=null}clearErrors(){const a=this.context;let b=3;for(;a.getError()!==a.NO_ERROR&&0<b--;)a.getError()}throwIfError(a=
1){const b=this.context.getError();if(!a||b!==this.context.NO_ERROR)throw Error("WebGL error: "+b);}prepareNativeDraw(a){this.flush();this.currentTexture=a}drawNative(a){this.rectangleCount=a;this.flush()}checkRecreate(a){return!this.context||this.context.isContextLost()||a.width!==this.viewWidth||a.height!==this.viewHeight}static nextPowerOfTwo(a){if(!(a&a-1))return a;a|=a>>>1;a|=a>>>2;a|=a>>>4;a|=a>>>8;return(a|a>>>16)+1}recreate(a,b,c){var d=a.width,e=a.height;this.destroy(!0);if(!isIOSOrSafari&&
"undefined"!==typeof WebGL2RenderingContext)try{this.context=a.getContext("webgl2",{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0}),this.contextVersion=2}catch(g){}if(!this.context)try{this.context=a.getContext("webgl",{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0}),this.contextVersion=1}catch(g){}this.context||(this.context=a.getContext("experimental-webgl",{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0}),this.contextVersion=1);if(!this.context)throw Error("WebGL apparently not supported");
a=this.context;this.clearErrors();this.viewWidth=d;this.viewHeight=e;d=this.program=a.createProgram();this.throwIfError(d);e=this.vertexShader=a.createShader(a.VERTEX_SHADER);this.throwIfError(e);a.shaderSource(e,2===this.contextVersion?WebGL.VertexShaderSource2:WebGL.VertexShaderSource);a.compileShader(e);if(!a.getShaderParameter(e,a.COMPILE_STATUS))throw Error("WebGL vertex shader compilation error: "+a.getShaderInfoLog(e));this.throwIfError();var f=this.fragmentShader=a.createShader(a.FRAGMENT_SHADER);
this.throwIfError(f);a.shaderSource(f,2===this.contextVersion?WebGL.FragmentShaderSource2:WebGL.FragmentShaderSource);a.compileShader(f);if(!a.getShaderParameter(f,a.COMPILE_STATUS))throw Error("WebGL fragment shader compilation error: "+a.getShaderInfoLog(f));this.throwIfError();a.attachShader(d,e);a.attachShader(d,f);a.linkProgram(d);a.useProgram(d);this.throwIfError();this.uniformViewConstants=a.getUniformLocation(d,"uViewConstants");a.activeTexture(a.TEXTURE0);a.uniform1i(a.getUniformLocation(d,
"uTexture"),0);this.throwIfError();a.disable(a.DEPTH_TEST);a.disable(a.CULL_FACE);a.disable(a.DITHER);a.disable(a.SCISSOR_TEST);a.disable(a.POLYGON_OFFSET_FILL);a.disable(a.SAMPLE_ALPHA_TO_COVERAGE);a.disable(a.SAMPLE_COVERAGE);a.disable(a.STENCIL_TEST);a.enable(a.BLEND);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);this.setDefaultComposition();this.throwIfError();this.vertexBuffer=a.createBuffer();this.vertexBuffer=a.createBuffer();this.indexBuffer=a.createBuffer();this.allocateRectangleBuffers();
e=WebGL.nextPowerOfTwo(b);f=WebGL.nextPowerOfTwo(c);b=Math.ceil(b*LevelSpriteSheet.TextureWidth/e);c=Math.ceil(c*LevelSpriteSheet.TextureHeight/f);this.framebufferTextureViewWidth=b*e/LevelSpriteSheet.TextureWidth|0;this.framebufferTextureViewHeight=c*f/LevelSpriteSheet.TextureHeight|0;this.framebufferTexture=new Texture(this,null,e,f);LevelSpriteSheet.FramebufferTextureCoordinates.setCoordinates(0,0,b,c);this.throwIfError();this.framebuffer=a.createFramebuffer();this.throwIfError();a.bindFramebuffer(a.FRAMEBUFFER,
this.framebuffer);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.framebufferTexture.texture,0);this.useFramebuffer(!1);c=a.getAttribLocation(d,"aPosition");b=a.getAttribLocation(d,"aAlphaTextureCoordinates");a.enableVertexAttribArray(c);a.enableVertexAttribArray(b);a.vertexAttribPointer(c,WebGL.FloatsPerPosition,a.FLOAT,!1,WebGL.BytesPerVertex,WebGL.BufferIndexPosition);a.vertexAttribPointer(b,WebGL.FloatsPerAlphaTextureCoordinates,a.FLOAT,!1,WebGL.BytesPerVertex,WebGL.BufferIndexAlphaTextureCoordinates)}destroy(a){const b=
this.context,c=this.verticesPtr,d=this.vertices;b&&(b.bindFramebuffer(b.FRAMEBUFFER,null),this.framebufferTexture&&this.framebufferTexture.destroy(),this.framebuffer&&b.deleteFramebuffer(this.framebuffer),this.program&&b.deleteProgram(this.program),this.vertexShader&&b.deleteShader(this.vertexShader),this.fragmentShader&&b.deleteShader(this.fragmentShader),this.vertexBuffer&&b.deleteBuffer(this.vertexBuffer),this.indexBuffer&&b.deleteBuffer(this.indexBuffer));zeroObject(this);a?(this.verticesPtr=
c,this.vertices=d):c&&cLib._freeBuffer(c)}flush(){const a=this.rectangleCount;if(a){var b=this.context;b.bufferSubData(b.ARRAY_BUFFER,0,this.vertices.subarray(0,WebGL.FloatsPerRectangle*a));b.bindTexture(b.TEXTURE_2D,this.currentTexture.texture);b.drawElements(b.TRIANGLES,6*a,b.UNSIGNED_SHORT,0);this.rectangleCount=0}}clearColor(a,b,c,d){this.context.clearColor(a,b,c,d)}checkForLostContextUseFrameBufferAndClear(){const a=this.context;if(!a)return!1;if(a.isContextLost())return this.destroy(!0),!1;
this.useFramebuffer(!0);a.clear(a.COLOR_BUFFER_BIT);return!0}setSumComposition(){const a=this.context;a.blendFunc(a.ONE,a.ONE)}setDefaultComposition(){const a=this.context;a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA)}allocateRectangleBuffers(){this.verticesPtr||(this.verticesPtr=cLib._allocateBuffer(WebGL.BytesPerRectangle*WebGL.RectangleCapacity),this.vertices=new Float32Array(cLib.HEAP8.buffer,this.verticesPtr,WebGL.FloatsPerRectangle*WebGL.RectangleCapacity));var a=6*WebGL.RectangleCapacity;const b=
new Uint16Array(a);for(let c=0,d=0;c<a;c+=6,d+=4)b[c]=d,b[c+1]=d+1,b[c+2]=d+2,b[c+3]=d+2,b[c+4]=d+1,b[c+5]=d+3;a=this.context;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer);a.bufferData(a.ELEMENT_ARRAY_BUFFER,b,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer);a.bufferData(a.ARRAY_BUFFER,this.vertices,a.DYNAMIC_DRAW);a.bufferSubData(a.ARRAY_BUFFER,0,this.vertices)}useFramebuffer(a){const b=this.context;let c;a?(b.bindFramebuffer(b.FRAMEBUFFER,this.framebuffer),a=this.framebufferTextureViewWidth,
c=this.framebufferTextureViewHeight):(b.bindFramebuffer(b.FRAMEBUFFER,null),a=this.viewWidth,c=this.viewHeight);b.uniform2f(this.uniformViewConstants,2/a,-2/c);b.viewport(0,0,a,c)}draw(a,b,c,d,e,f){if(this.currentTexture!==a||this.rectangleCount>=WebGL.RectangleCapacity)this.flush(),this.currentTexture=a;cLib._draw(this.verticesPtr+WebGL.BytesPerRectangle*this.rectangleCount,b.ptr,c,d.ptr,e,f);this.rectangleCount++}drawScale(a,b,c,d,e,f,g){if(this.currentTexture!==a||this.rectangleCount>=WebGL.RectangleCapacity)this.flush(),
this.currentTexture=a;cLib._drawScale(this.verticesPtr+WebGL.BytesPerRectangle*this.rectangleCount,b.ptr,c,d.ptr,e,f,g);this.rectangleCount++}drawRotate(a,b,c,d,e,f,g){if(this.currentTexture!==a||this.rectangleCount>=WebGL.RectangleCapacity)this.flush(),this.currentTexture=a;cLib._drawRotate(this.verticesPtr+WebGL.BytesPerRectangle*this.rectangleCount,b.ptr,c,d.ptr,e,f,g);this.rectangleCount++}drawScaleRotate(a,b,c,d,e,f,g,h){if(this.currentTexture!==a||this.rectangleCount>=WebGL.RectangleCapacity)this.flush(),
this.currentTexture=a;cLib._drawScaleRotate(this.verticesPtr+WebGL.BytesPerRectangle*this.rectangleCount,b.ptr,c,d.ptr,e,f,g,h);this.rectangleCount++}}WebGL.RectangleCapacity=512;WebGL.FloatsPerPosition=2;WebGL.FloatsPerAlphaTextureCoordinates=1;WebGL.FloatsPerVertex=WebGL.FloatsPerPosition+WebGL.FloatsPerAlphaTextureCoordinates;WebGL.BytesPerVertex=4*WebGL.FloatsPerVertex;WebGL.FloatsPerRectangle=4*WebGL.FloatsPerVertex;WebGL.BytesPerRectangle=4*WebGL.FloatsPerRectangle;
WebGL.BufferIndexPosition=0;WebGL.BufferIndexAlphaTextureCoordinates=4*WebGL.FloatsPerPosition;WebGL.VertexShaderSource2="#version 300 es\nprecision highp float;\nin vec2 aPosition;\nin float aAlphaTextureCoordinates;\nflat out lowp float vAlpha;\nout lowp vec2 vTextureCoordinates;\nuniform vec2 uViewConstants;\nconst vec2 uViewOffsets = vec2(-1.0, 1.0);\nvoid main() {\n\tgl_Position = vec4(aPosition * uViewConstants + uViewOffsets, 0.0, 1.0);\n\tvAlpha = mod(aAlphaTextureCoordinates, 2.0);\n\tvTextureCoordinates = floor(vec2(\n\t\taAlphaTextureCoordinates * 0.001953125,\n\t\tmod(aAlphaTextureCoordinates * 0.5, 256.0)\n\t)) * 0.0078125;\n}";
WebGL.VertexShaderSource="#version 100\nprecision highp float;\nattribute vec2 aPosition;\nattribute float aAlphaTextureCoordinates;\nvarying lowp float vAlpha;\nvarying lowp vec2 vTextureCoordinates;\nuniform vec2 uViewConstants;\nconst vec2 uViewOffsets = vec2(-1.0, 1.0);\nvoid main() {\n\tgl_Position = vec4(aPosition * uViewConstants + uViewOffsets, 0.0, 1.0);\n\tvAlpha = mod(aAlphaTextureCoordinates, 2.0);\n\tvTextureCoordinates = floor(vec2(\n\t\taAlphaTextureCoordinates * 0.001953125,\n\t\tmod(aAlphaTextureCoordinates * 0.5, 256.0)\n\t)) * 0.0078125;\n}";
WebGL.FragmentShaderSource2="#version 300 es\nprecision lowp float;\nflat in float vAlpha;\nin vec2 vTextureCoordinates;\nout vec4 color;\nuniform sampler2D uTexture;\nvoid main() {\n\tcolor = texture(uTexture, vTextureCoordinates) * vAlpha;\n}";WebGL.FragmentShaderSource="#version 100\nprecision lowp float;\nvarying float vAlpha;\nvarying vec2 vTextureCoordinates;\nuniform sampler2D uTexture;\nvoid main() {\n\tgl_FragColor = texture2D(uTexture, vTextureCoordinates) * vAlpha;\n}";
class UISpriteSheet{static resize(a){const b=parseInt(a.getAttribute(UISpriteSheet.SheetId)),c=b&255,d=b>>>8&255,e=b>>>16&255,f=b>>>24&255;a.style.backgroundSize=UISpriteSheet.BackgroundSizeCss;1===c?(a.style.width=iconSizeCss,a.style.height=iconSizeCss,a.style.backgroundPositionX=css(-((e<<4)+2)),a.style.backgroundPositionY=css(-((f<<4)+2))):(a.style.width=css(b===UISpriteSheet.ScrollThumb?24:c<<4),a.style.height=css(d<<4),a.style.backgroundPositionX=css(b===UISpriteSheet.ScrollThumb?-72:-(e<<4)),
a.style.backgroundPositionY=css(-(f<<4)))}static change(a,b){a.setAttribute(UISpriteSheet.SheetId,b.toString());UISpriteSheet.resize(a)}static create(a,b){const c=document.createElement("span");c.style.backgroundImage="url(assets/images/uiSheet.png)";UISpriteSheet.change(c,a);b&&b.appendChild(c);return c}static html(a){return`<span ${UISpriteSheet.SheetId}="${a}"></span>`}static finishHTMLCreation(a){a.style.backgroundImage="url(assets/images/uiSheet.png)";UISpriteSheet.change(a,parseInt(a.getAttribute(UISpriteSheet.SheetId)))}static windowResized(){UISpriteSheet.BackgroundSizeCss=
css(UISpriteSheet.TextureWidth)+" "+css(UISpriteSheet.TextureHeight)}}UISpriteSheet.TextureWidth=96;UISpriteSheet.TextureHeight=112;UISpriteSheet.BackgroundSizeCss=null;UISpriteSheet.SheetId="data-sheet-id";UISpriteSheet.Ball=257;UISpriteSheet.Goal=65793;UISpriteSheet.Bomb=131329;UISpriteSheet.Cucumber=196865;UISpriteSheet.Edit=262401;UISpriteSheet.Question=327937;UISpriteSheet.DeviceH=16777473;UISpriteSheet.DeviceV=16843009;UISpriteSheet.Hand=16908545;UISpriteSheet.Fullscreen=16974081;
UISpriteSheet.Restart=17039617;UISpriteSheet.Open=17105153;UISpriteSheet.Accept=33554689;UISpriteSheet.AcceptGreen=33620225;UISpriteSheet.Clear=33685761;UISpriteSheet.ClearRed=33751297;UISpriteSheet.Back=33816833;UISpriteSheet.Border=33882369;UISpriteSheet.LineWidth0=50331905;UISpriteSheet.LineWidth1=50397441;UISpriteSheet.LineWidth2=50462977;UISpriteSheet.LineWidth3=50528513;UISpriteSheet.ScrollThumb=50594562;UISpriteSheet.Eraser=67109121;UISpriteSheet.Rainbow=67174657;UISpriteSheet.Pause=67240193;
UISpriteSheet.Play=67305729;UISpriteSheet.PlayGreen=83886337;UISpriteSheet.Exit=83951873;UISpriteSheet.Menu=84017409;UISpriteSheet.Download=84082945;UISpriteSheet.Success=100663553;UISpriteSheet.Error=100729089;UISpriteSheet.Trophy=100794625;UISpriteSheet.Clock=100860161;UISpriteSheet.DeviceHI=100925697;UISpriteSheet.DeviceVI=100991233;
class LevelObject{constructor(a,b,c){switch(a){case LevelObject.TypeBall:case LevelObject.TypeGoal:case LevelObject.TypeBomb:case LevelObject.TypeCucumber:break;default:throw Error("Invalid level object type: "+a);}this.type=parseInt(a);this.radius=LevelObject.RadiusByType[this.type];this.move(parseInt(b)||0,parseInt(c)||0)}move(a,b){this.x=a<=iconRadius?iconRadius:a>baseWidth-iconRadius?baseWidth-iconRadius:a;this.y=b<=iconRadius?iconRadius:b>maxHeight-iconRadius?maxHeight-iconRadius:b}static revive(a){return new LevelObject(a.type,
a.x,a.y)}}LevelObject.TypeBall=0;LevelObject.TypeGoal=1;LevelObject.TypeBomb=2;LevelObject.TypeCucumber=3;LevelObject.TypeCount=4;LevelObject.VisibilityNone=0;LevelObject.VisibilityVisible=1;LevelObject.VisibilityAlive=2;LevelObject.VisibilityAll=LevelObject.VisibilityVisible|LevelObject.VisibilityAlive;LevelObject.FragmentsPerBall=64;LevelObject.FragmentsMaxTime=1.5;LevelObject.FragmentsMaxTimeSaved=3.5;LevelObject.VictoryFragmentCount=500;LevelObject.LastType=LevelObject.TypeCucumber;
LevelObject.RadiusByType=[6,5,5,6];LevelObject.ImagesByType=[UISpriteSheet.Ball,UISpriteSheet.Goal,UISpriteSheet.Bomb,UISpriteSheet.Cucumber];
class Level{constructor(){this.name="";this.modifiedAt=this.createdAt=0;this.width=baseWidth;this.height=maxHeight;this.processedImage=this.image=this.thumbnailImage="";this.polygons=[];this.objects=[];this.levelPtr=0}toJSON(){return this.toLevelFullInfo()}toLevelFullInfo(){return{name:this.name,createdAt:this.createdAt,modifiedAt:this.modifiedAt,width:this.width,height:this.height,thumbnailImage:this.thumbnailImage,image:this.image,processedImage:this.processedImage,polygons:this.polygons,objects:this.objects}}toLevelInfo(){return{name:this.name,
createdAt:this.createdAt,modifiedAt:this.modifiedAt,width:this.width,height:this.height,thumbnailImage:this.thumbnailImage}}static revive(a){const b=new Level;if(a&&("string"===typeof a&&(a=JSON.parse(a)),a))for(var c in b)"function"!==typeof b[c]&&(b[c]=a[c]);b.levelPtr=0;b.name=(b.name||"").trim();if(!b.createdAt||0>b.createdAt)b.createdAt=0;if(!b.modifiedAt||0>b.modifiedAt)b.modifiedAt=0;b.width=baseWidth;b.height=!b.height||b.height<=iconSize||b.height>maxHeight?maxHeight:parseInt(b.height.toString());
b.image||(b.image="");b.processedImage?b.image||(b.image=b.processedImage):b.processedImage="";b.thumbnailImage||(b.thumbnailImage="");if(b.polygons){if(b.polygons.length>Level.MaxPolygonCount)return null;a=0;for(c=b.polygons.length-1;0<=c;c--)if(b.polygons[c]=Polygon.revive(b.polygons[c]),a+=b.polygons[c].points.length,a>Level.MaxPointCount)return null}else b.polygons=[];if(b.objects){if(b.objects.length>Level.MaxObjectCount)return null;a=0;for(c=b.objects.length-1;0<=c;c--)if(b.objects[c]=LevelObject.revive(b.objects[c]),
b.objects[c].type===LevelObject.TypeBall&&(a++,a>Level.MaxBallCount))return null}else b.objects=[];return b}prepare(){return __awaiter(this,void 0,void 0,function*(){if(this.image&&(!this.processedImage||!this.thumbnailImage)){const c=yield loadImage(this.image),d=document.createElement("canvas");d.width=thumbnailWidth;d.height=thumbnailHeight;var a=d.getContext("2d",{alpha:!0});a.clearRect(0,0,d.width,d.height);a.drawImage(c,0,0,c.width>>2,c.height>>2);removeSemiAlpha(d,a);this.thumbnailImage=d.toDataURL("image/png");
d.width=baseWidth;d.height=maxHeight<=c.height?maxHeight:c.height;a.clearRect(0,0,d.width,d.height);a.drawImage(c,0,0);this.width=baseWidth;[this.polygons,this.height]=processImage(d,a,!1);this.height<iconSize?this.height=iconSize:(this.height++,this.height>maxHeight&&(this.height=maxHeight));if(this.polygons.length>Level.MaxPolygonCount)throw Error(Level.MaxPolygonCountMessage);a=0;for(var b=this.polygons.length-1;0<=b;b--)a+=this.polygons[b].points.length;if(a>Level.MaxPointCount)throw Error(Level.MaxPointCountMessage);
a=this.height;for(b=this.objects.length-1;0<=b;b--){const e=this.objects[b].y+iconRadius;this.height<e&&(this.height=e)}this.height>maxHeight&&(this.height=maxHeight);b=d;a!==d.height&&(b=document.createElement("canvas"),b.width=baseWidth,b.height=a,a=b.getContext("2d",{alpha:!0}),a.clearRect(0,0,b.width,b.height),a.drawImage(c,0,0),this.image=b.toDataURL("image/png"),a.clearRect(0,0,b.width,b.height),a.drawImage(d,0,0));this.processedImage=b.toDataURL("image/png")}})}viewResized(){this.levelPtr&&
cLib._viewResized(this.levelPtr,baseWidth,baseHeight)}createLevelPtr(){this.destroyLevelPtr();var a=this.polygons;const b=this.objects;let c=4;for(var d=a.length-1;0<=d;d--){var e=a[d].points.length;c+=2===e?1:e}d=this.objects.length;e=cLib.stackSave();var f=cLib.HEAP8.buffer,g=c<<3,h=d<<2,l=d<<3;const m=cLib.stackAlloc(g),k=cLib.stackAlloc(g),n=cLib.stackAlloc(g);g=cLib.stackAlloc(g);h=cLib.stackAlloc(h);const y=cLib.stackAlloc(l),q=cLib.stackAlloc(l);l=cLib.stackAlloc(l);var p=new Float32Array(f,
m,c);const r=new Float32Array(f,k,c),v=new Float32Array(f,n,c),w=new Float32Array(f,g,c),B=new Int32Array(f,h,d),C=new Float32Array(f,y,d),D=new Float32Array(f,q,d);f=new Float32Array(f,l,d);p[0]=-1;r[0]=-1;v[0]=this.width;w[0]=-1;p[1]=this.width;r[1]=-1;v[1]=this.width;w[1]=this.height;p[2]=this.width;r[2]=this.height;v[2]=-1;w[2]=this.height;p[3]=-1;r[3]=this.height;v[3]=-1;w[3]=-1;for(let A=0,t=4;A<a.length;A++){const u=a[A].points,z=u.length-1;for(let x=0;x<z;x++)p[t]=u[x].x,r[t]=u[x].y,v[t]=
u[x+1].x,w[t]=u[x+1].y,t++;1<z&&(p[t]=u[z].x,r[t]=u[z].y,v[t]=u[0].x,w[t]=u[0].y,t++)}for(a=0;a<d;a++)p=b[a],B[a]=p.type,C[a]=p.x,D[a]=p.y,f[a]=p.radius;this.levelPtr=cLib._init(this.height,baseWidth,baseHeight,c,m,k,n,g,d,h,y,q,l);cLib.stackRestore(e)}destroyLevelPtr(){this.levelPtr&&(cLib._destroy(this.levelPtr),this.levelPtr=0)}clearImage(){this.width=baseWidth;this.height=maxHeight;this.thumbnailImage=this.processedImage=this.image=""}clearObjects(){this.polygons=[];this.objects=[]}restart(){this.createLevelPtr()}step(a){this.levelPtr&&
cLib._step(this.levelPtr,ControlMode.accelerationX,ControlMode.accelerationY,ControlMode.mode,a)}}Level.MaxPolygonCountMessage="Level.MaxPolygonCount";Level.MaxPointCountMessage="Level.MaxPointCount";Level.MaxPolygonCount=5E3;Level.MaxPointCount=2E4;Level.MaxObjectCount=256;Level.MaxBallCount=40;
class LevelCache{static loadBuiltInLevels(){return new Promise((a,b)=>{LevelCache.BuiltInLevelIds?a():LevelCache.BuiltInLevelsLoadFinished=a})}static builtInLevelThumbnailPath(a){if(0>a||a>=LevelCache.BuiltInLevelThumbnails.length)throw Error("Invalid id");return LevelCache.BuiltInLevelThumbnails[a]}static loadBuiltInLevel(a){if(0>a||a>=LevelCache.BuiltInLevels.length)throw Error("Invalid id");try{return Level.revive(LevelCache.BuiltInLevels[a])}catch(b){return null}}static isNameValid(a){a=(a||"").trim();
return!!a&&!a.endsWith(LevelCache.LevelInfoExtension)&&!/^\.+$/.test(a)&&!/[\\\/\?\*:<>%]/.test(a)&&!/^\d+$/.test(a)}static getLevelNames(a=!0){return __awaiter(this,void 0,void 0,function*(){a&&(View.loading=!0);try{const b=yield(yield caches.open(LevelCache.CacheName)).keys();if(!b||!b.length)return[];const c=Array(b.length>>1),d=LevelCache.LevelInfoExtension;for(let e=b.length-1,f=0;0<=e;e--){const g=b[e].url;if(g.endsWith(d))continue;const h=g.lastIndexOf("/");c[f++]=decodeURIComponent(0>h?g:
g.substr(h+1))}c.sort();return c}catch(b){return[]}finally{a&&(View.loading=!1)}})}static loadLevelInfo(a,b=!0){return __awaiter(this,void 0,void 0,function*(){if(!LevelCache.isNameValid(a))throw Error("Invalid name");b&&(View.loading=!0);try{const c=yield(yield caches.open(LevelCache.CacheName)).match(encodeURIComponent(a+LevelCache.LevelInfoExtension));if(!c)return null;const d=yield c.text();if(!d)return null;try{return JSON.parse(d)}catch(e){return null}}catch(c){return null}finally{b&&(View.loading=
!1)}})}static saveLevel(a,b=!0){return __awaiter(this,void 0,void 0,function*(){if(!a||!LevelCache.isNameValid(a.name))throw Error("Invalid level");b&&(View.loading=!0);const c=a.thumbnailImage;try{const d=yield caches.open(LevelCache.CacheName);yield d.put(encodeURIComponent(a.name+LevelCache.LevelInfoExtension),new Response(new Blob([JSON.stringify(a.toLevelInfo())],{type:"application/json"})));a.thumbnailImage=null;yield d.put(encodeURIComponent(a.name),new Response(new Blob([JSON.stringify(a)],
{type:"application/json"})))}finally{a.thumbnailImage=c,b&&(View.loading=!1)}})}static loadLevel(a,b=!0){return __awaiter(this,void 0,void 0,function*(){if(!LevelCache.isNameValid(a))throw Error("Invalid name");b&&(View.loading=!0);try{const c=yield(yield caches.open(LevelCache.CacheName)).match(encodeURIComponent(a));if(!c)return null;const d=yield c.text();if(!d)return null;try{return Level.revive(d)}catch(e){return null}}finally{b&&(View.loading=!1)}})}static deleteLevel(a,b=!0){return __awaiter(this,
void 0,void 0,function*(){if(!LevelCache.isNameValid(a))throw Error("Invalid name");b&&(View.loading=!0);try{const c=yield caches.open(LevelCache.CacheName);yield c.delete(encodeURIComponent(a));yield c.delete(encodeURIComponent(a+LevelCache.LevelInfoExtension));LevelCache.deleteLevelRecord(a)}finally{b&&(View.loading=!1)}})}static downloadLevel(a,b=-1,c=!0){return __awaiter(this,void 0,void 0,function*(){if(!LevelCache.isNameValid(a))throw Error("Invalid name");if(!BlobDownloader.supported)return LevelCache.DownloadLevelError;
c&&(View.loading=!0);try{let d,e;if(0<=b&&b<LevelCache.BuiltInLevels.length)d=LevelCache.BuiltInLevels[b],e=d.indexOf('"name":"')+8,d=d.substr(0,e)+a+d.substr(d.indexOf('"',e));else{const f=yield(yield caches.open(LevelCache.CacheName)).match(encodeURIComponent(a));if(!f)return LevelCache.DownloadLevelError;d=yield f.text();if(!d)return LevelCache.DownloadLevelError}a+=".json";e=d.indexOf('"processedImage":');if(0<=e&&(e+=17,'"'===d.charAt(e))){const f=d.indexOf('"',e+1);f>e&&(d=d.substr(0,e)+"null"+
d.substr(f+1))}e=d.indexOf('"thumbnailImage":');if(0<=e&&(e+=17,'"'===d.charAt(e))){const f=d.indexOf('"',e+1);f>e&&(d=d.substr(0,e)+"null"+d.substr(f+1))}e=d.indexOf('"polygons":');if(0<=e&&(e+=11,"["===d.charAt(e))){let f=d.indexOf("],",e+1);f>e?d=d.substr(0,e)+"null"+d.substr(f+1):(f=d.indexOf("}]}]}",e+1),f>e&&(d=d.substr(0,e)+"null"+d.substr(f+4)))}return androidWrapper?androidWrapper.downloadLevel(a,d,null):BlobDownloader.download(d,a,"application/json")?LevelCache.DownloadLevelSuccess:LevelCache.DownloadLevelError}catch(d){return LevelCache.DownloadLevelError}finally{c&&
(View.loading=!1)}})}static downloadLevelImage(a,b,c=!0){return __awaiter(this,void 0,void 0,function*(){LevelCache.isNameValid(a)||(a=Strings.Level);if(!BlobDownloader.supported)return LevelCache.DownloadLevelError;c&&(View.loading=!0);try{a+=".png";if(androidWrapper){let d=b.toDataURL("image/png");const e=d.indexOf("data:image/png;base64,");0<=e&&(d=d.substr(e+22));return androidWrapper.downloadLevel(a,null,d)}return new Promise((d,e)=>{b.toBlob(f=>{d(f&&BlobDownloader.download(f,a,"image/png")?
LevelCache.DownloadLevelSuccess:LevelCache.DownloadLevelError)},"image/png")})}catch(d){return LevelCache.DownloadLevelError}finally{c&&(View.loading=!1)}})}static renameLevel(a,b,c=!0){return __awaiter(this,void 0,void 0,function*(){if(!LevelCache.isNameValid(a)||!LevelCache.isNameValid(b))throw Error("Invalid name");c&&(View.loading=!0);try{const d=yield LevelCache.loadLevel(a,!1),e=yield LevelCache.loadLevelInfo(a,!1);if(!d||!e)return!1;d.name=b;d.thumbnailImage=e.thumbnailImage;yield LevelCache.saveLevel(d,
!1);yield LevelCache.deleteLevel(a,!1);return!0}finally{c&&(View.loading=!1)}})}static sendLevelToEditor(a,b=null,c=!0){return __awaiter(this,void 0,void 0,function*(){if(!a&&!b||a&&b||a&&!LevelCache.isNameValid(a))throw Error("Invalid level");c&&(View.loading=!0);try{let d=null;if(a){const e=yield(yield caches.open(LevelCache.CacheName)).match(encodeURIComponent(a));if(!e)return!1;d=yield e.text()}else d=JSON.stringify(b);if(!d)return!1;localStorage.setItem(LevelCache.EditorLevelName,d);return!0}finally{c&&
(View.loading=!1)}})}static loadEditorLevel(){return Level.revive(localStorage.getItem(LevelCache.EditorLevelName))}static saveEditorLevel(a){a?localStorage.setItem(LevelCache.EditorLevelName,JSON.stringify(a)):localStorage.removeItem(LevelCache.EditorLevelName)}static loadLevelFromOptions(a){return __awaiter(this,void 0,void 0,function*(){return a?a.level||(a.levelName?yield LevelCache.loadLevel(a.levelName,!1):LevelCache.loadBuiltInLevel(a.levelId)):LevelCache.loadEditorLevel()})}static getLevelRecord(a){if(!LevelCache.LevelRecords){try{var b=
localStorage.getItem(LevelCache.LevelRecordsName);b&&(LevelCache.LevelRecords=JSON.parse(b))}catch(c){}if(LevelCache.LevelRecords)for(let c in LevelCache.LevelRecords){if(b=LevelCache.LevelRecords[c])if(0<=b.fmt.indexOf(Strings.OppositeDecimalSeparator))b.fmt=b.fmt.replace(Strings.OppositeDecimalSeparator,Strings.DecimalSeparator);else break}else LevelCache.LevelRecords={};LevelCache.LastRecordName=localStorage.getItem(LevelCache.LastRecordNameName)}return LevelCache.LevelRecords[a]||null}static setLevelRecord(a,
b,c){const d=LevelCache.getLevelRecord(a);c=c?c.trim():"";d?(d.time=b,d.name=c||"-",d.fmt=LevelCache.formatLevelRecordTime(b)):LevelCache.LevelRecords[a]={time:b,name:c||"-",fmt:LevelCache.formatLevelRecordTime(b)};localStorage.setItem(LevelCache.LevelRecordsName,JSON.stringify(LevelCache.LevelRecords));LevelCache.LastRecordName!==c&&localStorage.setItem(LevelCache.LastRecordNameName,LevelCache.LastRecordName=c)}static deleteLevelRecord(a){LevelCache.getLevelRecord(a)&&(delete LevelCache.LevelRecords[a],
localStorage.setItem(LevelCache.LevelRecordsName,JSON.stringify(LevelCache.LevelRecords)))}static formatLevelRecordTime(a){if(!a||0>a)return"-";a=a/10|0;99999<a&&(a=99999);return(a/100|0)+Strings.DecimalSeparator+format2(a%100)+" s"}}LevelCache.DownloadLevelSuccess=1;LevelCache.DownloadLevelError=0;LevelCache.DownloadLevelNoPermission=-1;LevelCache.DownloadLevelFileAlreadyExists=-2;LevelCache.BuiltInLevelIds=null;LevelCache.BuiltInLevels=null;LevelCache.BuiltInLevelThumbnails=null;
LevelCache.BuiltInLevelsLoadFinished=null;LevelCache.LevelInfoExtension=".levelinfo";LevelCache.CacheName="pixel-level-cache";LevelCache.EditorLevelName="pixel-editor-level";LevelCache.LastRecordNameName="pixel-editor-last-name";LevelCache.LevelRecordsName="pixel-editor-level-records";LevelCache.LevelRecords=null;LevelCache.LastRecordName=null;
class LevelSpriteSheet{static allocateCoordinates(){let a=cLib._initLevelSpriteSheet();LevelSpriteSheet.LevelSpriteSheetPtr=a;LevelSpriteSheet.LevelModelCoordinates=new ModelCoordinates(a);a+=16;LevelSpriteSheet.FullTextureCoordinates=new TextureCoordinates(a);a+=16;LevelSpriteSheet.FramebufferTextureCoordinates=new TextureCoordinates(a);a+=16;for(var b=0;b<LevelSpriteSheet.BackgroundModelCoordinates.length;b++)LevelSpriteSheet.BackgroundModelCoordinates[b]=new ModelCoordinates(a),a+=16;for(b=0;b<
LevelSpriteSheet.BackgroundTextureCoordinates.length;b++)LevelSpriteSheet.BackgroundTextureCoordinates[b]=new TextureCoordinates(a),a+=16;LevelSpriteSheet.LevelObjectModelCoordinates=new ModelCoordinates(a);a+=16;for(b=0;b<LevelSpriteSheet.LevelObjectTextureCoordinatesByType.length;b++)LevelSpriteSheet.LevelObjectTextureCoordinatesByType[b]=new TextureCoordinates(a),a+=16;LevelSpriteSheet.FullViewModelCoordinates=new ModelCoordinates(a);a+=16;LevelSpriteSheet.ExplosionBgTextureCoordinates=new TextureCoordinates(a);
a+=16;LevelSpriteSheet.FadeBgModelCoordinates=new ModelCoordinates(a);a+=16;LevelSpriteSheet.FadeBgTextureCoordinates=new TextureCoordinates(a);a+=16;LevelSpriteSheet.FadeBgSadTextureCoordinates=new TextureCoordinates(a);a+=16;for(b=0;b<LevelSpriteSheet.FragmentModelCoordinates.length;b++)LevelSpriteSheet.FragmentModelCoordinates[b]=new ModelCoordinates(a),a+=16;for(b=0;b<LevelSpriteSheet.FragmentTextureCoordinates.length;b++)LevelSpriteSheet.FragmentTextureCoordinates[b]=new TextureCoordinates(a),
a+=16;LevelSpriteSheet.CursorCenterModelCoordinates=new ModelCoordinates(a);a+=16;LevelSpriteSheet.CursorCenterTextureCoordinates=new TextureCoordinates(a);a+=16;LevelSpriteSheet.CursorTargetModelCoordinates=new ModelCoordinates(a);a+=16;LevelSpriteSheet.CursorTargetTextureCoordinates=new TextureCoordinates(a);a+=16;LevelSpriteSheet.FaceModelCoordinates=new ModelCoordinates(a);a+=16;LevelSpriteSheet.SadFaceTextureCoordinates=new TextureCoordinates(a);LevelSpriteSheet.HappyFaceTextureCoordinates=new TextureCoordinates(a+
16)}static setupFixedCoordinates(){LevelSpriteSheet.FullTextureCoordinates.setCoordinates(0,0,LevelSpriteSheet.TextureWidth,LevelSpriteSheet.TextureHeight);const a=LevelSpriteSheet.BackgroundScale,b=LevelSpriteSheet.BackgroundScaleRightShift,c=baseWidth<<1>>b,d=Math.ceil(Math.sqrt(2)*(baseWidth>>b));LevelSpriteSheet.BackgroundModelCoordinates[0].setCoordinates(c>>b,-.4*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[1].setCoordinates(c>>b,-.38*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[2].setCoordinates(c>>
b,-.36*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[3].setCoordinates(c>>b,-.34*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[4].setCoordinates(c>>b,-.32*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[5].setCoordinates(c>>b,-.3*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[6].setCoordinates(c>>b,-.28*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[7].setCoordinates(c>>b,-.26*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[8].setCoordinates(c>>
b,-.24*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[9].setCoordinates(c>>b,-.2*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[10].setCoordinates(c>>b,-.16*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[11].setCoordinates(c>>b,-.12*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[12].setCoordinates(c>>b,-.08*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[13].setCoordinates(c>>b,-.04*a*baseWidth,c,d);LevelSpriteSheet.BackgroundModelCoordinates[14].setCoordinates(c>>
b,-0*a*baseWidth,c,d);LevelSpriteSheet.BackgroundTextureCoordinates[0].setCoordinates(3,53,2,72);LevelSpriteSheet.BackgroundTextureCoordinates[1].setCoordinates(9,53,2,72);LevelSpriteSheet.BackgroundTextureCoordinates[2].setCoordinates(15,53,2,72);LevelSpriteSheet.BackgroundTextureCoordinates[3].setCoordinates(21,53,2,72);LevelSpriteSheet.BackgroundTextureCoordinates[4].setCoordinates(27,53,2,72);LevelSpriteSheet.BackgroundTextureCoordinates[5].setCoordinates(33,53,2,72);LevelSpriteSheet.BackgroundTextureCoordinates[6].setCoordinates(39,
53,2,72);LevelSpriteSheet.BackgroundTextureCoordinates[7].setCoordinates(45,53,2,72);LevelSpriteSheet.LevelObjectTextureCoordinatesByType[LevelObject.TypeBall].setCoordinates(2,2,iconSize,iconSize);LevelSpriteSheet.LevelObjectTextureCoordinatesByType[LevelObject.TypeGoal].setCoordinates(18,2,iconSize,iconSize);LevelSpriteSheet.LevelObjectTextureCoordinatesByType[LevelObject.TypeBomb].setCoordinates(34,2,iconSize,iconSize);LevelSpriteSheet.LevelObjectTextureCoordinatesByType[LevelObject.TypeCucumber].setCoordinates(50,
2,iconSize,iconSize);LevelSpriteSheet.ExplosionBgTextureCoordinates.setCoordinates(36,20,8,8);LevelSpriteSheet.FadeBgTextureCoordinates.setCoordinates(52,20,8,8);LevelSpriteSheet.FadeBgSadTextureCoordinates.setCoordinates(52,36,8,8);LevelSpriteSheet.FragmentTextureCoordinates[0].setCoordinates(2,17,3,3);LevelSpriteSheet.FragmentTextureCoordinates[1].setCoordinates(7,17,3,3);LevelSpriteSheet.FragmentTextureCoordinates[2].setCoordinates(12,17,3,4);LevelSpriteSheet.FragmentTextureCoordinates[3].setCoordinates(2,
22,3,3);LevelSpriteSheet.FragmentTextureCoordinates[4].setCoordinates(7,22,3,4);LevelSpriteSheet.FragmentTextureCoordinates[5].setCoordinates(12,23,3,4);LevelSpriteSheet.FragmentTextureCoordinates[6].setCoordinates(2,27,3,4);LevelSpriteSheet.FragmentTextureCoordinates[7].setCoordinates(7,28,3,3);LevelSpriteSheet.FragmentTextureCoordinates[8].setCoordinates(18,17,3,3);LevelSpriteSheet.FragmentTextureCoordinates[9].setCoordinates(23,17,3,3);LevelSpriteSheet.FragmentTextureCoordinates[10].setCoordinates(28,
17,3,4);LevelSpriteSheet.FragmentTextureCoordinates[11].setCoordinates(18,22,3,3);LevelSpriteSheet.FragmentTextureCoordinates[12].setCoordinates(23,22,3,4);LevelSpriteSheet.FragmentTextureCoordinates[13].setCoordinates(28,23,3,4);LevelSpriteSheet.FragmentTextureCoordinates[14].setCoordinates(18,27,3,4);LevelSpriteSheet.FragmentTextureCoordinates[15].setCoordinates(23,28,3,3);LevelSpriteSheet.CursorCenterTextureCoordinates.setCoordinates(66,2,LevelSpriteSheet.CursorCenterSize,LevelSpriteSheet.CursorCenterSize);
LevelSpriteSheet.CursorTargetTextureCoordinates.setCoordinates(98,2,LevelSpriteSheet.CursorTargetSize,LevelSpriteSheet.CursorTargetSize);LevelSpriteSheet.SadFaceTextureCoordinates.setCoordinates(96,32,31,31);LevelSpriteSheet.HappyFaceTextureCoordinates.setCoordinates(96,80,31,31)}static recreateIfNecessary(){const a=scaleFactor,b=baseWidth*a,c=baseHeight*a;LevelSpriteSheet.scaleFactor===scaleFactor&&LevelSpriteSheet.LevelModelCoordinates?LevelSpriteSheet.FullViewModelCoordinates.setCoordinates(0,
0,b,c):(LevelSpriteSheet.scaleFactor=scaleFactor,LevelSpriteSheet.LevelModelCoordinates||(LevelSpriteSheet.allocateCoordinates(),LevelSpriteSheet.setupFixedCoordinates()),LevelSpriteSheet.LevelObjectModelCoordinates.setCoordinates(iconRadius*a,iconRadius*a,iconSize*a,iconSize*a),LevelSpriteSheet.FullViewModelCoordinates.setCoordinates(0,0,b,c),LevelSpriteSheet.FadeBgModelCoordinates.setCoordinates(0,0,8*a,8*a),LevelSpriteSheet.FragmentModelCoordinates[0].setCoordinates(1*a,1*a,3*a,3*a),LevelSpriteSheet.FragmentModelCoordinates[1].setCoordinates(1*
a,1*a,3*a,3*a),LevelSpriteSheet.FragmentModelCoordinates[2].setCoordinates(1*a,2*a,3*a,4*a),LevelSpriteSheet.FragmentModelCoordinates[3].setCoordinates(1*a,1*a,3*a,3*a),LevelSpriteSheet.FragmentModelCoordinates[4].setCoordinates(1*a,2*a,3*a,4*a),LevelSpriteSheet.FragmentModelCoordinates[5].setCoordinates(1*a,2*a,3*a,4*a),LevelSpriteSheet.FragmentModelCoordinates[6].setCoordinates(1*a,2*a,3*a,4*a),LevelSpriteSheet.FragmentModelCoordinates[7].setCoordinates(1*a,1*a,3*a,3*a),LevelSpriteSheet.CursorCenterModelCoordinates.setCoordinates(.5*
LevelSpriteSheet.CursorCenterSize*a|0,.5*LevelSpriteSheet.CursorCenterSize*a|0,LevelSpriteSheet.CursorCenterSize*a,LevelSpriteSheet.CursorCenterSize*a),LevelSpriteSheet.CursorTargetModelCoordinates.setCoordinates(.5*LevelSpriteSheet.CursorTargetSize*a|0,.5*LevelSpriteSheet.CursorTargetSize*a|0,LevelSpriteSheet.CursorTargetSize*a,LevelSpriteSheet.CursorTargetSize*a),LevelSpriteSheet.FaceModelCoordinates.setCoordinates(15*a,15*a,31*a,31*a))}static preload(){return __awaiter(this,void 0,void 0,function*(){LevelSpriteSheet.image||
(LevelSpriteSheet.image=yield loadImage("assets/images/sheet.png"))})}static createTexture(a){return new Texture(a,LevelSpriteSheet.image)}}LevelSpriteSheet.TextureWidth=128;LevelSpriteSheet.TextureHeight=128;LevelSpriteSheet.CursorCenterSize=25;LevelSpriteSheet.CursorTargetSize=25;LevelSpriteSheet.LevelSpriteSheetPtr=0;LevelSpriteSheet.BackgroundCount=15;LevelSpriteSheet.BackgroundScale=.5;LevelSpriteSheet.BackgroundScaleRightShift=1;LevelSpriteSheet.LevelModelCoordinates=null;
LevelSpriteSheet.FullTextureCoordinates=null;LevelSpriteSheet.FramebufferTextureCoordinates=null;LevelSpriteSheet.BackgroundModelCoordinates=Array(LevelSpriteSheet.BackgroundCount);LevelSpriteSheet.BackgroundTextureCoordinates=Array(8);LevelSpriteSheet.LevelObjectModelCoordinates=null;LevelSpriteSheet.LevelObjectTextureCoordinatesByType=Array(LevelObject.TypeCount);LevelSpriteSheet.FullViewModelCoordinates=null;LevelSpriteSheet.ExplosionBgTextureCoordinates=null;
LevelSpriteSheet.FadeBgModelCoordinates=null;LevelSpriteSheet.FadeBgTextureCoordinates=null;LevelSpriteSheet.FadeBgSadTextureCoordinates=null;LevelSpriteSheet.FragmentModelCoordinates=Array(8);LevelSpriteSheet.FragmentTextureCoordinates=Array(16);LevelSpriteSheet.CursorCenterModelCoordinates=null;LevelSpriteSheet.CursorCenterTextureCoordinates=null;LevelSpriteSheet.CursorTargetModelCoordinates=null;LevelSpriteSheet.CursorTargetTextureCoordinates=null;LevelSpriteSheet.FaceModelCoordinates=null;
LevelSpriteSheet.SadFaceTextureCoordinates=null;LevelSpriteSheet.HappyFaceTextureCoordinates=null;LevelSpriteSheet.image=null;LevelSpriteSheet.scaleFactor=0;
class ControlMode{static get mode(){return ControlMode._mode}static get accelerationSupported(){return ControlMode._accelerationSupported}static get modeImage(){return ControlMode.ImagesByMode[ControlMode._mode]}static toggleMode(){let a=ControlMode._mode+1;if(a>ControlMode.AccelerometerVI||!ControlMode._accelerationSupported)a=ControlMode.Pointer;ControlMode._mode=a;localStorage.setItem(ControlMode.ControlModeName,a.toString());ControlMode.prepare()}static init(){ControlMode._accelerationSupported=
androidWrapper&&androidWrapper.isSupported()||"DeviceMotionEvent"in window;if(ControlMode._accelerationSupported){const a=parseInt(localStorage.getItem(ControlMode.ControlModeName));ControlMode._mode=isNaN(a)||a<ControlMode.Pointer||a>ControlMode.AccelerometerVI?ControlMode.Pointer:a}else ControlMode._mode=ControlMode.Pointer;ControlMode.prepare()}static prepare(){window.removeEventListener("devicemotion",ControlMode.deviceMotion);ControlMode.invertXY=ControlMode._mode===ControlMode.AccelerometerV||
ControlMode._mode===ControlMode.AccelerometerVI;ControlMode.invertSign=ControlMode._mode===ControlMode.AccelerometerHI||ControlMode._mode===ControlMode.AccelerometerVI;ControlMode._mode!==ControlMode.Pointer&&window.addEventListener("devicemotion",ControlMode.deviceMotion)}static processAndroidAcceleration(){if(ControlMode.skipAndroid)ControlMode.skipAndroid=!1;else{ControlMode.skipAndroid=!0;if(ControlMode.invertXY){var a=androidWrapper.getY();var b=androidWrapper.getX()}else a=-androidWrapper.getX(),
b=androidWrapper.getY();ControlMode.invertSign&&(a=-a,b=-b);-.3<a&&.3>a&&(a=0);-.3<b&&.3>b&&(b=0);ControlMode.accelerationX=.8*ControlMode.accelerationX+.2*a;ControlMode.accelerationY=.8*ControlMode.accelerationY+.2*b}}static deviceMotion(a){var b=a.accelerationIncludingGravity;ControlMode.invertXY?(a=b.y,b=b.x):(a=-b.x,b=b.y);ControlMode.invertSign&&(a=-a,b=-b);-.3<a&&.3>a&&(a=0);-.3<b&&.3>b&&(b=0);ControlMode.accelerationX=.8*ControlMode.accelerationX+.2*a;ControlMode.accelerationY=.8*ControlMode.accelerationY+
.2*b}}ControlMode.ControlModeName="pixel-control-mode";ControlMode.ImagesByMode=[UISpriteSheet.Hand,UISpriteSheet.DeviceH,UISpriteSheet.DeviceV,UISpriteSheet.DeviceHI,UISpriteSheet.DeviceVI];ControlMode.Pointer=0;ControlMode.AccelerometerH=1;ControlMode.AccelerometerV=2;ControlMode.AccelerometerHI=3;ControlMode.AccelerometerVI=4;ControlMode._mode=ControlMode.Pointer;ControlMode._accelerationSupported=!1;ControlMode.skipAndroid=!1;ControlMode.invertXY=!1;ControlMode.invertSign=!1;
ControlMode.accelerationX=0;ControlMode.accelerationY=0;
class FullscreenControl{requestFullscreen(a){a||(a=document.body);let b=!0,c=null;try{"requestFullscreen"in a?c=a.requestFullscreen():"webkitRequestFullscreen"in a?c=a.webkitRequestFullscreen():"mozRequestFullScreen"in a?c=a.mozRequestFullScreen():"msRequestFullScreen"in a?c=a.msRequestFullScreen():b=!1}catch(d){b=!1}b||a===document.body?ignorePromise(c):this.requestFullscreen(null)}exitFullscreen(){let a=null;try{"exitFullscreen"in document?a=document.exitFullscreen():"webkitExitFullscreen"in document?
a=document.webkitExitFullscreen():"mozExitFullScreen"in document?a=document.mozExitFullScreen():"msExitFullscreen"in document&&(a=document.msExitFullscreen())}catch(b){}ignorePromise(a)}get fullscreenElement(){let a=null;try{"fullscreenElement"in document&&(a=document.fullscreenElement),!a&&"webkitFullscreenElement"in document&&(a=document.webkitFullscreenElement),!a&&"mozFullscreenElement"in document&&(a=document.mozFullscreenElement),!a&&"msFullscreenElement"in document&&(a=document.msFullscreenElement)}catch(b){}return a}get onfullscreenchange(){try{if("onfullscreenchange"in
document)return document.onfullscreenchange;if("onwebkitfullscreenchange"in document)return document.onwebkitfullscreenchange;if("onmozfullscreenchange"in document)return document.onmozfullscreenchange;if("onmsfullscreenchange"in document)return document.onmsfullscreenchange}catch(a){}return null}set onfullscreenchange(a){try{"onfullscreenchange"in document&&(document.onfullscreenchange=a),"onwebkitfullscreenchange"in document&&(document.onwebkitfullscreenchange=a),"onmozfullscreenchange"in document&&
(document.onmozfullscreenchange=a),"onmsfullscreenchange"in document&&(document.onmsfullscreenchange=a)}catch(b){}}toggleFullscreen(){this.fullscreenMode=!this.fullscreenMode}get fullscreenMode(){return!!this.fullscreenElement}set fullscreenMode(a){a?this.requestFullscreen():this.exitFullscreen()}}const fullscreenControl=new FullscreenControl;
class PointerHandler{constructor(a,b=null,c=null,d=null){this.captured=!1;this.pointerId=-1;this.boundDocumentMove=this.boundDocumentUp=this.upCallback=this.moveCallback=this.downCallback=this.documentCancelEvent=this.documentUpEvent=this.documentMoveEvent=this.element=null;this.element=a;this.downCallback=b;this.moveCallback=c;this.upCallback=d;"onpointerdown"in a?(this.documentMoveEvent="pointermove",this.documentUpEvent="pointerup",this.documentCancelEvent="pointercancel",this.boundDocumentUp=
this.pointerUp.bind(this),this.boundDocumentMove=this.pointerMove.bind(this),a.onpointerdown=this.pointerDown.bind(this)):"ontouchstart"in a?(this.documentMoveEvent="touchmove",this.documentUpEvent="touchend",this.documentCancelEvent="touchcancel",this.boundDocumentUp=this.touchEnd.bind(this),this.boundDocumentMove=this.touchMove.bind(this),a.ontouchstart=this.touchStart.bind(this)):(this.documentMoveEvent="mousemove",this.documentUpEvent="mouseup",this.documentCancelEvent=null,this.boundDocumentUp=
this.mouseUp.bind(this),this.boundDocumentMove=this.mouseMove.bind(this),a.onmousedown=this.mouseDown.bind(this))}destroy(){this.mouseUp(null);zeroObject(this)}pointerDown(a){if(0<=this.pointerId&&"mouse"!==a.pointerType)return cancelEvent(a);const b=this.mouseDown(a);this.captured&&(this.pointerId=a.pointerId);return b}pointerMove(a){if(this.captured&&a.pointerId===this.pointerId)return this.mouseMove(a)}pointerUp(a){if(this.captured&&a.pointerId===this.pointerId)return this.pointerId=-1,this.mouseUp(a)}touchStart(a){if(!(1<
a.touches.length))return 0<=this.pointerId&&this.touchEnd(a),this.pointerId=1,a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,a=this.mouseDown(a),void 0===a&&(this.pointerId=-1),a}touchMove(a){if(this.captured&&!(1<a.touches.length))return a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,this.mouseMove(a)}touchEnd(a){if(this.captured&&!(0>this.pointerId))return this.pointerId=-1,this.mouseUp(a)}mouseDown(a){this.mouseUp(a);if(!(a.button||View.fading||a.target&&a.target!==
this.element)){if(this.downCallback&&!this.downCallback(a))return cancelEvent(a);this.captured=!0;document.body.addEventListener(this.documentMoveEvent,this.boundDocumentMove,!0);document.body.addEventListener(this.documentUpEvent,this.boundDocumentUp,!0);this.documentCancelEvent&&document.body.addEventListener(this.documentCancelEvent,this.boundDocumentUp,!0);return cancelEvent(a)}}mouseMove(a){if(this.captured)return this.moveCallback&&this.moveCallback(a),cancelEvent(a)}mouseUp(a){if(this.captured)return document.body.removeEventListener(this.documentUpEvent,
this.boundDocumentUp,!0),document.body.removeEventListener(this.documentMoveEvent,this.boundDocumentMove,!0),this.documentCancelEvent&&document.body.removeEventListener(this.documentCancelEvent,this.boundDocumentUp,!0),this.captured=!1,this.upCallback&&this.upCallback(a),cancelEvent(a)}}
class ScrollContainer{constructor(a,b=!1,c=null,d=null){this.boundDocumentWheel=this.containerPointerHandler=this.pointerHandler=this.scrollThumb=this.scrollContainer=this.container=this.parent=null;this.scrollThumbInitialTopCss=this.scrollThumbTopCss=this.scrollThumbTopPercent=this.scrollContainerTopCss=this.contentHeight=this.availableHeight=this.containerTopCss=this.pointerLastY=0;this.ignoreScroll=this.scrollThumbOnly=!1;d?(this.parent=d.parentNode,this.container=d):(this.parent=a,this.container=
document.createElement("div"),a.appendChild(this.container));this.container.className=b?"container":"container scrollable-container";this.scrollContainer=document.createElement("div");this.scrollContainer.className=c?"scroll-container "+c:"scroll-container";this.container.appendChild(this.scrollContainer);this.scrollThumb=UISpriteSheet.create(UISpriteSheet.ScrollThumb,this.parent);this.scrollThumb.className="scroll-thumb";this.boundDocumentWheel=this.documentWheel.bind(this);this.scrollThumbOnly=
b;b||(this.container.onscroll=this.containerScroll.bind(this))}get topCss(){return this.scrollContainerTopCss}get element(){return this.container}get containerElement(){return this.scrollContainer}resize(a,b){this.containerTopCss=cssNumber(a);this.availableHeight=b;1>this.availableHeight&&(this.availableHeight=1);this.container.style.top=css(a);this.container.style.height=css(b);UISpriteSheet.resize(this.scrollThumb);a=this.scrollContainer.getBoundingClientRect();this.contentHeight=model(a.bottom-
a.top);1>this.contentHeight&&(this.contentHeight=1);a=this.contentHeight<=this.availableHeight?"none":"";this.scrollThumb.style.display!==a&&(this.scrollThumb.style.display=a);this.scrollTo(this.scrollThumbTopPercent)}attach(){this.pointerHandler=new PointerHandler(this.scrollThumb,this.mouseDown.bind(this),this.mouseMove.bind(this));document.addEventListener("wheel",this.boundDocumentWheel,{capture:!0,passive:!1})}detach(){this.pointerHandler&&(this.pointerHandler.destroy(),this.pointerHandler=null);
document.removeEventListener("wheel",this.boundDocumentWheel,!0)}adjustScrollUI(a,b=-1){this.contentHeight<=this.availableHeight||0>=a?b=a=0:(1<a&&(a=1),0>b&&(b=cssNumber(a*(this.availableHeight-scrollThumbHeight))));this.scrollThumbTopPercent=a;this.scrollThumbTopCss=b;this.scrollThumb.style.top=this.containerTopCss+b+"px";this.scrollContainerTopCss=this.contentHeight<=this.availableHeight?0:cssNumber(-this.scrollThumbTopPercent*(this.contentHeight-this.availableHeight))}scrollTo(a,b=-1){this.adjustScrollUI(a,
b);this.scrollThumbOnly?this.scrollContainer.style.marginTop=this.scrollContainerTopCss+"px":(this.ignoreScroll=!0,this.container.scrollTop=-this.scrollContainerTopCss)}mouseDown(a){const b=this.container.getBoundingClientRect();this.pointerLastY=a.clientY-b.top;this.scrollThumbInitialTopCss=this.scrollThumbTopCss;return!0}mouseMove(a){const b=this.container.getBoundingClientRect();a=this.scrollThumbInitialTopCss+(a.clientY-b.top-this.pointerLastY);a=0>a?0:model(a)+scrollThumbHeight>this.availableHeight?
cssNumber(this.availableHeight-scrollThumbHeight):(a*pixelRatio|0)/pixelRatio;a!==this.scrollThumbTopCss&&this.scrollTo(model(a)/(this.availableHeight-scrollThumbHeight),a)}documentWheel(a){return Modal.visible?!1:(0>a.deltaY?this.scrollTo(this.scrollThumbTopPercent-.1):0<a.deltaY&&this.scrollTo(this.scrollThumbTopPercent+.1),cancelEvent(a))}containerScroll(a){this.ignoreScroll?this.ignoreScroll=!1:(a=this.contentHeight-this.availableHeight,this.adjustScrollUI(0>=a||!this.availableHeight?0:model(this.container.scrollTop)/
a))}}
class Modal{constructor(a){this.fading=!1;this.boundDocumentKeyDown=this.defaultSubmitButton=this.defaultCancelButton=this.modalFooterElement=this.modalBodyElement=this.modalHeaderElement=this.modalElement=this.containerElement=this.options=null;this.options=a;this.containerElement=document.createElement("div");this.containerElement.className="base-element modal-container";this.modalElement=document.createElement("form");this.modalElement.className="modal";this.modalElement.onsubmit=this.submit.bind(this);this.modalHeaderElement=
document.createElement("div");this.modalHeaderElement.className="modal-decoration";this.modalHeaderElement.innerHTML=a.title||Strings.Oops;this.modalBodyElement=document.createElement("div");this.modalBodyElement.className="modal-body";this.modalBodyElement.innerHTML=a.html;var b=this.modalBodyElement.getElementsByTagName("button");if(b&&b.length)for(var c=b.length-1;0<=c;c--){const d=b[c];prepareButtonBlink(d,!0,()=>{if(this.fading)return!1;if(this.options.onbuttonclick)this.options.onbuttonclick(d.id,
d);return!0})}if((b=this.modalBodyElement.getElementsByTagName("span"))&&b.length)for(c=b.length-1;0<=c;c--){const d=b[c];d.getAttribute(UISpriteSheet.SheetId)&&UISpriteSheet.finishHTMLCreation(d)}this.modalFooterElement=document.createElement("div");this.modalFooterElement.className="modal-decoration";for(b=0;b<a.buttons.length;b++){const d=a.buttons[b],e=document.createElement("button");d.defaultCancel&&(this.defaultCancelButton=e);d.defaultSubmit&&(this.defaultSubmitButton=e);e.style.height=buttonHeightCss;
e.style.borderWidth=borderWidthCss;d.className&&(e.className=d.className);b&&(e.style.float="right");e.setAttribute("type","button");UISpriteSheet.create(d.iconId,e);e.appendChild(document.createTextNode(d.text));prepareButtonBlink(e,!0,()=>{if(this.fading)return!1;if(d.onclick)d.onclick(d.id,e);if(this.options.onbuttonclick)this.options.onbuttonclick(d.id,e);return!0});this.modalFooterElement.appendChild(e)}this.modalElement.appendChild(this.modalHeaderElement);this.modalElement.appendChild(this.modalBodyElement);
this.modalElement.appendChild(this.modalFooterElement);this.containerElement.appendChild(this.modalElement);main.appendChild(this.containerElement);this.boundDocumentKeyDown=this.documentKeyDown.bind(this);document.addEventListener("keydown",this.boundDocumentKeyDown,!0);this.fading=!0;setTimeout(()=>{if(a.onshowing)a.onshowing();this.resizeInternal();this.containerElement.className="base-element modal-container visible";setTimeout(()=>{this.fading=!1;View.pushHistoryStateIfNecessary();if(this.options.onshown)this.options.onshown()},
520)},100)}static get visible(){return!!Modal.modal}static get currentModalElement(){return Modal.modal?Modal.modal.modalElement:null}static get currentModalHeaderElement(){return Modal.modal?Modal.modal.modalHeaderElement:null}static get currentModalBodyElement(){return Modal.modal?Modal.modal.modalBodyElement:null}static get currentModalFooterElement(){return Modal.modal?Modal.modal.modalFooterElement:null}static show(a){if(Modal.modal)return!1;a.okcancel?a.buttons=[{id:"cancel",defaultCancel:!0,
iconId:UISpriteSheet.Back,text:Strings.Cancel,onclick:a.oncancel||Modal.hide},{id:"ok",defaultSubmit:a.okcancelsubmit,iconId:UISpriteSheet.AcceptGreen,text:Strings.OK,className:"accept",onclick:a.onok||Modal.hide}]:a.buttons&&a.buttons.length||(a.buttons=[{id:"cancel",defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Close,onclick:Modal.hide}]);Modal.modal=new Modal(a);return!0}static hide(){Modal.modal&&Modal.modal.hideInternal()}static defaultCancelAction(){Modal.modal&&Modal.modal.defaultCancelActionInternal()}static windowResized(){Modal.modal&&
Modal.modal.resizeInternal()}hideInternal(){Modal.modal!==this||this.fading||this.options.onhiding&&!1===this.options.onhiding()||(document.removeEventListener("keydown",this.boundDocumentKeyDown,!0),this.fading=!0,this.containerElement.className="base-element modal-container",setTimeout(()=>{Modal.modal=null;View.popHistoryStateIfNecessary();if(this.options.onhidden)this.options.onhidden();main.removeChild(this.containerElement);for(let a=this.options.buttons.length-1;0<=a;a--)zeroObject(this.options.buttons[a]);
zeroObject(this.options);zeroObject(this)},520))}documentKeyDown(a){"Escape"!==a.key&&27!==a.keyCode||this.defaultCancelActionInternal()}defaultCancelActionInternal(){this.defaultCancelButton&&this.defaultCancelButton.click()}submit(a){cancelEvent(a);this.defaultSubmitButton&&this.defaultSubmitButton.click();return!1}resizeInternal(){if(Modal.modal===this){this.modalElement.style.fontSize=fontSizeCss;this.modalElement.style.maxWidth=css(this.options.large?baseWidth:baseWidth>>1);this.modalElement.style.margin=
this.options.large?"0":iconSizeCss+" auto";this.modalHeaderElement.style.padding=buttonPaddingCss;this.modalBodyElement.style.padding=iconSizeCss+" "+buttonPaddingCss;this.modalBodyElement.style.lineHeight=iconSizeCss;this.modalFooterElement.style.padding=buttonPaddingCss;var a=this.modalElement.querySelectorAll("[data-style]");if(a&&a.length)for(var b=a.length-1;0<=b;b--){var c=a[b],d=c.getAttribute("data-style").split(";");for(let e=0;e<d.length;e++){const f=d[e],g=f.indexOf(":");0<=g&&(c.style[f.substr(0,
g)]=css(parseInt(f.substr(g+1))))}}if((a=this.modalElement.getElementsByTagName("input"))&&a.length)for(b=css(2),c=a.length-1;0<=c;c--)d=a[c],d.style.borderWidth=borderWidthCss,d.style.padding=b,d.style.marginTop=b;if((a=this.modalElement.getElementsByTagName("button"))&&a.length)for(b=a.length-1;0<=b;b--)c=a[b],c.style.height=buttonHeightCss,c.style.borderWidth=borderWidthCss,c.style.fontSize=fontSizeCss,c.style.lineHeight=iconSizeCss,c.style.paddingLeft=buttonPaddingCss,c.style.paddingRight=buttonPaddingCss;
if((a=this.modalElement.getElementsByTagName("span"))&&a.length)for(b=a.length-1;0<=b;b--)c=a[b],c.getAttribute(UISpriteSheet.SheetId)&&(UISpriteSheet.resize(c),"BUTTON"===c.parentNode.tagName&&(c.style.marginRight=buttonMarginCss));if(this.options.onresized)this.options.onresized()}}}Modal.modal=null;
class View{constructor(){this.attached=!1;this.buttons=[];this.buttonsWithMargin=[];this.buttonsWithLargeMargin=[];this.buttonImages=[];this.baseElement=null;this.destroy=a=>__awaiter(this,void 0,void 0,function*(){this.baseElement&&(this.baseElement.parentNode&&this.attached&&this.baseElement.parentNode.removeChild(this.baseElement),this.attached&&(this.attached=!1,yield this.detach()),this.destroyInternal(a),a||zeroObject(this))});this.baseElement=document.createElement("div");this.baseElement.className=
"base-element"}static drawBackground(a,b,c){const d=View.gl;if(!d.checkForLostContextUseFrameBufferAndClear())return View.recreateResourcesTimeout||(View.recreateResourcesTimeout=setTimeout(View.recreateResourcesFromTimeout,1E3)),!1;d.prepareNativeDraw(View.sheetTexture);cLib._renderBackground(d.verticesPtr,b,LevelSpriteSheet.LevelSpriteSheetPtr,baseHeight,a,c);d.useFramebuffer(!1);d.draw(d.framebufferTexture,LevelSpriteSheet.FullViewModelCoordinates,1,LevelSpriteSheet.FramebufferTextureCoordinates,
0,0);d.flush();return!0}static recreateResourcesFromTimeout(){View.recreateResourcesTimeout&&(View.recreateResourcesTimeout=0,View.recreateResources())}static recreateResources(){View.recreateResourcesTimeout&&(clearTimeout(View.recreateResourcesTimeout),View.recreateResourcesTimeout=0);const a=View.currentView,b=a&&a.usesGL;b&&a.releaseResources();View.sheetTexture.release();View.backgroundFrameRequest&&(cancelAnimationFrame(View.backgroundFrameRequest),View.backgroundFrameRequest=0);try{View.gl.recreate(View.glCanvas,
baseWidth>>LevelSpriteSheet.BackgroundScaleRightShift,baseHeight>>LevelSpriteSheet.BackgroundScaleRightShift),View.gl.clearColor(1,1,1,1),View.sheetTexture.load()}catch(c){throw View.recreateResourcesTimeout=setTimeout(View.recreateResourcesFromTimeout,500),c;}b?a.loadResources():View.backgroundFrameRequest=requestAnimationFrame(View.renderBackground)}static renderBackground(a){const b=!View.currentView||!View.currentView.pausedBackground;View.backgroundFrameRequest=b?requestAnimationFrame(View.renderBackground):
0;!View.drawBackground(a,0,b)&&View.backgroundFrameRequest&&(cancelAnimationFrame(View.backgroundFrameRequest),View.backgroundFrameRequest=0)}static get loading(){return View._loading}static set loading(a){View._loading!==a&&((View._loading=a)?(View.divLoading||(View.divLoading=document.createElement("div"),View.divLoading.style.display="none",View.resizeLoading(),document.body.appendChild(View.divLoading)),View.divLoadingTimeout&&clearTimeout(View.divLoadingTimeout),View.divLoadingTimeout=setTimeout(function(){View.divLoadingTimeout=
0;View.divLoading.style.display="";View.divLoading.className="loading"},100)):View.divLoading&&(View.divLoadingTimeout&&(clearTimeout(View.divLoadingTimeout),View.divLoadingTimeout=0),document.body.removeChild(View.divLoading),View.divLoading=null))}static get fading(){return View._fading}static initGL(){View.gl=new WebGL;View.sheetTexture=LevelSpriteSheet.createTexture(View.gl);window.drawNative=a=>{View.gl.drawNative(a)}}static createInitialView(){return View.currentView||View._loading||View._fading||
View.viewStack.length?null:(new TitleView).fadeIn()}static resizeLoading(){View.divLoading&&(View.divLoading.style.backgroundSize=css(43)+" "+css(11),View.divLoading.style.width=css(43+iconSize),View.divLoading.style.height=css(11+iconSize))}static windowResized(a){if(8>baseLeftCss){if(!View.fadeLeft.style.backgroundColor){const b=androidWrapper||isPWA?"#99f":"#000";View.fadeLeft.style.backgroundColor=b;View.fadeRight.style.backgroundColor=b;View.fadeLeft.style.backgroundImage="none";View.fadeRight.style.backgroundImage=
"none"}}else View.fadeLeft.style.backgroundColor&&(View.fadeLeft.style.backgroundColor="",View.fadeRight.style.backgroundColor="",View.fadeLeft.style.backgroundImage="",View.fadeRight.style.backgroundImage="");a&&(View.resizeLoading(),baseTopCss?View.fadeLeft.style.display||(View.fadeLeft.style.display="none",View.fadeRight.style.display="none"):View.fadeLeft.style.display&&(View.fadeLeft.style.display="",View.fadeRight.style.display=""),View.glCanvas.width=baseWidth*scaleFactor,View.glCanvas.height=
baseHeight*scaleFactor,View.glCanvas.style.height=baseHeightCss+"px",View.gl.checkRecreate(View.glCanvas)&&View.recreateResources(),View.currentView&&View.currentView.resize())}static windowHistoryStatePopped(a){View.windowHistoryStatePushed=!1;View.pushHistoryStateIfNecessary();Modal.visible&&Modal.defaultCancelAction()}static pushHistoryStateIfNecessary(){View.windowHistoryStatePushed||View.currentView&&View.currentView instanceof TitleView&&!View._fading&&!Modal.visible||(View.windowHistoryStatePushed=
!0,window.history.state&&window.history.state.pixelMaze||window.history.pushState({pixelMaze:!0},"Pixel Maze"))}static popHistoryStateIfNecessary(){View.windowHistoryStatePushed&&window.history.back()}get usesGL(){return!1}get pausedBackground(){return!1}releaseResources(){}loadResources(){}resize(){for(var a=this.buttons.length-1;0<=a;a--){const b=this.buttons[a];b.style.width=buttonHeightCss;b.style.height=buttonHeightCss;b.style.fontSize=fontSizeCss;b.style.lineHeight=iconSizeCss}for(a=this.buttonImages.length-
1;0<=a;a--)UISpriteSheet.resize(this.buttonImages[a]);for(a=this.buttonsWithMargin.length-1;0<=a;a--)this.buttonsWithMargin[a].style.marginLeft=buttonMarginCss;for(a=this.buttonsWithLargeMargin.length-1;0<=a;a--)this.buttonsWithLargeMargin[a].style.marginLeft=buttonLargeMarginCss}fadeInFinished(){}createButton(a,b,c,...d){const e=document.createElement("button");b=UISpriteSheet.create(b,e);e.setAttribute("type","button");prepareButtonBlink(e,!1,c);a.appendChild(e);this.buttons.push(e);this.buttonImages.push(b);
if(d)for(a=0;a<d.length;a+=2)e.setAttribute(d[a],d[a+1]);return e}finishFadeIn(a){setTimeout(()=>{this.resize();View.backgroundFrameRequest&&(cancelAnimationFrame(View.backgroundFrameRequest),View.backgroundFrameRequest=0);this.usesGL?this.loadResources():View.backgroundFrameRequest=requestAnimationFrame(View.renderBackground);main.className="visible";setTimeout(()=>{View._fading=!1;View.popHistoryStateIfNecessary();this.fadeInFinished();a()},520)},100)}fadeIn(){return __awaiter(this,void 0,void 0,
function*(){if(View._fading||View.currentView===this)return null;View._fading=!0;View.currentView=this;return new Promise((a,b)=>{if(this.baseElement&&!this.attached&&(main.appendChild(this.baseElement),this.attached=!0,b=this.attach())){b.then(()=>{this.finishFadeIn(a)},c=>{console.error(c)});return}this.finishFadeIn(a)})})}fadeOut(a){return __awaiter(this,void 0,void 0,function*(){if(View._fading||View.currentView!==this)return null;View._fading=!0;View.backgroundFrameRequest&&(cancelAnimationFrame(View.backgroundFrameRequest),
View.backgroundFrameRequest=0);return new Promise((b,c)=>{main.className="";setTimeout(()=>__awaiter(this,void 0,void 0,function*(){yield this.destroy(a);a&&View.viewStack.push(this);View.currentView=null;View._fading=!1;View.pushHistoryStateIfNecessary();b()}),520)})})}fadeTo(a,b=!1){return __awaiter(this,void 0,void 0,function*(){if(View._fading||View.currentView!==this)return null;yield this.fadeOut(b);return("string"===typeof a?new viewClasses[a]:a).fadeIn()})}fadeToPrevious(){return __awaiter(this,
void 0,void 0,function*(){if(View._fading||View.currentView!==this||!View.viewStack.length)return null;yield this.fadeOut(!1);return View.viewStack.pop().fadeIn()})}}View._loading=!1;View._fading=!1;View.currentView=null;View.viewStack=[];View.divLoading=null;View.divLoadingTimeout=0;View.windowHistoryStatePushed=!1;View.fadeLeft=document.getElementById("fadeLeft");View.fadeRight=document.getElementById("fadeRight");View.glCanvas=document.getElementById("glCanvas");View.gl=null;
View.sheetTexture=null;View.backgroundFrameRequest=0;View.recreateResourcesTimeout=0;
class EditorView extends View{constructor(a,b){super();this.tool=EditorView.ToolPencil;this.dirty=!1;this.context=null;this.contextGlobalCompositeOperation="source-over";this.lastBrushWidth=this.lastPencilRainbowIndex=this.lastPencilColor=0;this.lastObjectType=LevelObject.TypeBall;this.brushOffsets=[0,10,26,46];this.brushWidths=[9,15,19,39];this.loadOptions=this.brushContext=this.brushCanvas=null;this.selectionView=!1;this.level=null;this.levelBallCount=0;this.pointerHandler=null;this.pointerLastY=
this.pointerLastX=0;this.pointerCursorAttached=!1;this.canvas=this.scrollContainer=this.toolbarBottom=this.toolbarTop=this.fileInput=this.pointerCursor=null;this.objectImages=[];this.objectImageDrag=null;this.keyUpCounter=this.keyUpTime=this.firstObjectToolButtonIndex=this.firstLineWidthButtonIndex=this.firstPencilButtonIndex=this.objectImageDragOffsetYCss=this.objectImageDragOffsetXCss=0;this.boundDocumentKeyUp=null;this.baseElement.innerHTML='\n\t\t<div class="hidden-container"><input id="fileInput" type="file" accept="image/*" tabindex="-1" /></div>\n\t\t<div id="toolbarTop" class="toolbar toolbar-top"></div>\n\t\t<div id="container"></div>\n\t\t<div id="toolbarBottom" class="toolbar toolbar-bottom"></div>\n\t\t';
this.fileInput=this.baseElement.querySelector("#fileInput");this.toolbarTop=this.baseElement.querySelector("#toolbarTop");this.toolbarBottom=this.baseElement.querySelector("#toolbarBottom");this.scrollContainer=new ScrollContainer(null,!0,"scroll-container-editor",this.baseElement.querySelector("#container"));this.setGridBackground();this.canvas=document.createElement("canvas");this.canvas.width=baseWidth;this.canvas.height=maxHeight;this.scrollContainer.containerElement.appendChild(this.canvas);
this.pointerCursor=document.createElement("div");this.pointerCursor.className="pointer-cursor";var c=this.toolbarTop;const d=this.toolbarBottom;this.createButton(c,UISpriteSheet.Back,this.back.bind(this)).style.float="left";this.firstPencilButtonIndex=this.buttons.length;const e=this.changeToolPencil.bind(this);for(let f=0;f<colors.length-1;f++)this.createButton(c,UISpriteSheet.Border,e,"data-i",f.toString()).firstChild.style.backgroundColor=colorsCss[f];this.createButton(c,UISpriteSheet.Rainbow,
e,"data-i",(colors.length-1).toString());this.createButton(c,UISpriteSheet.Eraser,this.changeToolEraser.bind(this));this.firstLineWidthButtonIndex=this.buttons.length;c=this.changeBrushWidth.bind(this);this.createButton(d,UISpriteSheet.LineWidth0,c,"data-i","0");this.createButton(d,UISpriteSheet.LineWidth1,c,"data-i","1");this.createButton(d,UISpriteSheet.LineWidth2,c,"data-i","2");this.createButton(d,UISpriteSheet.LineWidth3,c,"data-i","3");this.firstObjectToolButtonIndex=this.buttons.length;for(c=
LevelObject.TypeBall;c<=LevelObject.LastType;c++)this.createButton(d,LevelObject.ImagesByType[c],this.changeTool.bind(this),"data-tool",(EditorView.ToolBall+c-LevelObject.TypeBall).toString());this.buttonsWithLargeMargin.push(this.buttons[this.firstObjectToolButtonIndex]);this.createButton(d,UISpriteSheet.Eraser,this.changeTool.bind(this),"data-tool",EditorView.ToolDeleteObject.toString());this.buttonsWithLargeMargin.push(this.createButton(d,UISpriteSheet.Open,this.open.bind(this)));this.createButton(d,
UISpriteSheet.Download,this.download.bind(this));this.createButton(d,UISpriteSheet.Clear,this.clear.bind(this));this.createButton(d,UISpriteSheet.Accept,this.accept.bind(this)).style.float="right";this.createButton(d,UISpriteSheet.Play,this.play.bind(this)).style.float="right";this.fileInput.onchange=this.openFile.bind(this);androidWrapper||isPWA||(this.boundDocumentKeyUp=this.documentKeyUp.bind(this));this.highlightTool();this.loadOptions=a||null;this.selectionView=!!b}setGridBackground(){this.scrollContainer.containerElement.style.backgroundImage=
`url('assets/images/grid${5>=scaleFactor?scaleFactor:1}.png')`}get pausedBackground(){return!0}resize(){var a=css(63),b=css(maxHeight),c=css(this.brushWidths[this.lastBrushWidth]);this.toolbarTop.style.height=toolbarAvailableHeightCss;this.toolbarTop.style.borderBottomWidth=borderWidthCss;this.toolbarBottom.style.height=toolbarAvailableHeightCss;this.toolbarBottom.style.borderTopWidth=borderWidthCss;this.canvas.style.height=b;this.setGridBackground();this.scrollContainer.containerElement.style.backgroundSize=
a+" "+a;this.scrollContainer.resize(toolbarTotalHeight,baseHeight-(toolbarTotalHeight<<1));this.pointerCursor.style.borderWidth=borderWidthCss;this.pointerCursor.style.width=c;this.pointerCursor.style.height=c;a=this.level.objects;for(b=a.length-1;0<=b;b--){c=a[b];const d=this.objectImages[b];d.style.left=css(c.x-iconRadius);d.style.top=css(c.y-iconRadius);UISpriteSheet.resize(d)}super.resize()}attach(){return __awaiter(this,void 0,void 0,function*(){if(!this.level){this.level=yield LevelCache.loadLevelFromOptions(this.loadOptions);
this.loadOptions&&(this.loadOptions.levelNameOverride&&(this.level.name=this.loadOptions.levelNameOverride),this.loadOptions=null);var a=this.level.objects;const b=a.length;for(let c=0;c<b;c++)this.addObject(a[c],!0)}this.pointerHandler=new PointerHandler(this.canvas,this.mouseDown.bind(this),this.mouseMove.bind(this),this.mouseUp.bind(this));this.scrollContainer.attach();a=yield loadImage(EditorView.brushesImageDataBase64);this.brushCanvas=document.createElement("canvas");this.brushCanvas.width=
a.width;this.brushCanvas.height=a.height;this.brushContext=this.brushCanvas.getContext("2d",{alpha:!0});this.brushContext.drawImage(a,0,0);this.updateBrushColor(colors[this.lastPencilColor]);this.context=this.canvas.getContext("2d",{alpha:!0});this.context.globalCompositeOperation="source-over";this.context.clearRect(0,0,baseWidth,maxHeight);setContextQuality(this.context,!1);this.level.image&&this.context.drawImage(yield loadImage(this.level.image),0,0);this.context.globalCompositeOperation=this.contextGlobalCompositeOperation;
this.boundDocumentKeyUp&&document.addEventListener("keyup",this.boundDocumentKeyUp,!0)})}detach(){return __awaiter(this,void 0,void 0,function*(){this.pointerHandler&&(this.pointerHandler.destroy(),this.pointerHandler=null);this.scrollContainer.detach();this.brushContext=this.brushCanvas=this.context=null;this.boundDocumentKeyUp&&document.removeEventListener("keyup",this.boundDocumentKeyUp,!0)})}destroyInternal(a){this.save()}save(){if(this.dirty||!this.level.image)this.level.modifiedAt=(new Date).getTime(),
this.level.createdAt||(this.level.createdAt=this.level.modifiedAt),this.level.thumbnailImage="",this.level.image=this.canvas.toDataURL("image/png"),this.level.processedImage="",this.level.polygons=[],LevelCache.saveEditorLevel(this.level),this.dirty=!1}updatePointerCursor(a,b){const c=cssNumber(.5*this.brushWidths[this.lastBrushWidth]+1);this.pointerCursor.style.left=a-c+"px";this.pointerCursor.style.top=b-c+this.scrollContainer.topCss+"px"}mouseDown(a){if(View.loading)return!1;const b=this.scrollContainer.containerElement.getBoundingClientRect(),
c=a.clientX-b.left;a=a.clientY-b.top;this.dirty=!0;switch(this.tool){case EditorView.ToolPencil:case EditorView.ToolEraser:this.pointerCursorAttached||(this.pointerCursorAttached=!0,this.updatePointerCursor(c,a),this.scrollContainer.element.appendChild(this.pointerCursor));this.draw((this.pointerLastX=model(c)-1)+1,this.pointerLastY=model(a));break;default:this.handleObjectToolDown(c,a)}return!0}mouseMove(a){var b=this.scrollContainer.containerElement.getBoundingClientRect();const c=a.clientX-b.left;
a=a.clientY-b.top;switch(this.tool){case EditorView.ToolPencil:case EditorView.ToolEraser:b=model(c);const d=model(a);if(this.pointerLastX!==b||this.pointerLastY!==d)this.updatePointerCursor(c,a),this.draw(b,d),this.pointerLastX=b,this.pointerLastY=d;break;default:this.handleObjectToolMove(c,a)}}mouseUp(a){this.objectImageDrag=null;this.pointerCursorAttached&&(this.pointerCursorAttached=!1,this.scrollContainer.element.removeChild(this.pointerCursor));switch(this.tool){case EditorView.ToolPencil:case EditorView.ToolEraser:return}a=
this.level.objects;const b=this.objectImages;b.sort((c,d)=>{c=c.object;d=d.object;return c.type-d.type||d.y-c.y});for(let c=b.length-1,d=1;0<=c;c--,d++){const e=b[c];e.style.zIndex=d.toString();a[c]=e.object}}draw(a,b){a-=this.pointerLastX;b-=this.pointerLastY;var c=Math.abs(a),d=Math.abs(b);if(c||d){const e=this.brushWidths[this.lastBrushWidth],f=e>>1,g=this.brushOffsets[this.lastBrushWidth];c=Math.max(c,d);d=this.pointerLastX;let h=this.pointerLastY;a/=c;for(b/=c;0<c;)c--,d+=a,h+=b,c&1||(this.lastPencilColor===
colors.length-1&&(this.lastPencilRainbowIndex++,this.lastPencilRainbowIndex>=rainbowColors.length&&(this.lastPencilRainbowIndex=0),this.updateBrushColor(rainbowColors[this.lastPencilRainbowIndex])),this.context.drawImage(this.brushCanvas,g,0,e,e,(d|0)-f,(h|0)-f,e,e))}}handleObjectToolDown(a,b){var c=model(a),d=model(b);if(this.tool>=EditorView.ToolBall&&this.tool<=EditorView.ToolCucumber){this.objectImageDrag=this.findObjectWithinRadius(-1,c,d);if(!this.objectImageDrag&&(this.objectImageDrag=this.addObject(new LevelObject(this.lastObjectType,
c,d),!1),!this.objectImageDrag))return;c=this.scrollContainer.containerElement.getBoundingClientRect();d=this.objectImageDrag.getBoundingClientRect();this.objectImageDragOffsetXCss=d.left-c.left-a;this.objectImageDragOffsetYCss=d.top-c.top-b}else(a=this.findObjectWithinRadius(-1,c,d))&&this.removeObject(a)}handleObjectToolMove(a,b){if(this.tool>=EditorView.ToolBall&&this.tool<=EditorView.ToolCucumber&&this.objectImageDrag){const c=this.objectImageDrag.object;c&&(c.move(model(a+this.objectImageDragOffsetXCss)+
iconRadius,model(b+this.objectImageDragOffsetYCss)+iconRadius),this.objectImageDrag.style.left=css(c.x-iconRadius),this.objectImageDrag.style.top=css(c.y-iconRadius))}}highlightTool(){let a=this.firstPencilButtonIndex,b=a+(this.tool===EditorView.ToolEraser?colors.length:this.lastPencilColor);for(;a<b;a++)this.buttons[a].style.backgroundColor="";if(this.tool===EditorView.ToolPencil||this.tool===EditorView.ToolEraser)this.buttons[a++].style.backgroundColor="#fff";for(b=this.firstPencilButtonIndex+colors.length;a<=
b;a++)this.buttons[a].style.backgroundColor="";a=this.firstLineWidthButtonIndex;for(b=a+this.lastBrushWidth;a<b;a++)this.buttons[a].style.backgroundColor="";if(this.tool===EditorView.ToolPencil||this.tool===EditorView.ToolEraser)this.buttons[a++].style.backgroundColor="#fff";for(b=this.firstLineWidthButtonIndex+this.brushWidths.length;a<b;a++)this.buttons[a].style.backgroundColor="";a=this.firstObjectToolButtonIndex;for(b=a+this.tool-EditorView.FirstObjectTool;a<b;a++)this.buttons[a].style.backgroundColor=
"";this.tool>=EditorView.FirstObjectTool&&(this.buttons[a++].style.backgroundColor="#fff");for(b=this.firstObjectToolButtonIndex+EditorView.ObjectToolCount;a<b;a++)this.buttons[a].style.backgroundColor="";this.canvas.style.opacity=this.tool===EditorView.ToolDeleteObject?"0.25":""}updateBrushColor(a){const b=this.brushContext.getImageData(0,0,this.brushCanvas.width,this.brushCanvas.height),c=new Int32Array(b.data.buffer);for(let d=c.length-1;0<=d;d--)c[d]&4278190080&&(c[d]=a);this.brushContext.putImageData(b,
0,0)}clearImage(){this.dirty=!0;this.context.clearRect(0,0,baseWidth,maxHeight);this.level.clearImage();this.scrollContainer.scrollTo(0)}findObjectWithinRadius(a,b,c){const d=this.level.objects,e=d.length,f=iconSize*iconSize;for(let h=0;h<e;h++){var g=d[h];if(0<=a&&g.type!==a)continue;let l=b-g.x;g=c-g.y;l*=l;g*=g;if(f>=l+g)return this.objectImages[h]}return null}addObject(a,b){if(!b){if(this.level.objects.length>=Level.MaxObjectCount)return Modal.show({html:Strings.TooManyObjects+UISpriteSheet.html(UISpriteSheet.Error)}),
null;if(this.levelBallCount>=Level.MaxBallCount&&a.type==LevelObject.TypeBall)return Modal.show({html:Strings.TooManyBalls+UISpriteSheet.html(UISpriteSheet.Error)}),null}const c=UISpriteSheet.create(LevelObject.ImagesByType[a.type]);c.style.position="absolute";c.style.zIndex=(b?this.level.objects.length-this.objectImages.length:1+this.objectImages.length).toString();c.style.left=css(a.x-iconRadius);c.style.top=css(a.y-iconRadius);c.style.pointerEvents="none";c.object=a;this.scrollContainer.containerElement.appendChild(c);
this.objectImages.push(c);b||this.level.objects.push(a);a.type==LevelObject.TypeBall&&this.levelBallCount++;return c}removeObject(a){if(a&&a.object){var b=this.objectImages;for(let c=b.length-1;0<=c;c--)if(b[c]===a){this.scrollContainer.containerElement.removeChild(a);b.splice(c,1);this.level.objects[c].type===LevelObject.TypeBall&&this.levelBallCount--;this.level.objects.splice(c,1);break}}}clearObjects(){this.dirty=!0;const a=this.scrollContainer.containerElement,b=this.objectImages;for(let c=b.length-
1;0<=c;c--)a.removeChild(b[c]);this.objectImages=[];this.level.clearObjects();this.levelBallCount=0;this.scrollContainer.scrollTo(0)}back(a){return this.fadeTo(this.selectionView?"SelectionView":"TitleView")?!0:!1}changeToolPencil(a){this.tool=EditorView.ToolPencil;this.lastPencilColor=parseInt(("IMG"===a.target.tagName?a.target.parentNode:a.target).getAttribute("data-i"));this.context.globalCompositeOperation=this.contextGlobalCompositeOperation="source-over";this.updateBrushColor(colors[this.lastPencilColor]);
this.highlightTool();return!0}changeToolEraser(a){this.tool=EditorView.ToolEraser;this.context.globalCompositeOperation=this.contextGlobalCompositeOperation="destination-out";this.updateBrushColor(4294967295);this.highlightTool();return!0}changeBrushWidth(a){this.tool!==EditorView.ToolPencil&&this.tool!==EditorView.ToolEraser&&(this.tool="destination-out"==this.contextGlobalCompositeOperation?EditorView.ToolEraser:EditorView.ToolPencil);this.lastBrushWidth=parseInt(("IMG"===a.target.tagName?a.target.parentNode:
a.target).getAttribute("data-i"));switch(this.tool){case EditorView.ToolPencil:case EditorView.ToolEraser:break;default:this.tool=EditorView.ToolPencil,this.context.globalCompositeOperation=this.contextGlobalCompositeOperation="source-over"}a=css(this.brushWidths[this.lastBrushWidth]);this.pointerCursor.style.width=a;this.pointerCursor.style.height=a;this.highlightTool();return!0}changeTool(a){this.tool=parseInt(("IMG"===a.target.tagName?a.target.parentNode:a.target).getAttribute("data-tool"));this.tool>=
EditorView.ToolBall&&this.tool<=EditorView.ToolCucumber&&(this.lastObjectType=LevelObject.TypeBall+this.tool-EditorView.ToolBall);this.highlightTool();return!0}openFile(a){if(!Modal.visible&&this.fileInput.files&&this.fileInput.files[0])if(a=this.fileInput.files[0].name.toLowerCase(),a.endsWith(".png")||a.endsWith(".jpg")||a.endsWith(".jpeg")){View.loading=!0;var b=new FileReader;b.onload=()=>{this.fileInput.value="";b.result?loadImage(b.result).then(c=>{this.clearImage();this.context.globalCompositeOperation=
"source-over";setContextQuality(this.context,!0);const d=c.width,e=c.height;if(d<=baseWidth&&e<=maxHeight)this.context.drawImage(c,baseWidth-d>>1,0);else{let f=d,g=e;f>baseWidth&&(g*=baseWidth/f,f=baseWidth);g>maxHeight&&(f*=maxHeight/g,g=maxHeight);f|=0;g|=0;this.context.drawImage(c,0,0,d,e,baseWidth-f>>1,0,f,g)}setContextQuality(this.context,!1);this.context.globalCompositeOperation=this.contextGlobalCompositeOperation},()=>{Modal.show({html:Strings.ErrorLoadingImage+UISpriteSheet.html(UISpriteSheet.Error)})}):
(View.loading=!1,Modal.show({html:Strings.EmptyImage+UISpriteSheet.html(UISpriteSheet.Error)}))};b.onerror=()=>{this.fileInput.value="";View.loading=!1;Modal.show({html:Strings.ErrorReadingImage+UISpriteSheet.html(UISpriteSheet.Error)})};b.readAsDataURL(this.fileInput.files[0])}else Modal.show({html:Strings.InvalidImage+UISpriteSheet.html(UISpriteSheet.Error)})}open(a){if(Modal.visible)return!1;this.fileInput.click();return!0}download(a){if(Modal.visible)return!1;LevelCache.downloadLevelImage(this.level.name,
this.canvas).then(b=>{switch(b){case LevelCache.DownloadLevelSuccess:Modal.show({title:Strings.Success,html:Strings.LevelImageDownloaded+UISpriteSheet.html(UISpriteSheet.Success)});break;case LevelCache.DownloadLevelError:Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)});break;case LevelCache.DownloadLevelNoPermission:Modal.show({html:Strings.TryToDownloadLevelImageAgain});break;case LevelCache.DownloadLevelFileAlreadyExists:Modal.show({html:Strings.LevelImageDownloadFailedFileExists+
UISpriteSheet.html(UISpriteSheet.Error)})}},()=>{Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)})});return!0}clear(a){if(Modal.visible)return!1;Modal.show({html:Strings.ClearEntireLevel,buttons:[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Cancel,onclick:Modal.hide},{iconId:UISpriteSheet.ClearRed,text:Strings.Clear,className:"danger",onclick:()=>{this.level.name="";this.level.createdAt=0;this.level.modifiedAt=0;this.clearImage();this.clearObjects();
Modal.hide()}}]});return!0}accept(a){if(Modal.visible)return!1;let b=!1,c=!1,d=!1;this.save();Modal.show({title:Strings.SaveLevel,html:`<label for="name">${Strings.LevelName}</label><input id="name" spellcheck="false" autocomplete="off" />`,okcancel:!0,okcancelsubmit:!0,onshowing:()=>{document.getElementById("name").value=this.level.name},onshown:()=>{document.getElementById("name").focus()},onok:()=>__awaiter(this,void 0,void 0,function*(){var e=document.getElementById("name").value.trim();e?LevelCache.isNameValid(e)||
(c=!0,Modal.hide()):(e=new Date,e=`${e.getFullYear()}-${format2(e.getMonth()+1)}-${format2(e.getDate())} ${format2(e.getHours())}${format2(e.getMinutes())}${format2(e.getSeconds())}`);e!==this.level.name&&(this.level.name=e,this.dirty=!0,this.save());View.loading=!0;try{yield this.level.prepare(),yield LevelCache.saveLevel(this.level,!1),b=!0}catch(f){d=!0}finally{View.loading=!1,Modal.hide()}}),onhidden:()=>{c?Modal.show({html:Strings.NameCannotContain+" \\ / ? * : < > % "+UISpriteSheet.html(UISpriteSheet.Error)}):
d?Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)}):b&&Modal.show({title:Strings.Success,html:Strings.LevelSaved+UISpriteSheet.html(UISpriteSheet.Success)})}});return!0}play(a){this.save();View.loading=!0;this.level.prepare().then(()=>{View.loading=!1;this.fadeTo(new GameView({level:this.level},!0),!0)},b=>{View.loading=!1;if(b&&b.message){if(b.message===Level.MaxPolygonCountMessage){Modal.show({html:Strings.TooManyPolygons+Level.MaxPolygonCount+" "+UISpriteSheet.html(UISpriteSheet.Error)});
return}if(b.message===Level.MaxPointCountMessage){Modal.show({html:Strings.TooManyPoints+Level.MaxPointCount+" "+UISpriteSheet.html(UISpriteSheet.Error)});return}}Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)})});return!0}documentKeyUp(a){if(!View.loading&&!Modal.visible)if("d"===a.key)this.keyUpTime=Date.now(),this.keyUpCounter=1;else switch(this.keyUpCounter){case 1:this.keyUpCounter="b"===a.key&&2E3>Date.now()-this.keyUpTime?2:0;break;case 2:if(2E3>Date.now()-
this.keyUpTime)switch(a.key){case "g":confirm(Strings.YouWillLoseYourLevel)&&this.devDebug();break;case "s":this.devSave()}this.keyUpCounter=0}}devDebug(){processImage(this.canvas,this.context,!0)}devSave(){return __awaiter(this,void 0,void 0,function*(){this.level.name="0";this.save();yield this.level.prepare();var a=document.createElement("a");a.href=this.level.image;a.download="image.png";a.click();a=document.createElement("a");a.href=this.level.processedImage;a.download="processedImage.png";a.click();
a=document.createElement("a");a.href=this.level.thumbnailImage;a.download="thumbnailImage.png";a.click();Modal.show({html:'I <input id="inputImage" type="file" accept="image/png" />\n\t\t\tP <input id="inputProcessedImage" type="file" accept="image/png" />\n\t\t\tT <input id="inputThumbnailImage" type="file" accept="image/png" />',okcancel:!0,onok:()=>{const b=new FileReader;b.onload=()=>{const c=new FileReader;c.onload=()=>{const d=new FileReader;d.onload=()=>{this.level.createdAt=0;this.level.modifiedAt=
0;this.level.image=b.result;this.level.processedImage=c.result;this.level.thumbnailImage=null;console.log("'"+JSON.stringify(this.level)+"',");console.log("'"+d.result+"',");Modal.hide()};d.readAsDataURL(document.getElementById("inputThumbnailImage").files[0])};c.readAsDataURL(document.getElementById("inputProcessedImage").files[0])};b.readAsDataURL(document.getElementById("inputImage").files[0])}})})}}EditorView.brushesImageDataBase64="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFUAAAAnAQAAAABWZDk9AAAAAnRSTlMAAQGU/a4AAACkSURBVChTrdExCsIwGIbhNxRMB7FrB8FrOAjtUXoERwfBHK29SY6QMUPoL8lfW0Rx8pue+f2YkhUjEoxEXKwSD3F0Ea4m0s3QRBgInBLYCD0DTQDzsgeKe+wI3HDj5qnYAWekGKB9t2dkl10jwWyOleewOFnPPhtEJHBcHbmsTtxXi0mb5V+es+rfluz2i5cOZdrn09pTrZ3V2l+tv6j1r8X5xycuusr5PaBWcwAAAABJRU5ErkJggg==";
EditorView.ToolPencil=0;EditorView.ToolEraser=1;EditorView.ToolBall=2;EditorView.ToolGoal=3;EditorView.ToolBomb=4;EditorView.ToolCucumber=5;EditorView.ToolDeleteObject=6;EditorView.FirstObjectTool=EditorView.ToolBall;EditorView.ObjectToolCount=5;
class GameView extends View{constructor(a,b){super();this.alive=!0;this.alreadyCreated=this.finished=this.paused=!1;this.viewY=this.level=this.loadOptions=this.timeDisplay=this.restartButton=this.backButton=null;this.frameRequest=0;this.levelTexture=this.resourceStorage=this.boundRender=this.pointerCursorY=this.pointerCursorX=this.pointerCursorCenterY=this.pointerCursorCenterX=this.victory=this.totalElapsedMilliseconds=this.pointerCursorAttached=this.pointerHandler=null;this.baseElement.style.cursor=
"crosshair";this.baseElement.style.touchAction="none";var c=this.createButton(this.baseElement,UISpriteSheet.Back,this.back.bind(this));c.style.position="absolute";c.style.left="0";c.style.top="0";b||(c.style.display="none");this.backButton=c;this.preview||(c=this.createButton(this.baseElement,UISpriteSheet.Restart,this.restart.bind(this)),c.style.position="absolute",c.style.left="0",c.style.top="0",c.style.display="none",this.restartButton=c,c=document.createElement("div"),c.style.position="absolute",
c.style.left="0",c.style.top="0",c.style.display="none",UISpriteSheet.create(UISpriteSheet.Clock,c),c.appendChild(document.createTextNode(Strings.Time)),this.baseElement.appendChild(c),this.timeDisplay=c);c=this.createButton(this.baseElement,UISpriteSheet.Pause,this.pause.bind(this));c.style.position="absolute";c.style.right="0";c.style.top="0";this.resourceStorage=new ResourceStorage;this.boundRender=this.render.bind(this);this.loadOptions=a;this.preview=b}get usesGL(){return!0}releaseResources(){this.alive&&
this.resourceStorage.release()}loadResources(){this.alive&&(this.resourceStorage.load(),LevelSpriteSheet.LevelModelCoordinates.setCoordinates(0,0,this.levelTexture.width*scaleFactor,this.levelTexture.height*scaleFactor),this.alreadyCreated?(this.frameRequest&&(cancelAnimationFrame(this.frameRequest),this.frameRequest=0),this.frameRequest=requestAnimationFrame(this.boundRender)):(this.alreadyCreated=!0,this.restart()))}resize(){this.restartButton&&(this.restartButton.style.left=css(buttonHeight+buttonMargin));
if(this.timeDisplay){this.timeDisplay.style.top=buttonMarginCss;this.timeDisplay.style.left=css(3*buttonHeight+buttonMargin);this.timeDisplay.style.lineHeight=iconSizeCss;const a=this.timeDisplay.childNodes[0];UISpriteSheet.resize(a);a.style.marginRight=buttonMarginCss}this.level.viewResized();super.resize()}attach(){return __awaiter(this,void 0,void 0,function*(){this.level=yield LevelCache.loadLevelFromOptions(this.loadOptions);this.loadOptions=null;this.pointerHandler=new PointerHandler(this.baseElement,
this.mouseDown.bind(this),this.mouseMove.bind(this),this.mouseUp.bind(this));this.levelTexture||(this.levelTexture=new Texture(View.gl,yield loadImage(this.level.processedImage)),this.resourceStorage.add("levelTexture",this.levelTexture));if(androidWrapper)androidWrapper.setKeepScreenOn(!0);else try{const a=navigator.wakeLock;a&&a.request&&!GameView.wakeLockSentinel&&(GameView.wakeLockSentinel=yield a.request("screen"))}catch(a){}})}detach(){return __awaiter(this,void 0,void 0,function*(){this.pointerHandler&&
(this.pointerHandler.destroy(),this.pointerHandler=null);if(androidWrapper)androidWrapper.setKeepScreenOn(!1);else if(GameView.wakeLockSentinel)try{GameView.wakeLockSentinel.release&&(yield GameView.wakeLockSentinel.release(),GameView.wakeLockSentinel=null)}catch(a){}})}destroyInternal(a){this.alreadyCreated=this.alive=!1;this.level.destroyLevelPtr();this.pointerCursorY=this.pointerCursorX=this.pointerCursorCenterY=this.pointerCursorCenterX=this.victory=this.totalElapsedMilliseconds=this.pointerCursorAttached=
this.viewY=null;a?this.resourceStorage.release():this.resourceStorage.destroy()}restart(){if(!this.alive)return!1;this.preview||(this.backButton.style.display="none",this.restartButton.style.display="none",this.timeDisplay.style.display="none");this.finished=this.paused=!1;this.level.restart();const a=cLib.HEAP8.buffer;let b=cLib._getFirstPropertyPtr(this.level.levelPtr);this.viewY=new Float32Array(a,cLib._getViewYPtr(this.level.levelPtr),1);this.pointerCursorAttached=new Int32Array(a,b,1);b+=4;this.totalElapsedMilliseconds=
new Int32Array(a,b,1);b+=4;this.victory=new Int32Array(a,b,1);b+=4;this.pointerCursorCenterX=new Float32Array(a,b,1);b+=4;this.pointerCursorCenterY=new Float32Array(a,b,1);b+=4;this.pointerCursorX=new Float32Array(a,b,1);this.pointerCursorY=new Float32Array(a,b+4,1);this.frameRequest&&(cancelAnimationFrame(this.frameRequest),this.frameRequest=0);this.frameRequest=requestAnimationFrame(this.boundRender);return!0}back(a){if(!this.alive)return!1;this.alive=!1;this.paused=!0;this.frameRequest&&(cancelAnimationFrame(this.frameRequest),
this.frameRequest=0);this.fadeToPrevious();return!0}pause(a){if(!this.alive)return!1;if(!this.paused){const b=ControlMode.accelerationSupported?UISpriteSheet.create(ControlMode.modeImage):null;if(!Modal.show({title:Strings.Pause,html:(androidWrapper||isPWA?"":`<button type="button" id="fullscreen" data-style="margin-bottom: ${buttonMargin}">${Strings.Fullscreen}</button><br/>`)+(b?`<button type="button" id="controlMode" data-style="margin-bottom: ${buttonMargin}">${Strings.ControlMode}</button><br/>`:
"")+`<button type="button" id="restart">${Strings.Restart}</button>`,buttons:[{iconId:UISpriteSheet.Back,text:Strings.Exit,onclick:()=>{Modal.hide();this.back(null)}},{defaultCancel:!0,iconId:UISpriteSheet.PlayGreen,text:Strings.Play,className:"accept",onclick:()=>{Modal.hide();this.pause(null)}}],onshowing:()=>{let c=document.getElementById("fullscreen");c&&c.insertBefore(UISpriteSheet.create(UISpriteSheet.Fullscreen),c.firstChild);b&&(c=document.getElementById("controlMode"),c.insertBefore(b,c.firstChild));
c=document.getElementById("restart");c.insertBefore(UISpriteSheet.create(UISpriteSheet.Restart),c.firstChild)},onbuttonclick:c=>{switch(c){case "fullscreen":fullscreenControl.toggleFullscreen();break;case "controlMode":ControlMode.toggleMode();UISpriteSheet.change(b,ControlMode.modeImage);break;case "restart":this.restart(),Modal.hide()}}}))return!1}this.paused=!this.paused;this.frameRequest&&(cancelAnimationFrame(this.frameRequest),this.frameRequest=0);this.alive&&(this.frameRequest=requestAnimationFrame(this.boundRender));
return!0}mouseDown(a){if(View.loading||!this.alive||this.paused||ControlMode.mode!==ControlMode.Pointer||this.finished)return!1;this.pointerCursorAttached[0]=1;this.pointerCursorCenterX[0]=this.pointerCursorX[0]=model(a.clientX-baseLeftCss);this.pointerCursorCenterY[0]=this.pointerCursorY[0]=model(a.clientY-baseTopCss);return!0}mouseMove(a){this.pointerCursorX[0]=modelFrac(a.clientX-baseLeftCss);this.pointerCursorY[0]=modelFrac(a.clientY-baseTopCss)}mouseUp(a){this.pointerCursorAttached[0]=0}checkRecord(){if(this.alive&&
this.level&&this.totalElapsedMilliseconds&&this.victory&&this.victory[0]){var a=LevelCache.getLevelRecord(this.level.name);a&&a.time<=this.totalElapsedMilliseconds[0]||Modal.show({title:Strings.NewRecord,html:`<label for="name">${Strings.Name}</label><input id="name" spellcheck="false" autocomplete="off" maxlength="8" /><br/><label>${Strings.Time}</label><label>${LevelCache.formatLevelRecordTime(this.totalElapsedMilliseconds[0])}</label>`,okcancel:!0,okcancelsubmit:!0,onshowing:()=>{const b=Modal.currentModalHeaderElement;
if(b){b.setAttribute("data-style","line-height:"+iconSize);const c=UISpriteSheet.create(UISpriteSheet.Trophy);c.setAttribute("data-style","margin-right:"+buttonMargin);b.insertBefore(c,b.firstChild);UISpriteSheet.create(UISpriteSheet.Trophy,b).setAttribute("data-style","margin-left:"+buttonMargin)}document.getElementById("name").value=LevelCache.LastRecordName||""},onok:()=>__awaiter(this,void 0,void 0,function*(){this.alive&&this.level&&this.totalElapsedMilliseconds&&(LevelCache.setLevelRecord(this.level.name,
this.totalElapsedMilliseconds[0],document.getElementById("name").value),Modal.hide())})})}}render(a){if(this.alive){this.frameRequest=requestAnimationFrame(this.boundRender);var b=this.level;View.drawBackground(a,b.levelPtr,!0)?(ControlMode.mode!==ControlMode.Pointer&&androidWrapper&&ControlMode.processAndroidAcceleration(),b.step(this.paused),a=View.gl,a.draw(this.levelTexture,LevelSpriteSheet.LevelModelCoordinates,1,LevelSpriteSheet.FullTextureCoordinates,0,-(this.viewY[0]*scaleFactor|0)),a.prepareNativeDraw(View.sheetTexture),
cLib._render(a.verticesPtr,b.levelPtr,LevelSpriteSheet.LevelSpriteSheetPtr,scaleFactor)&&(this.preview?(this.finished=!0,this.pointerCursorAttached[0]=0,this.pause(null)):(this.finished=!1,this.pointerCursorAttached[0]=0,this.backButton.style.display="",this.restartButton.style.display="",this.totalElapsedMilliseconds&&(this.timeDisplay.childNodes[1].nodeValue=LevelCache.formatLevelRecordTime(this.totalElapsedMilliseconds[0]),this.timeDisplay.style.display=""),this.checkRecord()))):this.frameRequest&&
(cancelAnimationFrame(this.frameRequest),this.frameRequest=0)}else this.frameRequest=0}}GameView.FinishedThisFrame=1;GameView.FinishedVictory=2;GameView.FinishedLoss=4;GameView.wakeLockSentinel=null;
class SelectionView extends View{constructor(){super();this.boundShowMenu=this.boundPlay=this.lastPlayedThumbnail=this.hr=this.anchors=this.thumbnailRecords=this.thumbnailImages=this.thumbnails=this.scrollContainer=this.toolbarTop=this.fileInput=null;this.baseElement.innerHTML='\n\t\t<div class="hidden-container"><input id="fileInput" type="file" accept="application/json" tabindex="-1" /></div>\n\t\t<div id="toolbarTop" class="toolbar toolbar-top"></div>\n\t\t';this.fileInput=this.baseElement.querySelector("#fileInput");
this.toolbarTop=this.baseElement.querySelector("#toolbarTop");this.scrollContainer=new ScrollContainer(this.baseElement);this.createButton(this.toolbarTop,UISpriteSheet.Back,this.back.bind(this)).style.float="left";this.fileInput.onchange=this.openFile.bind(this);this.createButton(this.toolbarTop,UISpriteSheet.Open,this.open.bind(this));androidWrapper||isPWA||this.buttonsWithMargin.push(this.createButton(this.toolbarTop,UISpriteSheet.Fullscreen,this.fullscreen.bind(this)));this.boundPlay=this.play.bind(this);
this.boundShowMenu=this.showMenu.bind(this)}resize(){const a=this.thumbnails,b=this.thumbnailImages,c=this.thumbnailRecords,d=this.anchors,e=cssNumber(thumbnailWidth),f=cssNumber(thumbnailHeight);cssNumber(iconSize);const g=borderWidthCss+" 0 0 "+borderWidthCss,h=toolbarAvailableHeightCss+" 0 0 "+css(27);var l=css(borderWidth<<1);const m=l+" 0";l+=" 0 0";this.hr&&(this.hr.style.marginTop=toolbarAvailableHeightCss,this.hr.style.borderTopWidth=borderWidthCss);this.toolbarTop.style.height=toolbarAvailableHeightCss;
this.toolbarTop.style.borderBottomWidth=borderWidthCss;for(let k=a.length-1;0<=k;k--){a[k].style.width=thumbnailWidthCss;a[k].style.borderWidth=borderWidthCss;a[k].style.margin=h;a[k].style.padding=m;a[k].style.lineHeight=iconSizeCss;b[k].width=e;b[k].height=f;b[k].style.margin=l;c[k].style.borderTopWidth=borderWidthCss;c[k].style.padding=l;d[k].style.borderWidth=g;d[k].style.padding=buttonPaddingCss;UISpriteSheet.resize(d[k].firstChild);const n=c[k].childNodes;n[0].style.marginRight=buttonMarginCss;
n[3].style.marginRight=buttonMarginCss;UISpriteSheet.resize(n[0]);UISpriteSheet.resize(n[3])}this.scrollContainer.containerElement.style.paddingBottom=toolbarAvailableHeightCss;this.scrollContainer.resize(toolbarTotalHeight,baseHeight-toolbarTotalHeight);super.resize()}updateThumbnailRecord(a,b){if(a&&b){for(a=LevelCache.getLevelRecord(a);b.firstChild;)b.removeChild(b.firstChild);UISpriteSheet.create(UISpriteSheet.Trophy,b);b.appendChild(document.createTextNode(a?a.name:"-"));b.appendChild(document.createElement("br"));
UISpriteSheet.create(UISpriteSheet.Clock,b);b.appendChild(document.createTextNode(a?a.fmt:"-"))}}createThumbnail(a,b,c=null,d=-1){const e=document.createElement("div"),f=document.createElement("div"),g=document.createElement("div"),h=document.createElement("img"),l=document.createElement("div"),m=document.createElement("a"),k=b?d.toString():a;e.className="thumbnail";b?(e.setAttribute("data-id",k),e.setAttribute("data-name",Strings.LevelSpace+(d+1))):e.setAttribute("data-name",k);prepareButtonBlink(e,
!1,this.boundPlay);f.className="thumbnail-preview";g.className="thumbnail-text";g.textContent=a;f.appendChild(g);c?h.src=c:LevelCache.loadLevelInfo(a,!1).then(n=>{n&&(h.src=n.thumbnailImage)},n=>{console.log(n)});f.appendChild(h);UISpriteSheet.create(UISpriteSheet.Menu,m);m.className="menu";prepareButtonBlink(m,!1,this.boundShowMenu);f.appendChild(m);e.appendChild(f);l.className="thumbnail-text thumbnail-record";this.updateThumbnailRecord(k,l);e.appendChild(l);this.thumbnails.push(e);this.thumbnailImages.push(h);
this.thumbnailRecords.push(l);this.anchors.push(m);b||this.hr||(this.hr=document.createElement("hr"),this.scrollContainer.containerElement.appendChild(this.hr));this.scrollContainer.containerElement.appendChild(e)}attach(){return __awaiter(this,void 0,void 0,function*(){if(this.thumbnails)this.lastPlayedThumbnail&&((a=this.lastPlayedThumbnail.getElementsByClassName("thumbnail-record"))&&a[0]&&this.updateThumbnailRecord(this.lastPlayedThumbnail.getAttribute("data-id")||this.lastPlayedThumbnail.getAttribute("data-name"),
a[0]),this.lastPlayedThumbnail=null);else{this.thumbnails=[];this.thumbnailImages=[];this.thumbnailRecords=[];this.anchors=[];LevelCache.BuiltInLevelIds||(yield LevelCache.loadBuiltInLevels());var a=LevelCache.BuiltInLevelIds;for(var b=0;b<a.length;b++)this.createThumbnail(Strings.LevelSpace+(b+1),!0,LevelCache.builtInLevelThumbnailPath(b),a[b]);a=yield LevelCache.getLevelNames();for(b=0;b<a.length;b++)this.createThumbnail(a[b],!1)}this.scrollContainer.attach()})}detach(){return __awaiter(this,void 0,
void 0,function*(){this.scrollContainer.detach()})}destroyInternal(a){}back(a){return this.fadeTo("TitleView")?!0:!1}openFile(a){if(!Modal.visible&&this.fileInput.files&&this.fileInput.files[0])if(this.fileInput.files[0].name.toLowerCase().endsWith(".json")){View.loading=!0;var b=new FileReader;b.onload=()=>{function c(){View.loading=!1;Modal.show({html:Strings.ErrorLoadingLevel+UISpriteSheet.html(UISpriteSheet.Error)})}this.fileInput.value="";if(b.result){var d=null;try{d=Level.revive(b.result)}catch(e){}d?
(LevelCache.isNameValid(d.name)||(d.name=Strings.Level),d.prepare().then(()=>{LevelCache.getLevelNames().then(e=>{let f=d.name;/.*\(\d+\)$/.test(f)&&(f=f.substr(0,f.lastIndexOf("(")).trim(),f||(f=Strings.Level));let g=0,h=d.name;for(;;){let l=!0;for(let m=e.length-1;0<=m;m--)if(e[m]===h){l=!1;break}if(l)break;g++;h=`${f} (${g})`}d.name=h;LevelCache.saveLevel(d,!1).then(()=>{View.loading=!1;this.createThumbnail(h,!1);this.resize();Modal.show({title:Strings.Success,html:Strings.LevelImported+UISpriteSheet.html(UISpriteSheet.Success)})},
c)},c)},c)):c()}else View.loading=!1,Modal.show({html:Strings.EmptyLevel+UISpriteSheet.html(UISpriteSheet.Error)})};b.onerror=()=>{this.fileInput.value="";View.loading=!1;Modal.show({html:Strings.ErrorReadingLevel+UISpriteSheet.html(UISpriteSheet.Error)})};b.readAsText(this.fileInput.files[0])}else Modal.show({html:Strings.InvalidLevel+UISpriteSheet.html(UISpriteSheet.Error)})}open(a){if(Modal.visible)return!1;this.fileInput.click();return!0}fullscreen(a){fullscreenControl.toggleFullscreen();return!0}loadOptions(a){const b=
a.getAttribute("data-id");a=a.getAttribute("data-name");return b?{levelId:parseInt(b),levelNameOverride:a}:{levelName:a}}getTargetThumbnail(a){for(;a&&a!==document.body;){if("thumbnail"===a.className)return a;a=a.parentNode}return null}play(a){if(Modal.visible)return!1;a=a.target;return"A"===a.tagName||"IMG"===a.tagName&&"A"===a.parentNode.tagName?!1:(a=this.getTargetThumbnail(a))?(this.lastPlayedThumbnail=a,this.fadeTo(new GameView(this.loadOptions(a),!1),!0),!0):!1}showMenu(a){if(Modal.visible)return!1;
const b=a.target,c=this.getTargetThumbnail(b);if(!c)return!1;const d=!!c.getAttribute("data-id");let e=!1,f=!1;return Modal.show({title:Strings.Menu,html:`<button type="button" id="edit" ${d?"":`data-style="margin-bottom: ${buttonMargin}"`}>${Strings.Edit}</button>
				${d?"":`<br/><button type="button" id="delete" class="danger">${Strings.Delete}</button>`}`,buttons:[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Close,onclick:()=>{Modal.hide()}},{iconId:UISpriteSheet.Download,text:Strings.Download,onclick:()=>{f=!0;Modal.hide()}}],onshowing:()=>{let g=document.getElementById("edit");g.insertBefore(UISpriteSheet.create(UISpriteSheet.Edit),g.firstChild);d||(g=document.getElementById("delete"),g.insertBefore(UISpriteSheet.create(UISpriteSheet.ClearRed),
g.firstChild))},onbuttonclick:g=>{switch(g){case "edit":Modal.hide();this.editLevel(c);break;case "delete":e=!0,Modal.hide()}},onhidden:()=>{e?this.deleteLevel(b,c):f&&this.downloadLevel(c)}})}editLevel(a){this.fadeTo(new EditorView(this.loadOptions(a),!0))}deleteLevel(a,b){const c=b.getAttribute("data-name");if(c){var d=!1,e=!1;Modal.show({html:Strings.DeleteLevel+c+"?",buttons:[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Cancel,onclick:Modal.hide},{iconId:UISpriteSheet.ClearRed,text:Strings.Delete,
className:"danger",onclick:()=>__awaiter(this,void 0,void 0,function*(){if(!View.loading){try{yield LevelCache.deleteLevel(c);const f=this.anchors;for(let g=f.length-1;0<=g;g--)if(f[g]===a){this.scrollContainer.containerElement.removeChild(b);this.thumbnails.splice(g,1);this.thumbnailImages.splice(g,1);this.thumbnailRecords.splice(g,1);f.splice(g,1);f.length===LevelCache.BuiltInLevelIds.length&&(this.scrollContainer.containerElement.removeChild(this.hr),this.hr=null);this.scrollContainer.resize(toolbarTotalHeight,
baseHeight-toolbarTotalHeight);break}d=!0}catch(f){e=!0}Modal.hide()}})}],onhidden:()=>{e?Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)}):d&&Modal.show({title:Strings.Success,html:Strings.LevelDeleted+UISpriteSheet.html(UISpriteSheet.Success)})}})}}downloadLevel(a){return __awaiter(this,void 0,void 0,function*(){const b=a.getAttribute("data-id"),c=a.getAttribute("data-name");if(c)switch(yield LevelCache.downloadLevel(c,b?parseInt(b):-1)){case LevelCache.DownloadLevelSuccess:Modal.show({title:Strings.Success,
html:Strings.LevelDownloaded+UISpriteSheet.html(UISpriteSheet.Success)});break;case LevelCache.DownloadLevelError:Modal.show({html:Strings.SomethingWentWrong+UISpriteSheet.html(UISpriteSheet.Error)});break;case LevelCache.DownloadLevelNoPermission:Modal.show({html:Strings.TryToDownloadAgain});break;case LevelCache.DownloadLevelFileAlreadyExists:Modal.show({html:Strings.DownloadFailedFileExists+UISpriteSheet.html(UISpriteSheet.Error)})}})}}
class TitleView extends View{constructor(){super();this.aboutButton=this.fullscreenButton=this.buttonContainer=null;this.baseElement.innerHTML='\n\t\t<div id="logo" class="logo"></div>\n\t\t<div id="buttonContainer" style="position: absolute;"></div>\n\t\t';this.buttonContainer=this.baseElement.querySelector("#buttonContainer");this.createButton(this.buttonContainer,UISpriteSheet.Play,this.play.bind(this));this.buttonsWithLargeMargin.push(this.createButton(this.buttonContainer,UISpriteSheet.Edit,
this.edit.bind(this)));isPWA||(this.fullscreenButton=this.createButton(this.baseElement,androidWrapper?UISpriteSheet.Exit:UISpriteSheet.Fullscreen,(androidWrapper?this.exit:this.fullscreen).bind(this)),this.fullscreenButton.style.position="absolute");this.aboutButton=this.createButton(this.baseElement,UISpriteSheet.Question,this.about.bind(this));this.aboutButton.style.position="absolute"}resize(){var a=css(150);const b=css(30),c=document.getElementById("logo");c.style.left=css(baseWidth-150>>1);
c.style.top=css(buttonLargeMargin<<1);c.style.width=a;c.style.height=b;c.style.backgroundSize=a+" "+b;a=(buttonHeight<<1)+buttonLargeMargin;this.buttonContainer.style.bottom=css(buttonLargeMargin);this.buttonContainer.style.left=css(baseWidth-a>>1);this.buttonContainer.style.width=css(a);this.fullscreenButton&&(this.fullscreenButton.style.left=buttonMarginCss,this.fullscreenButton.style.bottom=buttonMarginCss);this.aboutButton.style.right=buttonMarginCss;this.aboutButton.style.bottom=buttonMarginCss;
super.resize()}attach(){return __awaiter(this,void 0,void 0,function*(){})}detach(){return __awaiter(this,void 0,void 0,function*(){})}destroyInternal(a){}play(a){if(Modal.visible)return!1;this.fadeTo("SelectionView");return!0}edit(a){if(Modal.visible)return!1;this.fadeTo("EditorView");return!0}fullscreen(a){fullscreenControl.toggleFullscreen();return!0}exit(a){androidWrapper.exit();return!0}about(a){if(Modal.visible)return!1;a=[{defaultCancel:!0,iconId:UISpriteSheet.Back,text:Strings.Close,onclick:Modal.hide}];
!androidWrapper&&installationPrompt&&installationPrompt.prompt&&a.push({iconId:UISpriteSheet.Download,text:Strings.Install,onclick:(b,c)=>{if(installationPrompt)try{b=installationPrompt,installationPrompt=null,b.prompt()}catch(d){}setTimeout(()=>{c.style.display="none"},buttonBlinkTotalDurationMS)}});Modal.show({title:Strings.About,large:!0,html:Strings.About1+(2===View.gl.contextVersion?Strings.About2:"")+Strings.About3+(window.pixelUsingWebAssembly?"":Strings.About4)+Strings.About5+UISpriteSheet.html(UISpriteSheet.Success)+
"</p>"+(androidWrapper||navigator.wakeLock&&navigator.wakeLock.request?"":Strings.About6)+Strings.About7,buttons:a});return!0}}const viewClasses={EditorView,GameView,SelectionView,TitleView};
let cLib=null,scaleFactor=-1,baseHeight=minHeight,baseLeftCss=0,baseTopCss=0,baseWidthCss=baseWidth,baseHeightCss=minHeight,maxHeightCss=minHeight,thumbnailWidthCss=thumbnailWidth+"px",thumbnailHeightCss=thumbnailHeight+"px",buttonHeightCss=buttonHeight+"px",borderWidthCss=borderWidth+"px",toolbarAvailableHeightCss=toolbarAvailableHeight+"px",toolbarTotalHeightCss=toolbarTotalHeight+"px",iconSizeCss=iconSize+"px",buttonMarginCss=buttonMargin+"px",buttonLargeMarginCss=buttonLargeMargin+"px",buttonPaddingCss=
buttonPadding+"px",fontSizeCss="16px",installationPrompt=null,landscapeWarning=null;function ignorePromise(a){try{const b=()=>{};a&&a.then&&a.then(b,b)}catch(b){}}function cancelEvent(a){a&&("isCancelled"in a&&(a.isCancelled=!0),"preventDefault"in a&&a.preventDefault(),"stopPropagation"in a&&a.stopPropagation());return!1}function format2(a){return 10>a?"0"+a:a.toString()}function css(a){return(a|0)*scaleFactor/pixelRatio+"px"}function cssNumber(a){return(a|0)*scaleFactor/pixelRatio}
function model(a){return a*pixelRatio/scaleFactor|0}function modelFrac(a){return a*pixelRatio/scaleFactor}function smoothStep(a){return a*a*(3-2*a)}
function prepareButtonBlink(a,b,c){a.onclick=d=>{View.loading||View.fading||!b&&Modal.visible||!c(d)||((d=parseInt(a.getAttribute("data-blink-interval")))&&clearInterval(d),a.style.visibility="hidden",a.setAttribute("data-blink-count","1"),a.setAttribute("data-blink-interval",setInterval(()=>{const e=parseInt(a.getAttribute("data-blink-count")),f=parseInt(a.getAttribute("data-blink-interval"));f&&0<e&&e<buttonBlinkLastCounter?(a.style.visibility=e&1?"":"hidden",a.setAttribute("data-blink-count",(e+
1).toString())):(a.style.visibility="",f&&clearInterval(f),a.setAttribute("data-blink-count",""),a.setAttribute("data-blink-interval",""))},buttonBlinkSingleDurationMS).toString()))}}function zeroObject(a){for(let b in a)switch(typeof a[b]){case "function":break;case "boolean":a[b]=!1;break;case "number":a[b]=0;break;default:const c=a[b];Array.isArray(c)&&c.fill(null);a[b]=null}}
function adjustWindowSize(){let a=window.innerWidth,b=window.innerHeight;document.documentElement&&"clientWidth"in document.documentElement&&(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight);if(isIOSOrSafari){var c=null;document.documentElement&&"getBoundingClientRect"in document.documentElement?c=document.documentElement.getBoundingClientRect():"getBoundingClientRect"in document.body&&(c=document.body.getBoundingClientRect());c&&(a=c.right-c.left,b=c.bottom-c.top)}var d=
a*pixelRatio;const e=b*pixelRatio;c=scaleFactor;const f=baseHeight;scaleFactor=0;let g,h;for(;;)if(scaleFactor++,g=baseWidth*scaleFactor,h=e>g?g:e,baseHeight=Math.ceil(h/scaleFactor),baseHeight<minHeight||baseWidth*scaleFactor>d){1<scaleFactor&&scaleFactor--;g=baseWidth*scaleFactor;h=e>g?g:e;baseHeight=Math.ceil(h/scaleFactor);baseHeight<minHeight&&(baseHeight=minHeight);h=baseHeight*scaleFactor;break}baseWidthCss=g/pixelRatio;baseHeightCss=h/pixelRatio;baseLeftCss=(.5*(d-g)|0)/pixelRatio;d=.5*(e-
h)|0;0>d&&(d=0);baseTopCss=d/pixelRatio;main.style.left=baseLeftCss+"px";main.style.top=baseTopCss+"px";b>a||baseTopCss?landscapeWarning||(landscapeWarning=document.createElement("div"),landscapeWarning.style.fontSize=css(16),landscapeWarning.style.textAlign="center",landscapeWarning.style.position="absolute",landscapeWarning.style.left="0",landscapeWarning.style.top=css(8),landscapeWarning.style.width="100%",landscapeWarning.style.zIndex="9999",landscapeWarning.textContent=Strings.LandscapeWarning,
document.body.appendChild(landscapeWarning)):landscapeWarning&&(document.body.removeChild(landscapeWarning),landscapeWarning=null);scaleFactor!==c||baseHeight!==f?(main.style.width=baseWidthCss+"px",main.style.height=baseHeightCss+"px",maxHeightCss=cssNumber(maxHeight),thumbnailWidthCss=css(thumbnailWidth),thumbnailHeightCss=css(thumbnailHeight),buttonHeightCss=css(buttonHeight),borderWidthCss=css(borderWidth),toolbarAvailableHeightCss=css(toolbarAvailableHeight),toolbarTotalHeightCss=css(toolbarTotalHeight),
iconSizeCss=css(iconSize),buttonMarginCss=css(buttonMargin),buttonLargeMarginCss=css(buttonLargeMargin),buttonPaddingCss=css(buttonPadding),fontSizeCss=css(8),document.body.style.fontSize=fontSizeCss,LevelSpriteSheet.recreateIfNecessary(),UISpriteSheet.windowResized(),View.windowResized(!0),Modal.windowResized()):View.windowResized(!1)}function beforeInstallPrompt(a){"preventDefault"in a&&a.preventDefault();installationPrompt=a}let fullscreenChangedTimeout=0;
function fullscreenChanged(a){fullscreenChangedTimeout&&(clearTimeout(fullscreenChangedTimeout),fullscreenChangedTimeout=0);try{fullscreenControl.fullscreenMode?fullscreenChangedTimeout=setTimeout(fullscreenChangedHandler,150):fullscreenChangedHandler()}catch(b){}}
function fullscreenChangedHandler(){fullscreenChangedTimeout=0;if(screen.mozLockOrientation&&screen.mozUnlockOrientation)try{if(fullscreenControl.fullscreenMode){if(screen.mozLockOrientation("landscape-primary"))return}else if(screen.mozUnlockOrientation())return}catch(a){}if(screen.msLockOrientation&&screen.msUnlockOrientation)try{if(fullscreenControl.fullscreenMode){if(screen.msLockOrientation("landscape-primary"))return}else if(screen.msUnlockOrientation())return}catch(a){}if(screen.orientation&&
screen.orientation.lock&&screen.orientation.unlock)try{ignorePromise(fullscreenControl.fullscreenMode?screen.orientation.lock("landscape-primary"):screen.orientation.unlock())}catch(a){}}
function setup(){return __awaiter(this,void 0,void 0,function*(){Strings.init();var a=Promise.all([LevelSpriteSheet.preload(),window.CLib()]);View.loading=!0;"serviceWorker"in navigator&&!androidWrapper&&(window.addEventListener("beforeinstallprompt",beforeInstallPrompt),navigator.serviceWorker.register("sw.js"));ControlMode.init();[,cLib]=yield a;View.initGL();window.onpopstate=View.windowHistoryStatePopped;window.onresize=adjustWindowSize;adjustWindowSize();androidWrapper||(fullscreenControl.onfullscreenchange=
fullscreenChanged);View.loading=!1;View.createInitialView();a=document.createElement("script");a.async=!0;a.setAttribute("type","text/javascript");a.setAttribute("charset","utf-8");a.setAttribute("src","assets/js/levels.js");document.body.appendChild(a)})}window.pixelStepMAIN=!0;window.pixelCheckSetup&&window.pixelCheckSetup();
