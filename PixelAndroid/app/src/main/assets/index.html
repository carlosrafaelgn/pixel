<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-us">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, minimal-ui, shrink-to-fit=no" />
	<meta name="theme-color" content="#9999ff" />

	<title>Pixel Maze</title>

	<style type="text/css">
		@font-face {
			font-family: 'Press Start 2P';
			font-style: normal;
			font-weight: 400;
			font-display: swap;
			src: local('Press Start 2P Regular'),
				local('PressStart2P-Regular'),
				url('assets/fonts/PressStart2P-Regular.woff2') format('woff2'),
				url('assets/fonts/PressStart2P-Regular.ttf') format('truetype');
		}

		* {
			image-rendering: pixelated;
			image-rendering: -moz-crisp-edges;
			image-rendering: crisp-edges;
			-ms-touch-action: none;
			touch-action: none;
		}

		html {
			height: 100%;
			min-height: 100%;
			max-height: 100%;
			-webkit-tap-highlight-color: rgba(0,0,0,0);
		}

		html, body, .cover {
			background: #99f; /* Safari for iOS and Opera for Android in fullscreen mode?!?! */
		}

		body, button, input, textarea, select, h1, h2, h3, h4, h5, h6 {
			font-family: 'Press Start 2P', sans-serif;
			font-style: normal;
			font-weight: 400;
			line-height: 1;
			-webkit-font-smoothing: none;
			-moz-osx-font-smoothing: auto;
		}

		canvas, div, .base-element, button {
			margin: 0;
			padding: 0;
			border: 0;
		}

		canvas, div, .base-element {
			box-sizing: content-box;
		}

		body {
			padding: 0;
			margin: 0;
			color: #000;
			width: 100%;
			height: 100%;
			min-height: 100%;
			max-height: 100%;
			overflow: hidden;
		}

		.toolbar {
			background-color: rgba(253,190,148,0.4);
		}

		#main {
			position: absolute;
			z-index: 1;
			overflow: visible;
			/* box-shadow: 0 0 16px rgba(0,0,0,0.5); */
		}

		.cover {
			position: fixed;
			z-index: 10000;
			left: 0;
			top: 0;
			width: 4px;
			height: 4px;
			-webkit-transform-origin: left top;
			-moz-transform-origin: left top;
			transform-origin: left top;
		}

		.cover, .modal-container {
			opacity: 0;
			-webkit-transition: opacity ease-in-out 0.5s;
			-o-transition: opacity ease-in-out 0.5s;
			transition: opacity ease-in-out 0.5s;
		}

		canvas {
			width: 100%;
			cursor: crosshair;
		}

		#main, button, img, span, .toolbar, .container, .scroll-container, .scroll-thumb, .loading, .cover {
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		p {
			margin: 0;
			line-height: 1.5;
		}

		p + p {
			margin-top: 1em;
		}

		hr {
			border-style: solid none none;
			border-color: #fff;
			border-width: 0;
			margin: 0;
		}

		.modal-container {
			z-index: 1000;
			background: rgba(153,153,255,0.75);
			overflow: auto;
		}

		.modal {
			background: rgba(255,255,255,0.75);
		}

		.modal-decoration {
			background: rgba(255,255,255,0.5);
		}

		.modal-body {
			text-align: center;
		}

		button, input, textarea, select {
			font-size: inherit;
		}

		button {
			display: inline-block;
			cursor: pointer;
			text-align: center;
			box-sizing: border-box;
			vertical-align: top;
		}

		.modal button {
			border-style: solid;
			border-color: #000;
		}

		button, button:focus, button:hover, button:active {
			outline: 0 none transparent;
			background: none;
		}

		/* https://stackoverflow.com/a/199319/3569421 */
		button::-moz-focus-inner {
			border: 0;
		}

		.modal a {
			color: #04f;
			text-decoration: none;
		}

		.modal a, .modal a:focus, .modal a:hover, .modal a:active {
			outline: 0 none transparent;
			background: none;
		}

		.modal a:focus, .modal a:active {
			color: #008;
		}

		.modal-decoration button.accept, .modal-decoration button.accept:focus, .modal-decoration button.accept:hover, .modal-decoration button.accept:active {
			background: rgba(0,136,0,0.2);
			border-color: #080;
			color: #080;
		}

		.modal button.danger, .modal button.danger:focus, .modal button.danger:hover, .modal button.danger:active {
			background: rgba(255,0,0,0.2);
			border-color: #f00;
			color: #f00;
		}

		img, span {
			display: inline-block;
			vertical-align: top;
			pointer-events: none;
		}

		.scroll-thumb {
			pointer-events: auto;
		}

		label, input {
			display: block;
			text-align: left;
			width: 100%;
		}

		input {
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			box-sizing: border-box;
			border-style: solid;
			border-color: #000;
			border-radius: 0;
		}

			input, input:focus, input:hover, input:active {
				outline: 0 none transparent;
				background-color: #fff;
				background-image: none;
				box-shadow: none;
			}

		#fadeLeft, #fadeRight, .base-element {
			position: absolute;
			top: 0;
		}

		#fadeLeft, #fadeRight {
			bottom: 0;
			width: 24px;
			background-size: 48px 100%;
			background-repeat: no-repeat;
			pointer-events: none;
			background-image: url(assets/images/fade.png);
		}

		#fadeLeft {
			left: -24px;
		}

		#fadeRight {
			right: -24px;
			background-position: -24px 0;
		}

		.base-element {
			left: 0;
			right: 0;
			bottom: 0;
		}

		.logo {
			position: absolute;
			pointer-events: none;
			background-image: url(assets/images/logo.png);
			background-position: 0 0;
		}

		.visible {
			opacity: 1;
		}

		.loading {
			position: absolute;
			z-index: 9999;
			margin: 0;
			padding: 0;
			left: 0;
			bottom: 0;
			opacity: 0.75;
			background: no-repeat center url('assets/images/loading.gif') #fff;
			pointer-events: none;
		}

		.hidden-container {
			z-index: 0;
			position: absolute;
			left: 0;
			top: 0;
			width: 0;
			overflow: hidden;
		}

		.editor {
			background-size: cover;
			background-position: top left;
			background-repeat: no-repeat;
			background-image: url(assets/images/editor.png);
		}

		.toolbar {
			position: absolute;
			z-index: 2;
			left: 0;
			width: 100%;
		}

		.toolbar-top {
			top: 0;
			border-bottom-style: solid;
			border-bottom-color: #fff;
			text-align: right;
		}

		.toolbar-bottom {
			bottom: 0;
			border-top-style: solid;
			border-top-color: #fff;
		}

		.container {
			position: absolute;
			z-index: 1;
			left: 0;
			width: 100%;
			overflow: hidden;
		}

		/* https://stackoverflow.com/a/49278385/3569421 */
		.scrollable-container {
			overflow-y: scroll;
			scrollbar-width: none; /* Firefox */
			-ms-overflow-style: none;  /* Internet Explorer 10+ */
			width: 110%; /* Older browsers */
		}

		.scrollable-container::-webkit-scrollbar { /* WebKit */
			width: 0;
			height: 0;
		}

		.scrollable-container, .scrollable-container *, .modal-container, .modal-container * {
			-ms-touch-action: pan-y;
			touch-action: pan-y;
		}

		.scroll-container {
			position: relative;
			width: 100%;
		}

		.scroll-container-editor {
			background-repeat: repeat;
			background-position: 0 0;
		}

		.scroll-thumb {
			position: absolute;
			z-index: 2;
			right: 0;
			top: 0;
			cursor: ns-resize;
		}

		.pointer-cursor {
			position: absolute;
			z-index: 4;
			border-radius: 999px;
			border-style: solid;
			border-color: #fff;
			pointer-events: none;
		}

		.thumbnail {
			display: inline-block;
			position: relative;
			border-style: solid;
			border-color: #fff;
			cursor: pointer;
			text-align: center;
			vertical-align: top;
		}

		.thumbnail-text {
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			pointer-events: none;
		}

		.thumbnail-preview {
			position: relative;
		}

		.thumbnail-preview > .menu {
			position: absolute;
			bottom: 0;
			right: 0;
			border-style: solid none none solid;
			border-color: #fff;
			background-color: rgba(255,255,255,0.75);
		}

		.thumbnail-record {
			border-top-style: solid;
			border-top-color: #fff;
			pointer-events: none;
		}
	</style>
</head>
<body>
	<noscript>Sorry! You need to enable JavaScript in order to run the game :(</noscript>
	<div id="main"><div id="fadeLeft" style="display: none;"></div><div id="fadeRight" style="display: none;"></div><canvas id="glCanvas"></canvas></div>
	<div id="cover" class="cover visible"></div>

	<script type="text/javascript">
		//<![CDATA[
		"use strict";

		window["pixelCheckSetup"] = function () {
			if (window["pixelStepMAIN"]) {
				delete window["pixelStepMAIN"];
				delete window["pixelCheckSetup"];
				var promise = setup();
				if (promise && promise["catch"])
					promise["catch"](function (e) {
						alert("Error during setup " + ((e && (e.message || e.toString())) || "") + " :(");
					});
			}
		};

		(function () {
			function loadScript(src, successCallback, errorCallback) {
				window.onerror = errorCallback;
				var s = document.createElement("script");
				s.setAttribute("type", "text/javascript");
				s.setAttribute("charset", "utf-8");
				document.body.appendChild(s);
				s.onload = successCallback;
				s.onerror = errorCallback;
				s.setAttribute("src", src);
				return s;
			}

			function finalCallback() {
				var errorAlerted = false;
				window.onerror = function (msg, url, line, col, error) {
					debugger;
					if (errorAlerted)
						return;
					errorAlerted = true;
					alert(msg + " @ " + line + ":" + col + " " + url);
				};

				if (window["pixelCheckSetup"])
					window["pixelCheckSetup"]();
			}

			// Modified version of https://stackoverflow.com/a/29046739/3569421
			function checkES6() {
				try {
					if ((typeof Symbol) == "undefined")
						return false;
					var a;
					eval("a = `1`");
				} catch (ex) {
					return false;
				}
				return true;
			}

			function showError(msg, a) {
				var i;
				if (a && a.length) {
					msg += "\n\nError: " + a[0];
					for (i = 1; i < a.length; i++)
						msg += ", " + a[i];
				}
				alert(msg);
			}

			function loadMainScriptES(version) {
				var s;

				window["pixelES"] = "es" + version;

				// All TS files are being concatenated into a single file according to the
				// order specified in the files array, inside tsconfig.json
				s = loadScript("assets/js/scripts.es" + version + ".min.js", finalCallback, function () {
					showError("Impossible to load the main script :(", arguments);
				});
			}

			function loadMainScriptES2017() {
				var s;

				window["pixelES"] = "";

				// All TS files are being concatenated into a single file according to the
				// order specified in the files array, inside tsconfig.json
				s = loadScript("assets/js/scripts.min.js", finalCallback, function () {
					if (s.parentNode)
						document.body.removeChild(s);
					if (checkES6())
						loadMainScriptES(6);
					else
						loadMainScriptES(5);
				});
			}

			function loadLibScript() {
				window["pixelUsingWebAssembly"] = ("WebAssembly" in window);

				// Unfortunately, as of September 2020, emscripten does not automaticaly loads
				// the pure JS version of the compiled code, even when specifying the flag WASM=2
				//
				// Tested using the following command line:
				// chrome --disable-features="WebAssembly,AsmJsToWebAssembly,WebAssemblyStreaming" --js-flags="--noexpose-wasm"
				//
				// https://github.com/emscripten-core/emscripten/blob/master/src/settings.js
				// https://github.com/emscripten-core/emscripten/pull/10118
				// https://github.com/emscripten-core/emscripten/issues/11357
				loadScript(window["pixelUsingWebAssembly"] ? "assets/js/lib.js": "assets/js/lib-nowasm.js", function () {
					if (window["pixelUsingWebAssembly"])
						loadMainScriptES2017();
					else if (checkES6())
						loadMainScriptES(6);
					else
						loadMainScriptES(5);
				}, function () {
					showError("Impossible to load the library script :(", arguments);
				});
			}

			function checkPromise() {
				try {
					if (("Promise" in window)) {
						loadLibScript();
						return;
					}
				} catch (ex) {
				}

				loadScript("assets/js/es6-promise.auto.min.js", loadLibScript, function (e) {
					showError("Impossible to load the promise script :(", arguments);
				});
			}

			function fixRequestAnimationFrame() {
				// Modified version of https://gist.github.com/desandro/1866474
				var lastTime = 0, prefixes = "webkit moz ms o".split(" "),
					requestAnimationFrame = window.requestAnimationFrame,
					cancelAnimationFrame = window.cancelAnimationFrame,
					prefix, i;

				for (i = 0; i < prefixes.length; i++) {
					if (requestAnimationFrame && cancelAnimationFrame)
						break;
					prefix = prefixes[i];
					if (!requestAnimationFrame)
						requestAnimationFrame = window[prefix + "RequestAnimationFrame"];
					if (!cancelAnimationFrame)
						cancelAnimationFrame = window[prefix + "CancelAnimationFrame"] || window[prefix + "CancelRequestAnimationFrame"];
				}

				if (!requestAnimationFrame || !cancelAnimationFrame) {
					requestAnimationFrame = function (callback) {
						return window.setTimeout(function() {
							lastTime = performance.now();
							callback(lastTime);
						}, Math.max(0, 16 - (performance.now() - lastTime)));
					};

					cancelAnimationFrame = window.clearTimeout;
				}

				window.requestAnimationFrame = requestAnimationFrame;
				window.cancelAnimationFrame = cancelAnimationFrame;
			}

			function checkPolyfills() {
				if (!Function.prototype.bind) {
					Function.prototype.bind = function (_this) {
						// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind
						// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/apply#Description
						// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/arguments
						var originalFunction = this, slice, originalExtraArguments;
						if (arguments.length <= 1)
							return function () {
								return originalFunction.apply(_this, arguments);
							};
						slice = Array.prototype.slice;
						originalExtraArguments = slice.call(arguments, 1);
						return function () {
							return originalFunction.apply(_this, originalExtraArguments.concat(slice.call(arguments)));
						};
					};
				}

				if (!Array.prototype.fill) {
					// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/fill
					Array.prototype.fill = function (value, start, end) {
						var i, length = this.length | 0;
						start |= 0;
						end = ((end === undefined) ? length : (end | 0));
						end = ((end < 0) ? Math.max(length + end, 0) : Math.min(end, length));
						i = ((start < 0) ? Math.max(length + start, 0) : Math.min(start, length));
						while (i < end)
							this[i++] = value;
						return this;
					};
				}

				if (!String.prototype.trim) {
					String.prototype.trim = (function () {
						var expr = /^\s+|\s+$/g;
						return function () { return this.replace(expr, ""); };
					})();
				}

				if (!String.prototype.startsWith) {
					String.prototype.startsWith = function (start, position) {
						// Try to simulate the actual behavior of startsWith()
						if (this === "")
							return (start === "");
						if (!this)
							return false;
						if (start === "")
							return true;
						if (position === undefined || position < 0)
							position = 0;
						if (!start || (start.length + position) > this.length)
							return false;
						var i = this.indexOf(start, position);
						return (i);
					};
				}

				if (!String.prototype.endsWith) {
					String.prototype.endsWith = function (end, desiredLength) {
						// Try to simulate the actual behavior of endsWith()
						if (this === "")
							return (end === "");
						if (!this)
							return false;
						if (end === "")
							return true;
						if (desiredLength === undefined || desiredLength > this.length)
							desiredLength = this.length;
						if (!end || end.length > desiredLength)
							return false;
						var i = this.lastIndexOf(end, desiredLength);
						return (i >= 0 && i === (desiredLength - end.length));
					};
				}

				if (!Date.now) {
					Date.now = function () {
						return (new Date()).getTime();
					};
				}

				if (!window.performance || !window.performance.now) {
					(function () {
						var initialNow = Date.now();
						if (!window.performance)
							window.performance = {};
						window.performance.now = function () {
							return Date.now() - initialNow;
						};
					});
				}

				if (!window.requestAnimationFrame || !window.cancelAnimationFrame)
					fixRequestAnimationFrame();

				checkPromise();
			}

			checkPolyfills();
		})();

		//]]>
	</script>
</body>
</html>
